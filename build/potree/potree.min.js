function Potree(){}function LRUItem(e){this.previous=null,this.next=null,this.node=e}function LRU(){this.first=null,this.last=null,this.items={},this.elements=0,this.numPoints=0}function getMousePointCloudIntersection(e,t,o,i){var n=new THREE.Vector3(e.x,e.y,.5);n.unproject(t);for(var r=n.sub(t.position).normalize(),a=new THREE.Ray(t.position,r),s=null,l=null,d=0;d<i.length;d++){var c=i[d],u=c.pick(o,t,a);if(u){var p=t.position.distanceTo(u.position);(!s||l>p)&&(s=u,l=p)}}return s?s.position:null}function pixelsArrayToImage(e,t,o){var i=document.createElement("canvas");i.width=t,i.height=o;var n=i.getContext("2d");e=new e.constructor(e);for(var r=0;r<e.length;r++)e[4*r+3]=255;var a=n.createImageData(t,o);a.data.set(e),n.putImageData(a,0,0);var s=new Image;return s.src=i.toDataURL(),s.style.transform="scaleY(-1)",s}function projectedRadius(e,t,o,i){var n=1/Math.tan(t/2)/o;return n=n*i/2,e*n}function ProgressBar(){this._progress=0,this._message="",this.maxOpacity=.6,this.element=document.createElement("div"),this.elProgress=document.createElement("div"),this.elProgressMessage=document.createElement("div"),this.element.innerHTML="",this.element.style.position="fixed",this.element.style.bottom="40px",this.element.style.width="200px",this.element.style.marginLeft="-100px",this.element.style.left="50%",this.element.style.borderRadius="5px",this.element.style.border="1px solid #727678",this.element.style.height="16px",this.element.style.padding="1px",this.element.style.textAlign="center",this.element.style.backgroundColor="#6ba8e5",this.element.style.opacity=this.maxOpacity,this.element.style.pointerEvents="none",this.elProgress.innerHTML=" ",this.elProgress.style.backgroundColor="#b8e1fc",this.elProgress.style.position="absolute",this.elProgress.style.borderRadius="5px",this.elProgress.style.width="0%",this.elProgress.style.height="100%",this.elProgress.style.margin="0px",this.elProgress.style.padding="0px",this.elProgressMessage.style.position="absolute",this.elProgressMessage.style.width="100%",this.elProgressMessage.innerHTML="loading 1 / 10",document.body.appendChild(this.element),this.element.appendChild(this.elProgress),this.element.appendChild(this.elProgressMessage),this.hide()}Potree.version={major:1,minor:4,suffix:"RC"},console.log("Potree "+Potree.version.major+"."+Potree.version.minor+Potree.version.suffix),Potree.pointBudget=1e6,Potree.workers={},Potree.Shaders={},Potree.scriptPath=null,document.currentScript.src?Potree.scriptPath=new URL(document.currentScript.src+"/..").href:console.error("Potree was unable to find its script path using document.currentScript. Is Potree included with a script tag? Does your browser support this function?"),Potree.resourcePath=Potree.scriptPath+"/resources",Potree.updatePointClouds=function(e,t,o){Potree.lru||(Potree.lru=new LRU);for(var i=0;i<e.length;i++)for(var n=e[i],r=0;r<n.profileRequests.length;r++)n.profileRequests[r].update();for(var a=Potree.updateVisibility(e,t,o),i=0;i<e.length;i++){var n=e[i];n.updateMaterial(n.material,n.visibleNodes,t,o),n.updateVisibleBounds()}return Potree.getLRU().freeMemory(),a},Potree.getLRU=function(){return Potree.lru||(Potree.lru=new LRU),Potree.lru},Potree.updateVisibility=function(e,t,o){for(var i=0,n=0,r=[],a=[],s=[],l=[],d=[],c=new BinaryHeap(function(e){return 1/e.weight}),u=0;u<e.length;u++){var p=e[u];if(p.initialized()){p.numVisibleNodes=0,p.numVisiblePoints=0,p.visibleNodes=[],p.visibleGeometry=[],t.updateMatrixWorld();var h=new THREE.Frustum,m=t.matrixWorldInverse,f=p.matrixWorld,g=t.projectionMatrix,v=(new THREE.Matrix4).multiply(g).multiply(m).multiply(f);h.setFromMatrix(v),l.push(h);var y=t.matrixWorld,E=(new THREE.Matrix4).getInverse(f),T=(new THREE.Matrix4).multiply(E).multiply(y),b=(new THREE.Vector3).setFromMatrixPosition(T);d.push(b),p.visible&&null!==p.root&&c.push({pointcloud:u,node:p.root,weight:Number.MAX_VALUE}),p.root.isTreeNode()&&p.hideDescendants(p.root.sceneNode);for(var P=0;P<p.boundingBoxNodes.length;P++)p.boundingBoxNodes[P].visible=!1}}for(;c.size()>0;){var R=c.pop(),x=R.node,w=R.parent,p=e[R.pointcloud],C=x.getBoundingBox(),h=l[R.pointcloud],b=d[R.pointcloud],S=h.intersectsBox(C),H=S;if(H=H&&!(n+x.getNumPoints()>Potree.pointBudget)){if(i++,n+=x.getNumPoints(),p.numVisibleNodes++,p.numVisiblePoints+=x.getNumPoints(),!x.isGeometryNode()||w&&!w.isTreeNode()||(x.isLoaded()?x=p.toTreeNode(x,w):(s.push(x),a.push(x))),x.isTreeNode())if(Potree.getLRU().touch(x.geometryNode),x.sceneNode.visible=!0,x.sceneNode.material=p.material,r.push(x),p.visibleNodes.push(x),x.parent?x.sceneNode.matrixWorld.multiplyMatrices(x.parent.sceneNode.matrixWorld,x.sceneNode.matrix):x.sceneNode.matrixWorld.multiplyMatrices(p.matrixWorld,x.sceneNode.matrix),p.showBoundingBox&&!x.boundingBoxNode){var B=new THREE.BoxHelper(x.sceneNode);p.add(B),p.boundingBoxNodes.push(B),x.boundingBoxNode=B,x.boundingBoxNode.matrixWorld.copy(x.sceneNode.matrixWorld)}else p.showBoundingBox?(x.boundingBoxNode.visible=!0,x.boundingBoxNode.matrixWorld.copy(x.sceneNode.matrixWorld)):!p.showBoundingBox&&x.boundingBoxNode&&(x.boundingBoxNode.visible=!1);for(var M=x.getChildren(),u=0;u<M.length;u++){var A=M[u],I=A.getBoundingSphere(),V=I.center.distanceTo(b),L=I.radius,N=t.fov/2*Math.PI/180,D=1/Math.tan(N)*L/Math.sqrt(V*V-L*L),z=o.domElement.clientHeight*D;if(!(z<p.minimumNodePixelSize)){var G=D;0>V-L&&(G=Number.MAX_VALUE),c.push({pointcloud:R.pointcloud,node:A,parent:x,weight:G})}}}}for(var u=0;u<Math.min(5,s.length);u++)s[u].load();return{visibleNodes:r,numVisiblePoints:n}},Potree.PointCloudTreeNode=function(){this.getChildren=function(){throw"override function"},this.getBoundingBox=function(){throw"override function"},this.isLoaded=function(){throw"override function"},this.isGeometryNode=function(){throw"override function"},this.isTreeNode=function(){throw"override function"},this.getLevel=function(){throw"override function"},this.getBoundingSphere=function(){throw"override function"}},Potree.PointCloudTree=function(){THREE.Object3D.call(this),this.initialized=function(){return null!==this.root}},Potree.PointCloudTree.prototype=Object.create(THREE.Object3D.prototype),Potree.WorkerManager=function(e){this.code=e,this.instances=[],this.createdInstances=0},Potree.WorkerManager.prototype.getWorker=function(){var e=this.instances.pop();return void 0===e&&(e=Potree.utils.createWorker(this.code),this.createdInstances++),e},Potree.WorkerManager.prototype.returnWorker=function(e){this.instances.push(e)},Potree.WorkerManager.fromUrls=function(e){for(var t="",o=0;o<e.length;o++){var i=e[o],n=new XMLHttpRequest;n.open("GET",i,!1),n.responseType="text",n.overrideMimeType("text/plain; charset=x-user-defined"),n.send(null),200===n.status&&(t+=n.responseText+"\n")}return new Potree.WorkerManager(t)},Potree.workers.binaryDecoder=new Potree.WorkerManager(atob("Ci8vIGh0dHA6Ly9qc3BlcmYuY29tL3VpbnQ4YXJyYXktdnMtZGF0YXZpZXczLzMKZnVuY3Rpb24gQ3VzdG9tVmlldyhidWZmZXIpIHsKCXRoaXMuYnVmZmVyID0gYnVmZmVyOwoJdGhpcy51OCA9IG5ldyBVaW50OEFycmF5KGJ1ZmZlcik7CgkKCXZhciB0bXAgPSBuZXcgQXJyYXlCdWZmZXIoNCk7Cgl2YXIgdG1wZiA9IG5ldyBGbG9hdDMyQXJyYXkodG1wKTsKCXZhciB0bXB1OCA9IG5ldyBVaW50OEFycmF5KHRtcCk7CgkKCXRoaXMuZ2V0VWludDMyID0gZnVuY3Rpb24gKGkpIHsKCQlyZXR1cm4gKHRoaXMudThbaSszXSA8PCAyNCkgfCAodGhpcy51OFtpKzJdIDw8IDE2KSB8ICh0aGlzLnU4W2krMV0gPDwgOCkgfCB0aGlzLnU4W2ldOwoJfTsKCQoJdGhpcy5nZXRVaW50MTYgPSBmdW5jdGlvbiAoaSkgewoJCXJldHVybiAodGhpcy51OFtpKzFdIDw8IDgpIHwgdGhpcy51OFtpXTsKCX07CgkKCXRoaXMuZ2V0RmxvYXQgPSBmdW5jdGlvbihpKXsKCQl0bXB1OFswXSA9IHRoaXMudThbaSswXTsKCQl0bXB1OFsxXSA9IHRoaXMudThbaSsxXTsKCQl0bXB1OFsyXSA9IHRoaXMudThbaSsyXTsKCQl0bXB1OFszXSA9IHRoaXMudThbaSszXTsKCQkKCQlyZXR1cm4gdG1wZlswXTsKCX07CgkKCXRoaXMuZ2V0VWludDggPSBmdW5jdGlvbihpKXsKCQlyZXR1cm4gdGhpcy51OFtpXTsKCX07Cn0KClBvdHJlZSA9IHt9OwoKCm9ubWVzc2FnZSA9IGZ1bmN0aW9uKGV2ZW50KXsKCXZhciBidWZmZXIgPSBldmVudC5kYXRhLmJ1ZmZlcjsKCXZhciBwb2ludEF0dHJpYnV0ZXMgPSBldmVudC5kYXRhLnBvaW50QXR0cmlidXRlczsKCXZhciBudW1Qb2ludHMgPSBidWZmZXIuYnl0ZUxlbmd0aCAvIHBvaW50QXR0cmlidXRlcy5ieXRlU2l6ZTsKCXZhciBjdiA9IG5ldyBDdXN0b21WaWV3KGJ1ZmZlcik7Cgl2YXIgdmVyc2lvbiA9IG5ldyBQb3RyZWUuVmVyc2lvbihldmVudC5kYXRhLnZlcnNpb24pOwoJdmFyIG1pbiA9IGV2ZW50LmRhdGEubWluOwoJdmFyIG5vZGVPZmZzZXQgPSBldmVudC5kYXRhLm9mZnNldDsKCXZhciBzY2FsZSA9IGV2ZW50LmRhdGEuc2NhbGU7Cgl2YXIgdGlnaHRCb3hNaW4gPSBbIE51bWJlci5QT1NJVElWRV9JTkZJTklUWSwgTnVtYmVyLlBPU0lUSVZFX0lORklOSVRZLCBOdW1iZXIuUE9TSVRJVkVfSU5GSU5JVFldOwoJdmFyIHRpZ2h0Qm94TWF4ID0gWyBOdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFkgLCBOdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFkgLCBOdW1iZXIuTkVHQVRJVkVfSU5GSU5JVFkgXTsKCQoJdmFyIGF0dHJpYnV0ZUJ1ZmZlcnMgPSB7fTsKCQoJdmFyIG9mZnNldCA9IDA7Cglmb3IodmFyIGkgPSAwOyBpIDwgcG9pbnRBdHRyaWJ1dGVzLmF0dHJpYnV0ZXMubGVuZ3RoOyBpKyspewoJCXZhciBwb2ludEF0dHJpYnV0ZSA9IHBvaW50QXR0cmlidXRlcy5hdHRyaWJ1dGVzW2ldOwoJCgkJaWYocG9pbnRBdHRyaWJ1dGUubmFtZSA9PT0gUG90cmVlLlBvaW50QXR0cmlidXRlLlBPU0lUSU9OX0NBUlRFU0lBTi5uYW1lKXsKCQkJCgkJCXZhciBidWZmID0gbmV3IEFycmF5QnVmZmVyKG51bVBvaW50cyo0KjMpOwoJCQl2YXIgcG9zaXRpb25zID0gbmV3IEZsb2F0MzJBcnJheShidWZmKTsKCQkJCgkJCWZvcih2YXIgaiA9IDA7IGogPCBudW1Qb2ludHM7IGorKyl7CgkJCQlpZih2ZXJzaW9uLm5ld2VyVGhhbigiMS4zIikpewoJCQkJCXBvc2l0aW9uc1szKmorMF0gPSAoY3YuZ2V0VWludDMyKG9mZnNldCArIGoqcG9pbnRBdHRyaWJ1dGVzLmJ5dGVTaXplKzApICogc2NhbGUpICsgbWluWzBdOwoJCQkJCXBvc2l0aW9uc1szKmorMV0gPSAoY3YuZ2V0VWludDMyKG9mZnNldCArIGoqcG9pbnRBdHRyaWJ1dGVzLmJ5dGVTaXplKzQpICogc2NhbGUpICsgbWluWzFdOwoJCQkJCXBvc2l0aW9uc1szKmorMl0gPSAoY3YuZ2V0VWludDMyKG9mZnNldCArIGoqcG9pbnRBdHRyaWJ1dGVzLmJ5dGVTaXplKzgpICogc2NhbGUpICsgbWluWzJdOwoJCQkJfWVsc2V7CgkJCQkJcG9zaXRpb25zWzMqaiswXSA9IGN2LmdldEZsb2F0KGoqcG9pbnRBdHRyaWJ1dGVzLmJ5dGVTaXplKzApICsgbm9kZU9mZnNldFswXTsKCQkJCQlwb3NpdGlvbnNbMypqKzFdID0gY3YuZ2V0RmxvYXQoaipwb2ludEF0dHJpYnV0ZXMuYnl0ZVNpemUrNCkgKyBub2RlT2Zmc2V0WzFdOwoJCQkJCXBvc2l0aW9uc1szKmorMl0gPSBjdi5nZXRGbG9hdChqKnBvaW50QXR0cmlidXRlcy5ieXRlU2l6ZSs4KSArIG5vZGVPZmZzZXRbMl07CgkJCQl9CgkJCQkKCQkJCXRpZ2h0Qm94TWluWzBdID0gTWF0aC5taW4odGlnaHRCb3hNaW5bMF0sIHBvc2l0aW9uc1szKmorMF0pOwoJCQkJdGlnaHRCb3hNaW5bMV0gPSBNYXRoLm1pbih0aWdodEJveE1pblsxXSwgcG9zaXRpb25zWzMqaisxXSk7CgkJCQl0aWdodEJveE1pblsyXSA9IE1hdGgubWluKHRpZ2h0Qm94TWluWzJdLCBwb3NpdGlvbnNbMypqKzJdKTsKCQkJCQoJCQkJdGlnaHRCb3hNYXhbMF0gPSBNYXRoLm1heCh0aWdodEJveE1heFswXSwgcG9zaXRpb25zWzMqaiswXSk7CgkJCQl0aWdodEJveE1heFsxXSA9IE1hdGgubWF4KHRpZ2h0Qm94TWF4WzFdLCBwb3NpdGlvbnNbMypqKzFdKTsKCQkJCXRpZ2h0Qm94TWF4WzJdID0gTWF0aC5tYXgodGlnaHRCb3hNYXhbMl0sIHBvc2l0aW9uc1szKmorMl0pOwoJCQl9CgkJCQoJCQlhdHRyaWJ1dGVCdWZmZXJzW3BvaW50QXR0cmlidXRlLm5hbWVdID0geyBidWZmZXI6IGJ1ZmYsIGF0dHJpYnV0ZTogcG9pbnRBdHRyaWJ1dGV9OwoJCQkKCQl9ZWxzZSBpZihwb2ludEF0dHJpYnV0ZS5uYW1lID09PSBQb3RyZWUuUG9pbnRBdHRyaWJ1dGUuQ09MT1JfUEFDS0VELm5hbWUpewoJCQkKCQkJdmFyIGJ1ZmYgPSBuZXcgQXJyYXlCdWZmZXIobnVtUG9pbnRzKjQqMyk7CgkJCXZhciBjb2xvcnMgPSBuZXcgRmxvYXQzMkFycmF5KGJ1ZmYpOwoJCQkKCQkJZm9yKHZhciBqID0gMDsgaiA8IG51bVBvaW50czsgaisrKXsKCQkJCWNvbG9yc1szKmorMF0gPSBjdi5nZXRVaW50OChvZmZzZXQgKyBqKnBvaW50QXR0cmlidXRlcy5ieXRlU2l6ZSArIDApIC8gMjU1OwoJCQkJY29sb3JzWzMqaisxXSA9IGN2LmdldFVpbnQ4KG9mZnNldCArIGoqcG9pbnRBdHRyaWJ1dGVzLmJ5dGVTaXplICsgMSkgLyAyNTU7CgkJCQljb2xvcnNbMypqKzJdID0gY3YuZ2V0VWludDgob2Zmc2V0ICsgaipwb2ludEF0dHJpYnV0ZXMuYnl0ZVNpemUgKyAyKSAvIDI1NTsKCQkJfQoJCQkKCQkJYXR0cmlidXRlQnVmZmVyc1twb2ludEF0dHJpYnV0ZS5uYW1lXSA9IHsgYnVmZmVyOiBidWZmLCBhdHRyaWJ1dGU6IHBvaW50QXR0cmlidXRlfTsKCQkJCgkJfWVsc2UgaWYocG9pbnRBdHRyaWJ1dGUubmFtZSA9PT0gUG90cmVlLlBvaW50QXR0cmlidXRlLklOVEVOU0lUWS5uYW1lKXsKCgkJCXZhciBidWZmID0gbmV3IEFycmF5QnVmZmVyKG51bVBvaW50cyo0KTsKCQkJdmFyIGludGVuc2l0aWVzID0gbmV3IEZsb2F0MzJBcnJheShidWZmKTsKCQkJCgkJCWZvcih2YXIgaiA9IDA7IGogPCBudW1Qb2ludHM7IGorKyl7CgkJCQl2YXIgaW50ZW5zaXR5ID0gY3YuZ2V0VWludDE2KG9mZnNldCArIGoqcG9pbnRBdHRyaWJ1dGVzLmJ5dGVTaXplKTsKCQkJCWludGVuc2l0aWVzW2pdID0gaW50ZW5zaXR5OwoJCQl9CgkJCQoJCQlhdHRyaWJ1dGVCdWZmZXJzW3BvaW50QXR0cmlidXRlLm5hbWVdID0geyBidWZmZXI6IGJ1ZmYsIGF0dHJpYnV0ZTogcG9pbnRBdHRyaWJ1dGV9OwoJCQoJCX1lbHNlIGlmKHBvaW50QXR0cmlidXRlLm5hbWUgPT09IFBvdHJlZS5Qb2ludEF0dHJpYnV0ZS5DTEFTU0lGSUNBVElPTi5uYW1lKXsKCgkJCXZhciBidWZmID0gbmV3IEFycmF5QnVmZmVyKG51bVBvaW50cyo0KTsKCQkJdmFyIGNsYXNzaWZpY2F0aW9ucyA9IG5ldyBGbG9hdDMyQXJyYXkoYnVmZik7CgkJCQoJCQlmb3IodmFyIGogPSAwOyBqIDwgbnVtUG9pbnRzOyBqKyspewoJCQkJdmFyIGNsYXNzaWZpY2F0aW9uID0gY3YuZ2V0VWludDgob2Zmc2V0ICsgaipwb2ludEF0dHJpYnV0ZXMuYnl0ZVNpemUpOwoJCQkJY2xhc3NpZmljYXRpb25zW2pdID0gY2xhc3NpZmljYXRpb247CgkJCX0KCQkJCgkJCWF0dHJpYnV0ZUJ1ZmZlcnNbcG9pbnRBdHRyaWJ1dGUubmFtZV0gPSB7IGJ1ZmZlcjogYnVmZiwgYXR0cmlidXRlOiBwb2ludEF0dHJpYnV0ZX07CgkJCgkJfWVsc2UgaWYocG9pbnRBdHRyaWJ1dGUubmFtZSA9PT0gUG90cmVlLlBvaW50QXR0cmlidXRlLk5PUk1BTF9TUEhFUkVNQVBQRUQubmFtZSl7CgoJCQl2YXIgYnVmZiA9IG5ldyBBcnJheUJ1ZmZlcihudW1Qb2ludHMqNCozKTsKCQkJdmFyIG5vcm1hbHMgPSBuZXcgRmxvYXQzMkFycmF5KGJ1ZmYpOwoJCQkKCQkJZm9yKHZhciBqID0gMDsgaiA8IG51bVBvaW50czsgaisrKXsKCQkJCXZhciBieCA9IGN2LmdldFVpbnQ4KG9mZnNldCArIGogKiBwb2ludEF0dHJpYnV0ZXMuYnl0ZVNpemUgKyAwKTsKCQkJCXZhciBieSA9IGN2LmdldFVpbnQ4KG9mZnNldCArIGogKiBwb2ludEF0dHJpYnV0ZXMuYnl0ZVNpemUgKyAxKTsKCQkJCgkJCQl2YXIgZXggPSBieCAvIDI1NTsKCQkJCXZhciBleSA9IGJ5IC8gMjU1OwoJCQkJCgkJCQl2YXIgbnggPSBleCAqIDIgLSAxOwoJCQkJdmFyIG55ID0gZXkgKiAyIC0gMTsKCQkJCXZhciBueiA9IDE7CgkJCQl2YXIgbncgPSAtMTsKCQkJCQoJCQkJdmFyIGwgPSAobnggKiAoLW54KSkgKyAobnkgKiAoLW55KSkgKyAobnogKiAoLW53KSk7CgkJCQlueiA9IGw7CgkJCQlueCA9IG54ICogTWF0aC5zcXJ0KGwpOwoJCQkJbnkgPSBueSAqIE1hdGguc3FydChsKTsKCQkJCQoJCQkJbnggPSBueCAqIDI7CgkJCQlueSA9IG55ICogMjsKCQkJCW56ID0gbnogKiAyIC0gMTsKCQkJCQoJCQkJbm9ybWFsc1szKmogKyAwXSA9IG54OwoJCQkJbm9ybWFsc1szKmogKyAxXSA9IG55OwoJCQkJbm9ybWFsc1szKmogKyAyXSA9IG56OwoJCQl9CgkJCQoJCQlhdHRyaWJ1dGVCdWZmZXJzW3BvaW50QXR0cmlidXRlLm5hbWVdID0geyBidWZmZXI6IGJ1ZmYsIGF0dHJpYnV0ZTogcG9pbnRBdHRyaWJ1dGV9OwoJCX1lbHNlIGlmKHBvaW50QXR0cmlidXRlLm5hbWUgPT09IFBvdHJlZS5Qb2ludEF0dHJpYnV0ZS5OT1JNQUxfT0NUMTYubmFtZSl7CgkJCQoJCQl2YXIgYnVmZiA9IG5ldyBBcnJheUJ1ZmZlcihudW1Qb2ludHMqNCozKTsKCQkJdmFyIG5vcm1hbHMgPSBuZXcgRmxvYXQzMkFycmF5KGJ1ZmYpOwoJCQlmb3IodmFyIGogPSAwOyBqIDwgbnVtUG9pbnRzOyBqKyspewoJCQkJdmFyIGJ4ID0gY3YuZ2V0VWludDgob2Zmc2V0ICsgaiAqIHBvaW50QXR0cmlidXRlcy5ieXRlU2l6ZSArIDApOwoJCQkJdmFyIGJ5ID0gY3YuZ2V0VWludDgob2Zmc2V0ICsgaiAqIHBvaW50QXR0cmlidXRlcy5ieXRlU2l6ZSArIDEpOwoJCQkJCgkJCQl2YXIgdSA9IChieCAvIDI1NSkgKiAyIC0gMTsKCQkJCXZhciB2ID0gKGJ5IC8gMjU1KSAqIDIgLSAxOwoJCQkJCgkJCQl2YXIgeiA9IDEgLSBNYXRoLmFicyh1KSAtIE1hdGguYWJzKHYpOwoJCQkJCgkJCQl2YXIgeCA9IDA7CgkJCQl2YXIgeSA9IDA7CgkJCQlpZih6ID49IDApewoJCQkJCXggPSB1OwoJCQkJCXkgPSB2OwoJCQkJfWVsc2V7CgkJCQkJeCA9IC0gKHYvTWF0aC5zaWduKHYpIC0gMSkgLyBNYXRoLnNpZ24odSk7CgkJCQkJeSA9IC0gKHUvTWF0aC5zaWduKHUpIC0gMSkgLyBNYXRoLnNpZ24odik7CgkJCQl9CgkJCQkKCQkJCXZhciBsZW5ndGggPSBNYXRoLnNxcnQoeCp4ICsgeSp5ICsgeip6KTsKCQkJCXggPSB4IC8gbGVuZ3RoOwoJCQkJeSA9IHkgLyBsZW5ndGg7CgkJCQl6ID0geiAvIGxlbmd0aDsKCQkJCQoJCQkJbm9ybWFsc1szKmogKyAwXSA9IHg7CgkJCQlub3JtYWxzWzMqaiArIDFdID0geTsKCQkJCW5vcm1hbHNbMypqICsgMl0gPSB6OwoJCQl9CgkJCWF0dHJpYnV0ZUJ1ZmZlcnNbcG9pbnRBdHRyaWJ1dGUubmFtZV0gPSB7IGJ1ZmZlcjogYnVmZiwgYXR0cmlidXRlOiBwb2ludEF0dHJpYnV0ZX07CgkJfWVsc2UgaWYocG9pbnRBdHRyaWJ1dGUubmFtZSA9PT0gUG90cmVlLlBvaW50QXR0cmlidXRlLk5PUk1BTC5uYW1lKXsKCQkKCQkJdmFyIGJ1ZmYgPSBuZXcgQXJyYXlCdWZmZXIobnVtUG9pbnRzKjQqMyk7CgkJCXZhciBub3JtYWxzID0gbmV3IEZsb2F0MzJBcnJheShidWZmKTsKCQkJZm9yKHZhciBqID0gMDsgaiA8IG51bVBvaW50czsgaisrKXsKCQkJCXZhciB4ID0gY3YuZ2V0RmxvYXQob2Zmc2V0ICsgaiAqIHBvaW50QXR0cmlidXRlcy5ieXRlU2l6ZSArIDApOwoJCQkJdmFyIHkgPSBjdi5nZXRGbG9hdChvZmZzZXQgKyBqICogcG9pbnRBdHRyaWJ1dGVzLmJ5dGVTaXplICsgNCk7CgkJCQl2YXIgeiA9IGN2LmdldEZsb2F0KG9mZnNldCArIGogKiBwb2ludEF0dHJpYnV0ZXMuYnl0ZVNpemUgKyA4KTsKCQkJCQoJCQkJbm9ybWFsc1szKmogKyAwXSA9IHg7CgkJCQlub3JtYWxzWzMqaiArIDFdID0geTsKCQkJCW5vcm1hbHNbMypqICsgMl0gPSB6OwoJCQl9CgkJCWF0dHJpYnV0ZUJ1ZmZlcnNbcG9pbnRBdHRyaWJ1dGUubmFtZV0gPSB7IGJ1ZmZlcjogYnVmZiwgYXR0cmlidXRlOiBwb2ludEF0dHJpYnV0ZX07CgkJfQoJCQoJCW9mZnNldCArPSBwb2ludEF0dHJpYnV0ZS5ieXRlU2l6ZTsKCX0KCQoJdmFyIGluZGljZXMgPSBuZXcgQXJyYXlCdWZmZXIobnVtUG9pbnRzKjQpOwoJdmFyIGlJbmRpY2VzID0gbmV3IFVpbnQzMkFycmF5KGluZGljZXMpOwoJZm9yKHZhciBpID0gMDsgaSA8IG51bVBvaW50czsgaSsrKXsKCQlpSW5kaWNlc1tpXSA9IGk7Cgl9CgkKCXZhciBtZXNzYWdlID0gewoJCWF0dHJpYnV0ZUJ1ZmZlcnM6IGF0dHJpYnV0ZUJ1ZmZlcnMsCgkJdGlnaHRCb3VuZGluZ0JveDogeyBtaW46IHRpZ2h0Qm94TWluLCBtYXg6IHRpZ2h0Qm94TWF4IH0sCgkJaW5kaWNlczogaW5kaWNlcwoJfTsKCQkKCXZhciB0cmFuc2ZlcmFibGVzID0gW107CgkKCWZvcih2YXIgcHJvcGVydHkgaW4gbWVzc2FnZS5hdHRyaWJ1dGVCdWZmZXJzKXsKCQlpZihtZXNzYWdlLmF0dHJpYnV0ZUJ1ZmZlcnMuaGFzT3duUHJvcGVydHkocHJvcGVydHkpKXsKCQkJdHJhbnNmZXJhYmxlcy5wdXNoKG1lc3NhZ2UuYXR0cmlidXRlQnVmZmVyc1twcm9wZXJ0eV0uYnVmZmVyKTsKCQl9Cgl9CgkKCXRyYW5zZmVyYWJsZXMucHVzaChtZXNzYWdlLmluZGljZXMpOwoJCQoJcG9zdE1lc3NhZ2UobWVzc2FnZSwgdHJhbnNmZXJhYmxlcyk7CgkKfTsKUG90cmVlLlZlcnNpb24gPSBmdW5jdGlvbih2ZXJzaW9uKXsKCXRoaXMudmVyc2lvbiA9IHZlcnNpb247Cgl2YXIgdm1MZW5ndGggPSAodmVyc2lvbi5pbmRleE9mKCIuIikgPT09IC0xKSA/IHZlcnNpb24ubGVuZ3RoIDogdmVyc2lvbi5pbmRleE9mKCIuIik7Cgl0aGlzLnZlcnNpb25NYWpvciA9IHBhcnNlSW50KHZlcnNpb24uc3Vic3RyKDAsIHZtTGVuZ3RoKSk7Cgl0aGlzLnZlcnNpb25NaW5vciA9IHBhcnNlSW50KHZlcnNpb24uc3Vic3RyKHZtTGVuZ3RoICsgMSkpOwoJaWYodGhpcy52ZXJzaW9uTWlub3IubGVuZ3RoID09PSAwKXsKCQl0aGlzLnZlcnNpb25NaW5vciA9IDA7Cgl9CgkKfTsKClBvdHJlZS5WZXJzaW9uLnByb3RvdHlwZS5uZXdlclRoYW4gPSBmdW5jdGlvbih2ZXJzaW9uKXsKCXZhciB2ID0gbmV3IFBvdHJlZS5WZXJzaW9uKHZlcnNpb24pOwoJCglpZiggdGhpcy52ZXJzaW9uTWFqb3IgPiB2LnZlcnNpb25NYWpvcil7CgkJcmV0dXJuIHRydWU7Cgl9ZWxzZSBpZiggdGhpcy52ZXJzaW9uTWFqb3IgPT09IHYudmVyc2lvbk1ham9yICYmIHRoaXMudmVyc2lvbk1pbm9yID4gdi52ZXJzaW9uTWlub3IpewoJCXJldHVybiB0cnVlOwoJfWVsc2V7CgkJcmV0dXJuIGZhbHNlOwoJfQp9OwoKUG90cmVlLlZlcnNpb24ucHJvdG90eXBlLmVxdWFsT3JIaWdoZXIgPSBmdW5jdGlvbih2ZXJzaW9uKXsKCXZhciB2ID0gbmV3IFBvdHJlZS5WZXJzaW9uKHZlcnNpb24pOwoJCglpZiggdGhpcy52ZXJzaW9uTWFqb3IgPiB2LnZlcnNpb25NYWpvcil7CgkJcmV0dXJuIHRydWU7Cgl9ZWxzZSBpZiggdGhpcy52ZXJzaW9uTWFqb3IgPT09IHYudmVyc2lvbk1ham9yICYmIHRoaXMudmVyc2lvbk1pbm9yID49IHYudmVyc2lvbk1pbm9yKXsKCQlyZXR1cm4gdHJ1ZTsKCX1lbHNlewoJCXJldHVybiBmYWxzZTsKCX0KfTsKClBvdHJlZS5WZXJzaW9uLnByb3RvdHlwZS51cFRvID0gZnVuY3Rpb24odmVyc2lvbil7CglyZXR1cm4gIXRoaXMubmV3ZXJUaGFuKHZlcnNpb24pOwp9OwpQb3RyZWUuUG9pbnRBdHRyaWJ1dGVOYW1lcyA9IHt9OwoKUG90cmVlLlBvaW50QXR0cmlidXRlTmFtZXMuUE9TSVRJT05fQ0FSVEVTSUFOIAk9IDA7CS8vIGZsb2F0IHgsIHksIHo7ClBvdHJlZS5Qb2ludEF0dHJpYnV0ZU5hbWVzLkNPTE9SX1BBQ0tFRAkJPSAxOwkvLyBieXRlIHIsIGcsIGIsIGE7IAlJID0gWzAsMV0KUG90cmVlLlBvaW50QXR0cmlidXRlTmFtZXMuQ09MT1JfRkxPQVRTXzEJCT0gMjsJLy8gZmxvYXQgciwgZywgYjsgCQlJID0gWzAsMV0KUG90cmVlLlBvaW50QXR0cmlidXRlTmFtZXMuQ09MT1JfRkxPQVRTXzI1NQk9IDM7CS8vIGZsb2F0IHIsIGcsIGI7IAkJSSA9IFswLDI1NV0KUG90cmVlLlBvaW50QXR0cmlidXRlTmFtZXMuTk9STUFMX0ZMT0FUUwkJPSA0OyAgCS8vIGZsb2F0IHgsIHksIHo7ClBvdHJlZS5Qb2ludEF0dHJpYnV0ZU5hbWVzLkZJTExFUgkJCQk9IDU7ClBvdHJlZS5Qb2ludEF0dHJpYnV0ZU5hbWVzLklOVEVOU0lUWQkJCT0gNjsKUG90cmVlLlBvaW50QXR0cmlidXRlTmFtZXMuQ0xBU1NJRklDQVRJT04JCT0gNzsKUG90cmVlLlBvaW50QXR0cmlidXRlTmFtZXMuTk9STUFMX1NQSEVSRU1BUFBFRAk9IDg7ClBvdHJlZS5Qb2ludEF0dHJpYnV0ZU5hbWVzLk5PUk1BTF9PQ1QxNgkJPSA5OwpQb3RyZWUuUG9pbnRBdHRyaWJ1dGVOYW1lcy5OT1JNQUwJCQkJPSAxMDsKCi8qKgogKiBTb21lIHR5cGVzIG9mIHBvc3NpYmxlIHBvaW50IGF0dHJpYnV0ZSBkYXRhIGZvcm1hdHMKICogCiAqIEBjbGFzcwogKi8KUG90cmVlLlBvaW50QXR0cmlidXRlVHlwZXMgPSB7CglEQVRBX1RZUEVfRE9VQkxFCToge29yZGluYWwgOiAwLCBzaXplOiA4fSwKCURBVEFfVFlQRV9GTE9BVAkJOiB7b3JkaW5hbCA6IDEsIHNpemU6IDR9LAoJREFUQV9UWVBFX0lOVDgJCToge29yZGluYWwgOiAyLCBzaXplOiAxfSwKCURBVEFfVFlQRV9VSU5UOAkJOiB7b3JkaW5hbCA6IDMsIHNpemU6IDF9LAoJREFUQV9UWVBFX0lOVDE2CQk6IHtvcmRpbmFsIDogNCwgc2l6ZTogMn0sCglEQVRBX1RZUEVfVUlOVDE2CToge29yZGluYWwgOiA1LCBzaXplOiAyfSwKCURBVEFfVFlQRV9JTlQzMgkJOiB7b3JkaW5hbCA6IDYsIHNpemU6IDR9LAoJREFUQV9UWVBFX1VJTlQzMgk6IHtvcmRpbmFsIDogNywgc2l6ZTogNH0sCglEQVRBX1RZUEVfSU5UNjQJCToge29yZGluYWwgOiA4LCBzaXplOiA4fSwKCURBVEFfVFlQRV9VSU5UNjQJOiB7b3JkaW5hbCA6IDksIHNpemU6IDh9Cn07Cgp2YXIgaSA9IDA7CmZvcih2YXIgb2JqIGluIFBvdHJlZS5Qb2ludEF0dHJpYnV0ZVR5cGVzKXsKCVBvdHJlZS5Qb2ludEF0dHJpYnV0ZVR5cGVzW2ldID0gUG90cmVlLlBvaW50QXR0cmlidXRlVHlwZXNbb2JqXTsKCWkrKzsKfQoKLyoqCiAqIEEgc2luZ2xlIHBvaW50IGF0dHJpYnV0ZSBzdWNoIGFzIGNvbG9yL25vcm1hbC8uLiBhbmQgaXRzIGRhdGEgZm9ybWF0L251bWJlciBvZiBlbGVtZW50cy8uLi4gCiAqIAogKiBAY2xhc3MKICogQHBhcmFtIG5hbWUgCiAqIEBwYXJhbSB0eXBlCiAqIEBwYXJhbSBzaXplCiAqIEByZXR1cm5zCiAqLwpQb3RyZWUuUG9pbnRBdHRyaWJ1dGUgPSBmdW5jdGlvbihuYW1lLCB0eXBlLCBudW1FbGVtZW50cyl7Cgl0aGlzLm5hbWUgPSBuYW1lOwoJdGhpcy50eXBlID0gdHlwZTsgCgl0aGlzLm51bUVsZW1lbnRzID0gbnVtRWxlbWVudHM7Cgl0aGlzLmJ5dGVTaXplID0gdGhpcy5udW1FbGVtZW50cyAqIHRoaXMudHlwZS5zaXplOwp9OwoKUG90cmVlLlBvaW50QXR0cmlidXRlLlBPU0lUSU9OX0NBUlRFU0lBTiA9IG5ldyBQb3RyZWUuUG9pbnRBdHRyaWJ1dGUoCgkJUG90cmVlLlBvaW50QXR0cmlidXRlTmFtZXMuUE9TSVRJT05fQ0FSVEVTSUFOLAoJCVBvdHJlZS5Qb2ludEF0dHJpYnV0ZVR5cGVzLkRBVEFfVFlQRV9GTE9BVCwgMyk7CgpQb3RyZWUuUG9pbnRBdHRyaWJ1dGUuUkdCQV9QQUNLRUQgPSBuZXcgUG90cmVlLlBvaW50QXR0cmlidXRlKAoJCVBvdHJlZS5Qb2ludEF0dHJpYnV0ZU5hbWVzLkNPTE9SX1BBQ0tFRCwKCQlQb3RyZWUuUG9pbnRBdHRyaWJ1dGVUeXBlcy5EQVRBX1RZUEVfSU5UOCwgNCk7CgpQb3RyZWUuUG9pbnRBdHRyaWJ1dGUuQ09MT1JfUEFDS0VEID0gUG90cmVlLlBvaW50QXR0cmlidXRlLlJHQkFfUEFDS0VEOwoKUG90cmVlLlBvaW50QXR0cmlidXRlLlJHQl9QQUNLRUQgPSBuZXcgUG90cmVlLlBvaW50QXR0cmlidXRlKAoJCVBvdHJlZS5Qb2ludEF0dHJpYnV0ZU5hbWVzLkNPTE9SX1BBQ0tFRCwKCQlQb3RyZWUuUG9pbnRBdHRyaWJ1dGVUeXBlcy5EQVRBX1RZUEVfSU5UOCwgMyk7CgpQb3RyZWUuUG9pbnRBdHRyaWJ1dGUuTk9STUFMX0ZMT0FUUyA9IG5ldyBQb3RyZWUuUG9pbnRBdHRyaWJ1dGUoCgkJUG90cmVlLlBvaW50QXR0cmlidXRlTmFtZXMuTk9STUFMX0ZMT0FUUywKCQlQb3RyZWUuUG9pbnRBdHRyaWJ1dGVUeXBlcy5EQVRBX1RZUEVfRkxPQVQsIDMpOwoKUG90cmVlLlBvaW50QXR0cmlidXRlLkZJTExFUl8xQiA9IG5ldyBQb3RyZWUuUG9pbnRBdHRyaWJ1dGUoCgkJUG90cmVlLlBvaW50QXR0cmlidXRlTmFtZXMuRklMTEVSLAoJCVBvdHJlZS5Qb2ludEF0dHJpYnV0ZVR5cGVzLkRBVEFfVFlQRV9VSU5UOCwgMSk7CgkJClBvdHJlZS5Qb2ludEF0dHJpYnV0ZS5JTlRFTlNJVFkgPSBuZXcgUG90cmVlLlBvaW50QXR0cmlidXRlKAoJCVBvdHJlZS5Qb2ludEF0dHJpYnV0ZU5hbWVzLklOVEVOU0lUWSwKCQlQb3RyZWUuUG9pbnRBdHRyaWJ1dGVUeXBlcy5EQVRBX1RZUEVfVUlOVDE2LCAxKTsJCQoJCQpQb3RyZWUuUG9pbnRBdHRyaWJ1dGUuQ0xBU1NJRklDQVRJT04gPSBuZXcgUG90cmVlLlBvaW50QXR0cmlidXRlKAoJCVBvdHJlZS5Qb2ludEF0dHJpYnV0ZU5hbWVzLkNMQVNTSUZJQ0FUSU9OLAoJCVBvdHJlZS5Qb2ludEF0dHJpYnV0ZVR5cGVzLkRBVEFfVFlQRV9VSU5UOCwgMSk7CQoJCQpQb3RyZWUuUG9pbnRBdHRyaWJ1dGUuTk9STUFMX1NQSEVSRU1BUFBFRCA9IG5ldyBQb3RyZWUuUG9pbnRBdHRyaWJ1dGUoCgkJUG90cmVlLlBvaW50QXR0cmlidXRlTmFtZXMuTk9STUFMX1NQSEVSRU1BUFBFRCwKCQlQb3RyZWUuUG9pbnRBdHRyaWJ1dGVUeXBlcy5EQVRBX1RZUEVfVUlOVDgsIDIpOwkJCgkJClBvdHJlZS5Qb2ludEF0dHJpYnV0ZS5OT1JNQUxfT0NUMTYgPSBuZXcgUG90cmVlLlBvaW50QXR0cmlidXRlKAoJCVBvdHJlZS5Qb2ludEF0dHJpYnV0ZU5hbWVzLk5PUk1BTF9PQ1QxNiwKCQlQb3RyZWUuUG9pbnRBdHRyaWJ1dGVUeXBlcy5EQVRBX1RZUEVfVUlOVDgsIDIpOwkKCQkKUG90cmVlLlBvaW50QXR0cmlidXRlLk5PUk1BTCA9IG5ldyBQb3RyZWUuUG9pbnRBdHRyaWJ1dGUoCgkJUG90cmVlLlBvaW50QXR0cmlidXRlTmFtZXMuTk9STUFMLAoJCVBvdHJlZS5Qb2ludEF0dHJpYnV0ZVR5cGVzLkRBVEFfVFlQRV9GTE9BVCwgMyk7CgovKioKICogT3JkZXJlZCBsaXN0IG9mIFBvaW50QXR0cmlidXRlcyB1c2VkIHRvIGlkZW50aWZ5IGhvdyBwb2ludHMgYXJlIGFsaWduZWQgaW4gYSBidWZmZXIuCiAqIAogKiBAY2xhc3MKICogCiAqLwpQb3RyZWUuUG9pbnRBdHRyaWJ1dGVzID0gZnVuY3Rpb24ocG9pbnRBdHRyaWJ1dGVzKXsKCXRoaXMuYXR0cmlidXRlcyA9IFtdOwoJdGhpcy5ieXRlU2l6ZSA9IDA7Cgl0aGlzLnNpemUgPSAwOwoJCglpZihwb2ludEF0dHJpYnV0ZXMgIT0gbnVsbCl7CQoJCWZvcih2YXIgaSA9IDA7IGkgPCBwb2ludEF0dHJpYnV0ZXMubGVuZ3RoOyBpKyspewoJCQl2YXIgcG9pbnRBdHRyaWJ1dGVOYW1lID0gcG9pbnRBdHRyaWJ1dGVzW2ldOwoJCQl2YXIgcG9pbnRBdHRyaWJ1dGUgPSBQb3RyZWUuUG9pbnRBdHRyaWJ1dGVbcG9pbnRBdHRyaWJ1dGVOYW1lXTsKCQkJdGhpcy5hdHRyaWJ1dGVzLnB1c2gocG9pbnRBdHRyaWJ1dGUpOwoJCQl0aGlzLmJ5dGVTaXplICs9IHBvaW50QXR0cmlidXRlLmJ5dGVTaXplOwoJCQl0aGlzLnNpemUrKzsKCQl9Cgl9Cn07CgpQb3RyZWUuUG9pbnRBdHRyaWJ1dGVzLnByb3RvdHlwZS5hZGQgPSBmdW5jdGlvbihwb2ludEF0dHJpYnV0ZSl7Cgl0aGlzLmF0dHJpYnV0ZXMucHVzaChwb2ludEF0dHJpYnV0ZSk7Cgl0aGlzLmJ5dGVTaXplICs9IHBvaW50QXR0cmlidXRlLmJ5dGVTaXplOwoJdGhpcy5zaXplKys7Cn07CgpQb3RyZWUuUG9pbnRBdHRyaWJ1dGVzLnByb3RvdHlwZS5oYXNDb2xvcnMgPSBmdW5jdGlvbigpewoJZm9yKHZhciBuYW1lIGluIHRoaXMuYXR0cmlidXRlcyl7CgkJdmFyIHBvaW50QXR0cmlidXRlID0gdGhpcy5hdHRyaWJ1dGVzW25hbWVdOwoJCWlmKHBvaW50QXR0cmlidXRlLm5hbWUgPT09IFBvdHJlZS5Qb2ludEF0dHJpYnV0ZU5hbWVzLkNPTE9SX1BBQ0tFRCl7CgkJCXJldHVybiB0cnVlOwoJCX0KCX0KCQoJcmV0dXJuIGZhbHNlOwp9OwoKUG90cmVlLlBvaW50QXR0cmlidXRlcy5wcm90b3R5cGUuaGFzTm9ybWFscyA9IGZ1bmN0aW9uKCl7Cglmb3IodmFyIG5hbWUgaW4gdGhpcy5hdHRyaWJ1dGVzKXsKCQl2YXIgcG9pbnRBdHRyaWJ1dGUgPSB0aGlzLmF0dHJpYnV0ZXNbbmFtZV07CgkJaWYoCgkJCXBvaW50QXR0cmlidXRlID09PSBQb3RyZWUuUG9pbnRBdHRyaWJ1dGUuTk9STUFMX1NQSEVSRU1BUFBFRCB8fCAKCQkJcG9pbnRBdHRyaWJ1dGUgPT09IFBvdHJlZS5Qb2ludEF0dHJpYnV0ZS5OT1JNQUxfRkxPQVRTIHx8CgkJCXBvaW50QXR0cmlidXRlID09PSBQb3RyZWUuUG9pbnRBdHRyaWJ1dGUuTk9STUFMIHx8CgkJCXBvaW50QXR0cmlidXRlID09PSBQb3RyZWUuUG9pbnRBdHRyaWJ1dGUuTk9STUFMX09DVDE2KXsKCQkJcmV0dXJuIHRydWU7CgkJfQoJfQoJCglyZXR1cm4gZmFsc2U7Cn07CgoK")),Potree.Shaders["pointcloud.vs"]=["","// the following is an incomplete list of attributes, uniforms and defines","// which are automatically added through the THREE.ShaderMaterial","","//attribute vec3 position;","//attribute vec3 color;","//attribute vec3 normal;","","//uniform mat4 modelMatrix;","//uniform mat4 modelViewMatrix;","//uniform mat4 projectionMatrix;","//uniform mat4 viewMatrix;","//uniform mat3 normalMatrix;","//uniform vec3 cameraPosition;","","//#define MAX_DIR_LIGHTS 0","//#define MAX_POINT_LIGHTS 1","//#define MAX_SPOT_LIGHTS 0","//#define MAX_HEMI_LIGHTS 0","//#define MAX_SHADOWS 0","//#define MAX_BONES 58","","#define max_clip_boxes 30","","attribute float intensity;","attribute float classification;","attribute float returnNumber;","attribute float numberOfReturns;","attribute float pointSourceID;","attribute vec4 indices;","","uniform float screenWidth;","uniform float screenHeight;","uniform float fov;","uniform float spacing;","uniform float near;","uniform float far;","","#if defined use_clip_box","	uniform mat4 clipBoxes[max_clip_boxes];","	uniform vec3 clipBoxPositions[max_clip_boxes];","#endif","","","uniform float heightMin;","uniform float heightMax;","uniform float intensityMin;","uniform float intensityMax;","uniform float size;				// pixel size factor","uniform float minSize;			// minimum pixel size","uniform float maxSize;			// maximum pixel size","uniform float octreeSize;","uniform vec3 bbSize;","uniform vec3 uColor;","uniform float opacity;","uniform float clipBoxCount;","","","uniform sampler2D visibleNodes;","uniform sampler2D gradient;","uniform sampler2D classificationLUT;","uniform sampler2D depthMap;","","varying float	vOpacity;","varying vec3	vColor;","varying float	vLinearDepth;","varying float	vLogDepth;","varying vec3	vViewPosition;","varying float 	vRadius;","varying vec3	vWorldPosition;","varying vec3	vNormal;","","","// ---------------------","// OCTREE","// ---------------------","","#if (defined(adaptive_point_size) || defined(color_type_lod)) && defined(tree_type_octree)","/**"," * number of 1-bits up to inclusive index position"," * number is treated as if it were an integer in the range 0-255"," *"," */","float numberOfOnes(float number, float index){","	float tmp = mod(number, pow(2.0, index + 1.0));","	float numOnes = 0.0;","	for(float i = 0.0; i < 8.0; i++){","		if(mod(tmp, 2.0) != 0.0){","			numOnes++;","		}","		tmp = floor(tmp / 2.0);","	}","	return numOnes;","}","","","/**"," * checks whether the bit at index is 1"," * number is treated as if it were an integer in the range 0-255"," *"," */","bool isBitSet(float number, float index){","	return mod(floor(number / pow(2.0, index)), 2.0) != 0.0;","}","","","/**"," * find the LOD at the point position"," */","float getLOD(){","	vec3 offset = vec3(0.0, 0.0, 0.0);","	float iOffset = 0.0;","	float depth = 0.0;","	for(float i = 0.0; i <= 1000.0; i++){","		float nodeSizeAtLevel = octreeSize  / pow(2.0, i);","		vec3 index3d = (position - offset) / nodeSizeAtLevel;","		index3d = floor(index3d + 0.5);","		float index = 4.0*index3d.x + 2.0*index3d.y + index3d.z;","		","		vec4 value = texture2D(visibleNodes, vec2(iOffset / 2048.0, 0.0));","		float mask = value.r * 255.0;","		if(isBitSet(mask, index)){","			// there are more visible child nodes at this position","			iOffset = iOffset + value.g * 255.0 + numberOfOnes(mask, index - 1.0);","			depth++;","		}else{","			// no more visible child nodes at this position","			return depth;","		}","		offset = offset + (vec3(1.0, 1.0, 1.0) * nodeSizeAtLevel * 0.5) * index3d;","	}","		","	return depth;","}","","float getPointSizeAttenuation(){","	return pow(1.9, getLOD());","}","","","#endif","","","// ---------------------","// KD-TREE","// ---------------------","","#if (defined(adaptive_point_size) || defined(color_type_lod)) && defined(tree_type_kdtree)","","float getLOD(){","	vec3 offset = vec3(0.0, 0.0, 0.0);","	float iOffset = 0.0;","	float depth = 0.0;","		","		","	vec3 size = bbSize;	","	vec3 pos = position;","		","	for(float i = 0.0; i <= 1000.0; i++){","		","		vec4 value = texture2D(visibleNodes, vec2(iOffset / 2048.0, 0.0));","		","		int children = int(value.r * 255.0);","		float next = value.g * 255.0;","		int split = int(value.b * 255.0);","		","		if(next == 0.0){","		 	return depth;","		}","		","		vec3 splitv = vec3(0.0, 0.0, 0.0);","		if(split == 1){","			splitv.x = 1.0;","		}else if(split == 2){","		 	splitv.y = 1.0;","		}else if(split == 4){","		 	splitv.z = 1.0;","		}","		","		iOffset = iOffset + next;","		","		float factor = length(pos * splitv / size);","		if(factor < 0.5){","		 	// left","		    if(children == 0 || children == 2){","		    	return depth;","		    }","		}else{","		  	// right","		    pos = pos - size * splitv * 0.5;","		    if(children == 0 || children == 1){","		    	return depth;","		    }","		    if(children == 3){","		    	iOffset = iOffset + 1.0;","		    }","		}","		size = size * ((1.0 - (splitv + 1.0) / 2.0) + 0.5);","		","		depth++;","	}","		","		","	return depth;	","}","","float getPointSizeAttenuation(){","	return pow(1.3, getLOD());","}","","#endif","","void main() {","	vec4 worldPosition = modelMatrix * vec4( position, 1.0 );","	vec4 mvPosition = modelViewMatrix * vec4( position, 1.0 );","	vViewPosition = -mvPosition.xyz;","	vWorldPosition = worldPosition.xyz;","	gl_Position = projectionMatrix * mvPosition;","	vOpacity = opacity;","	vLinearDepth = -mvPosition.z;","	vNormal = normalize(normalMatrix * normal);","	","	#if defined(use_edl)","		vLogDepth = log2(gl_Position.w + 1.0) / log2(far + 1.0);","	#endif","	","	//#if defined(use_logarithmic_depth_buffer)","	//	float logarithmicZ = (2.0 * log2(gl_Position.w + 1.0) / log2(far + 1.0) - 1.0) * gl_Position.w;","	//	gl_Position.z = logarithmicZ;","	//#endif","","	// ---------------------","	// POINT COLOR","	// ---------------------","	","	#ifdef color_type_rgb","		vColor = color;","	#elif defined color_type_height","		vec4 world = modelMatrix * vec4( position, 1.0 );","		float w = (world.y - heightMin) / (heightMax-heightMin);","		vColor = texture2D(gradient, vec2(w,1.0-w)).rgb;","	#elif defined color_type_depth","		float linearDepth = -mvPosition.z ;","		float expDepth = (gl_Position.z / gl_Position.w) * 0.5 + 0.5;","		vColor = vec3(linearDepth, expDepth, 0.0);","	#elif defined color_type_intensity","		float w = (intensity - intensityMin) / (intensityMax - intensityMin);","		vColor = vec3(w, w, w);","	#elif defined color_type_intensity_gradient","		float w = (intensity - intensityMin) / intensityMax;","		vColor = texture2D(gradient, vec2(w,1.0-w)).rgb;","	#elif defined color_type_color","		vColor = uColor;","	#elif defined color_type_lod","		float depth = getLOD();","		float w = depth / 10.0;","		vColor = texture2D(gradient, vec2(w,1.0-w)).rgb;","	#elif defined color_type_point_index","		vColor = indices.rgb;","	#elif defined color_type_classification","		float c = mod(classification, 16.0);","		vec2 uv = vec2(c / 255.0, 0.5);","		vec4 classColor = texture2D(classificationLUT, uv);","		vColor = classColor.rgb;","	#elif defined color_type_return_number","		if(numberOfReturns == 1.0){","			vColor = vec3(1.0, 1.0, 0.0);","		}else{","			if(returnNumber == 1.0){","				vColor = vec3(1.0, 0.0, 0.0);","			}else if(returnNumber == numberOfReturns){","				vColor = vec3(0.0, 0.0, 1.0);","			}else{","				vColor = vec3(0.0, 1.0, 0.0);","			}","		}","	#elif defined color_type_source","		float w = mod(pointSourceID, 10.0) / 10.0;","		vColor = texture2D(gradient, vec2(w,1.0 - w)).rgb;","	#elif defined color_type_normal","		vColor = (modelMatrix * vec4(normal, 0.0)).xyz;","	#elif defined color_type_phong","		vColor = color;","	#endif","	","	{","		// TODO might want to combine with the define block above to avoid reading same LUT two times","		float c = mod(classification, 16.0);","		vec2 uv = vec2(c / 255.0, 0.5);","		","		if(texture2D(classificationLUT, uv).a == 0.0){","			gl_Position = vec4(100.0, 100.0, 100.0, 0.0);","		}","	}","	","	//if(vNormal.z < 0.0){","	//	gl_Position = vec4(1000.0, 1000.0, 1000.0, 1.0);","	//}","	","	// ---------------------","	// POINT SIZE","	// ---------------------","	float pointSize = 1.0;","	","	float projFactor = 1.0 / tan(fov / 2.0);","	projFactor /= vViewPosition.z;","	projFactor *= screenHeight / 2.0;","	float r = spacing * 1.5;","	vRadius = r;","	#if defined fixed_point_size","		pointSize = size;","	#elif defined attenuated_point_size","		pointSize = size * projFactor;","	#elif defined adaptive_point_size","		float worldSpaceSize = size * r / getPointSizeAttenuation();","		pointSize = worldSpaceSize * projFactor;","	#endif","","	pointSize = max(minSize, pointSize);","	pointSize = min(maxSize, pointSize);","	","	vRadius = pointSize / projFactor;","	","	gl_PointSize = pointSize;","	","	","	// ---------------------","	// CLIPPING","	// ---------------------","	","	#if defined use_clip_box","		bool insideAny = false;","		for(int i = 0; i < max_clip_boxes; i++){","			if(i == int(clipBoxCount)){","				break;","			}","		","			vec4 clipPosition = clipBoxes[i] * modelMatrix * vec4( position, 1.0 );","			bool inside = -0.5 <= clipPosition.x && clipPosition.x <= 0.5;","			inside = inside && -0.5 <= clipPosition.y && clipPosition.y <= 0.5;","			inside = inside && -0.5 <= clipPosition.z && clipPosition.z <= 0.5;","			insideAny = insideAny || inside;","		}","		if(!insideAny){","	","			#if defined clip_outside","				gl_Position = vec4(1000.0, 1000.0, 1000.0, 1.0);","			#elif defined clip_highlight_inside && !defined(color_type_depth)","				float c = (vColor.r + vColor.g + vColor.b) / 6.0;","			#endif","		}else{","			#if defined clip_highlight_inside","			vColor.r += 0.5;","			#endif","			","			//vec3 cp = clipBoxPositions[0];","			//vec3 diff = vWorldPosition - cp;","			//vec3 dir = normalize(diff);","			//dir.z = 0.0;","			//dir = normalize(dir);","			//","			//vec4 worldPosition = modelMatrix * vec4( position + dir * 20.0, 1.0 );","			//vec4 mvPosition = modelViewMatrix * vec4( position + dir * 20.0, 1.0 );","			//vViewPosition = -mvPosition.xyz;","			//vWorldPosition = worldPosition.xyz;","			//gl_Position = projectionMatrix * mvPosition;","			","		}","	","	#endif","	","}",""].join("\n"),
Potree.Shaders["pointcloud.fs"]=["","#if defined use_interpolation","	#extension GL_EXT_frag_depth : enable","#endif","","","// the following is an incomplete list of attributes, uniforms and defines","// which are automatically added through the THREE.ShaderMaterial","","// #define USE_COLOR","// ","// uniform mat4 viewMatrix;","// uniform vec3 cameraPosition;","","","uniform mat4 projectionMatrix;","uniform float opacity;","","","#if defined(color_type_phong)","","	uniform vec3 diffuse;","	uniform vec3 ambient;","	uniform vec3 emissive;","	uniform vec3 specular;","	uniform float shininess;","	uniform vec3 ambientLightColor;","","	#if MAX_POINT_LIGHTS > 0","","		uniform vec3 	pointLightColor[ MAX_POINT_LIGHTS ];","		uniform vec3 	pointLightPosition[ MAX_POINT_LIGHTS ];","		uniform float 	pointLightDistance[ MAX_POINT_LIGHTS ];","		uniform float 	pointLightDecay[ MAX_POINT_LIGHTS ];","","	#endif","","	#if MAX_DIR_LIGHTS > 0","","		uniform vec3 directionalLightColor[ MAX_DIR_LIGHTS ];","		uniform vec3 directionalLightDirection[ MAX_DIR_LIGHTS ];","","	#endif","","#endif","","//#if MAX_SPOT_LIGHTS > 0","//","//	uniform vec3 spotLightColor[ MAX_SPOT_LIGHTS ];","//	uniform vec3 spotLightPosition[ MAX_SPOT_LIGHTS ];","//	uniform vec3 spotLightDirection[ MAX_SPOT_LIGHTS ];","//	uniform float spotLightAngleCos[ MAX_SPOT_LIGHTS ];","//	uniform float spotLightExponent[ MAX_SPOT_LIGHTS ];","//","//	uniform float spotLightDistance[ MAX_SPOT_LIGHTS ];","//","//#endif","","uniform float blendHardness;","uniform float blendDepthSupplement;","uniform float fov;","uniform float spacing;","uniform float near;","uniform float far;","uniform float pcIndex;","uniform float screenWidth;","uniform float screenHeight;","","uniform sampler2D depthMap;","","varying vec3	vColor;","varying float	vOpacity;","varying float	vLinearDepth;","varying float	vLogDepth;","varying vec3	vViewPosition;","varying float	vRadius;","varying vec3	vWorldPosition;","varying vec3	vNormal;","","float specularStrength = 1.0;","","void main() {","","	vec3 color = vColor;","	float depth = gl_FragCoord.z;","","	#if defined(circle_point_shape) || defined(use_interpolation) || defined (weighted_splats)","		float u = 2.0 * gl_PointCoord.x - 1.0;","		float v = 2.0 * gl_PointCoord.y - 1.0;","	#endif","	","	#if defined(circle_point_shape) || defined (weighted_splats)","		float cc = u*u + v*v;","		if(cc > 1.0){","			discard;","		}","	#endif","	","	#if defined weighted_splats","		vec2 uv = gl_FragCoord.xy / vec2(screenWidth, screenHeight);","		float sDepth = texture2D(depthMap, uv).r;","		if(vLinearDepth > sDepth + vRadius + blendDepthSupplement){","			discard;","		}","	#endif","	","	#if defined use_interpolation","		float wi = 0.0 - ( u*u + v*v);","		vec4 pos = vec4(-vViewPosition, 1.0);","		pos.z += wi * vRadius;","		float linearDepth = pos.z;","		pos = projectionMatrix * pos;","		pos = pos / pos.w;","		float expDepth = pos.z;","		depth = (pos.z + 1.0) / 2.0;","		gl_FragDepthEXT = depth;","		","		#if defined(color_type_depth)","			color.r = linearDepth;","			color.g = expDepth;","		#endif","		","	#endif","	","	#if defined color_type_point_index","		gl_FragColor = vec4(color, pcIndex / 255.0);","	#else","		gl_FragColor = vec4(color, vOpacity);","	#endif","	","	#if defined weighted_splats","	    float w = pow(1.0 - (u*u + v*v), blendHardness);","		gl_FragColor.rgb = gl_FragColor.rgb * w;","		gl_FragColor.a = w;","	#endif","	","	vec3 normal = normalize( vNormal );","	normal.z = abs(normal.z);","	vec3 viewPosition = normalize( vViewPosition );","	","	#if defined(color_type_phong)","","	// code taken from three.js phong light fragment shader","	","		#if MAX_POINT_LIGHTS > 0","","			vec3 pointDiffuse = vec3( 0.0 );","			vec3 pointSpecular = vec3( 0.0 );","","			for ( int i = 0; i < MAX_POINT_LIGHTS; i ++ ) {","","				vec4 lPosition = viewMatrix * vec4( pointLightPosition[ i ], 1.0 );","				vec3 lVector = lPosition.xyz + vViewPosition.xyz;","","				float lDistance = 1.0;","				if ( pointLightDistance[ i ] > 0.0 )","					lDistance = 1.0 - min( ( length( lVector ) / pointLightDistance[ i ] ), 1.0 );","","				lVector = normalize( lVector );","","						// diffuse","","				float dotProduct = dot( normal, lVector );","","				#ifdef WRAP_AROUND","","					float pointDiffuseWeightFull = max( dotProduct, 0.0 );","					float pointDiffuseWeightHalf = max( 0.5 * dotProduct + 0.5, 0.0 );","","					vec3 pointDiffuseWeight = mix( vec3( pointDiffuseWeightFull ), vec3( pointDiffuseWeightHalf ), wrapRGB );","","				#else","","					float pointDiffuseWeight = max( dotProduct, 0.0 );","","				#endif","","				pointDiffuse += diffuse * pointLightColor[ i ] * pointDiffuseWeight * lDistance;","","						// specular","","				vec3 pointHalfVector = normalize( lVector + viewPosition );","				float pointDotNormalHalf = max( dot( normal, pointHalfVector ), 0.0 );","				float pointSpecularWeight = specularStrength * max( pow( pointDotNormalHalf, shininess ), 0.0 );","","				float specularNormalization = ( shininess + 2.0 ) / 8.0;","","				vec3 schlick = specular + vec3( 1.0 - specular ) * pow( max( 1.0 - dot( lVector, pointHalfVector ), 0.0 ), 5.0 );","				pointSpecular += schlick * pointLightColor[ i ] * pointSpecularWeight * pointDiffuseWeight * lDistance * specularNormalization;","				pointSpecular = vec3(0.0, 0.0, 0.0);","			}","		","		#endif","		","		#if MAX_DIR_LIGHTS > 0","","			vec3 dirDiffuse = vec3( 0.0 );","			vec3 dirSpecular = vec3( 0.0 );","","			for( int i = 0; i < MAX_DIR_LIGHTS; i ++ ) {","","				vec4 lDirection = viewMatrix * vec4( directionalLightDirection[ i ], 0.0 );","				vec3 dirVector = normalize( lDirection.xyz );","","						// diffuse","","				float dotProduct = dot( normal, dirVector );","","				#ifdef WRAP_AROUND","","					float dirDiffuseWeightFull = max( dotProduct, 0.0 );","					float dirDiffuseWeightHalf = max( 0.5 * dotProduct + 0.5, 0.0 );","","					vec3 dirDiffuseWeight = mix( vec3( dirDiffuseWeightFull ), vec3( dirDiffuseWeightHalf ), wrapRGB );","","				#else","","					float dirDiffuseWeight = max( dotProduct, 0.0 );","","				#endif","","				dirDiffuse += diffuse * directionalLightColor[ i ] * dirDiffuseWeight;","","				// specular","","				vec3 dirHalfVector = normalize( dirVector + viewPosition );","				float dirDotNormalHalf = max( dot( normal, dirHalfVector ), 0.0 );","				float dirSpecularWeight = specularStrength * max( pow( dirDotNormalHalf, shininess ), 0.0 );","","				float specularNormalization = ( shininess + 2.0 ) / 8.0;","","				vec3 schlick = specular + vec3( 1.0 - specular ) * pow( max( 1.0 - dot( dirVector, dirHalfVector ), 0.0 ), 5.0 );","				dirSpecular += schlick * directionalLightColor[ i ] * dirSpecularWeight * dirDiffuseWeight * specularNormalization;","			}","","		#endif","		","		vec3 totalDiffuse = vec3( 0.0 );","		vec3 totalSpecular = vec3( 0.0 );","		","		#if MAX_POINT_LIGHTS > 0","","			totalDiffuse += pointDiffuse;","			totalSpecular += pointSpecular;","","		#endif","		","		#if MAX_DIR_LIGHTS > 0","","			totalDiffuse += dirDiffuse;","			totalSpecular += dirSpecular;","","		#endif","		","		gl_FragColor.xyz = gl_FragColor.xyz * ( emissive + totalDiffuse + ambientLightColor * ambient ) + totalSpecular;","","	#endif","	","	","	#if defined(use_edl)","		gl_FragColor.a = vLogDepth;","	#endif","	","}","","",""].join("\n"),Potree.Shaders["normalize.vs"]=["","varying vec2 vUv;","","void main() {","    vUv = uv;","","    gl_Position =   projectionMatrix * modelViewMatrix * vec4(position,1.0);","}"].join("\n"),Potree.Shaders["normalize.fs"]=["","#extension GL_EXT_frag_depth : enable","","uniform sampler2D depthMap;","uniform sampler2D texture;","","varying vec2 vUv;","","void main() {","    float depth = texture2D(depthMap, vUv).g; ","	","	if(depth <= 0.0){","		discard;","	}","	","    vec4 color = texture2D(texture, vUv); ","	color = color / color.w;","    ","	gl_FragColor = vec4(color.xyz, 1.0); ","	","	gl_FragDepthEXT = depth;","}"].join("\n"),Potree.Shaders["edl.vs"]=["","","varying vec2 vUv;","","void main() {","    vUv = uv;","	","	vec4 mvPosition = modelViewMatrix * vec4(position,1.0);","","    gl_Position = projectionMatrix * mvPosition;","}"].join("\n"),Potree.Shaders["edl.fs"]=["","// ","// adapted from the EDL shader code from Christian Boucheny in cloud compare:","// https://github.com/cloudcompare/trunk/tree/master/plugins/qEDL/shaders/EDL","//","","#define NEIGHBOUR_COUNT 8","","uniform mat4 projectionMatrix;","","uniform float screenWidth;","uniform float screenHeight;","uniform float near;","uniform float far;","uniform vec2 neighbours[NEIGHBOUR_COUNT];","uniform vec3 lightDir;","uniform float expScale;","uniform float edlScale;","uniform float radius;","uniform float opacity;","","//uniform sampler2D depthMap;","uniform sampler2D colorMap;","","varying vec2 vUv;","","/**"," * transform linear depth to [0,1] interval with 1 beeing closest to the camera."," */","float ztransform(float linearDepth){","	return 1.0 - (linearDepth - near) / (far - near);","}","","// this actually only returns linear depth values if LOG_BIAS is 1.0","// lower values work out more nicely, though.","#define LOG_BIAS 0.01","float logToLinear(float z){","	return (pow((1.0 + LOG_BIAS * far), z) - 1.0) / LOG_BIAS;","}","","float computeObscurance(float linearDepth){","	vec2 uvRadius = radius / vec2(screenWidth, screenHeight);","	","	float sum = 0.0;","	","	for(int c = 0; c < NEIGHBOUR_COUNT; c++){","		vec2 N_rel_pos = uvRadius * neighbours[c];","		vec2 N_abs_pos = vUv + N_rel_pos;","		","		float neighbourDepth = logToLinear(texture2D(colorMap, N_abs_pos).a);","		","		if(neighbourDepth != 0.0){","			float Znp = ztransform(neighbourDepth) - ztransform(linearDepth);","			","			sum += max(0.0, Znp) / (0.05 * linearDepth);","		}","	}","	","	return sum;","}","","void main(){","	float linearDepth = logToLinear(texture2D(colorMap, vUv).a);","	","	float f = computeObscurance(linearDepth);","	f = exp(-expScale * edlScale * f);","	","	vec4 color = texture2D(colorMap, vUv);","	if(color.a == 0.0 && f >= 1.0){","		discard;","	}","	","	gl_FragColor = vec4(color.rgb * f, opacity);","}",""].join("\n"),Potree.Shaders["blur.vs"]=["","varying vec2 vUv;","","void main() {","    vUv = uv;","","    gl_Position =   projectionMatrix * modelViewMatrix * vec4(position,1.0);","}"].join("\n"),Potree.Shaders["blur.fs"]=["","uniform mat4 projectionMatrix;","","uniform float screenWidth;","uniform float screenHeight;","uniform float near;","uniform float far;","","uniform sampler2D map;","","varying vec2 vUv;","","void main() {","","	float dx = 1.0 / screenWidth;","	float dy = 1.0 / screenHeight;","","	vec3 color = vec3(0.0, 0.0, 0.0);","	color += texture2D(map, vUv + vec2(-dx, -dy)).rgb;","	color += texture2D(map, vUv + vec2(  0, -dy)).rgb;","	color += texture2D(map, vUv + vec2(+dx, -dy)).rgb;","	color += texture2D(map, vUv + vec2(-dx,   0)).rgb;","	color += texture2D(map, vUv + vec2(  0,   0)).rgb;","	color += texture2D(map, vUv + vec2(+dx,   0)).rgb;","	color += texture2D(map, vUv + vec2(-dx,  dy)).rgb;","	color += texture2D(map, vUv + vec2(  0,  dy)).rgb;","	color += texture2D(map, vUv + vec2(+dx,  dy)).rgb;","    ","	color = color / 9.0;","	","	gl_FragColor = vec4(color, 1.0);","	","	","}"].join("\n"),THREE.PerspectiveCamera.prototype.zoomTo=function(e,t){if(e.geometry||e.boundingSphere||e.boundingBox){e.geometry&&null===e.geometry.boundingSphere&&e.geometry.computeBoundingSphere(),e.updateMatrixWorld();var o;o=e.boundingSphere?e.boundingSphere:e.geometry&&e.geometry.boundingSphere?e.geometry.boundingSphere:e.boundingBox.getBoundingSphere();var i=t||1;o=o.clone().applyMatrix4(e.matrixWorld);var n=o.radius,r=this.fov*Math.PI/180;this.aspect<1&&(r*=this.aspect);var a=Math.abs(n/Math.sin(r/2))*i,s=this.getWorldDirection().multiplyScalar(-a);this.position.copy(o.center.clone().add(s))}},THREE.Ray.prototype.distanceToPlaneWithNegative=function(e){var t=e.normal.dot(this.direction);if(0===t)return 0===e.distanceToPoint(this.origin)?0:null;var o=-(this.origin.dot(e.normal)+e.constant)/t;return o},Potree.POCLoader=function(){},Potree.POCLoader.load=function(e,t){try{var o=new Potree.PointCloudOctreeGeometry;o.url=e;var i=new XMLHttpRequest;i.open("GET",e,!0),i.onreadystatechange=function(){if(4===i.readyState&&(200===i.status||0===i.status)){var n=JSON.parse(i.responseText),r=new Potree.Version(n.version);0===n.octreeDir.indexOf("http")?o.octreeDir=n.octreeDir:o.octreeDir=e+"/../"+n.octreeDir,o.spacing=n.spacing,o.hierarchyStepSize=n.hierarchyStepSize,o.pointAttributes=n.pointAttributes;var a=new THREE.Vector3(n.boundingBox.lx,n.boundingBox.ly,n.boundingBox.lz),s=new THREE.Vector3(n.boundingBox.ux,n.boundingBox.uy,n.boundingBox.uz),l=new THREE.Box3(a,s),d=l.clone();n.tightBoundingBox&&(d.min.copy(new THREE.Vector3(n.tightBoundingBox.lx,n.tightBoundingBox.ly,n.tightBoundingBox.lz)),d.max.copy(new THREE.Vector3(n.tightBoundingBox.ux,n.tightBoundingBox.uy,n.tightBoundingBox.uz)));var c=new THREE.Vector3(0,0,0);c.set(-a.x,-a.y,-a.z),l.min.add(c),l.max.add(c),d.min.add(c),d.max.add(c),o.projection=n.projection,o.boundingBox=l,o.tightBoundingBox=d,o.boundingSphere=l.getBoundingSphere(),o.tightBoundingSphere=d.getBoundingSphere(),o.offset=c,"LAS"===n.pointAttributes?o.loader=new Potree.LasLazLoader(n.version):"LAZ"===n.pointAttributes?o.loader=new Potree.LasLazLoader(n.version):(o.loader=new Potree.BinaryLoader(n.version,l,n.scale),o.pointAttributes=new Potree.PointAttributes(o.pointAttributes));var u={},p="r",h=new Potree.PointCloudOctreeGeometryNode(p,o,l);if(h.level=0,h.hasChildren=!0,r.upTo("1.5")?h.numPoints=n.hierarchy[0][1]:h.numPoints=0,o.root=h,o.root.load(),u[p]=h,r.upTo("1.4"))for(var m=1;m<n.hierarchy.length;m++){var p=n.hierarchy[m][0],f=n.hierarchy[m][1],g=parseInt(p.charAt(p.length-1)),v=p.substring(0,p.length-1),y=u[v],E=p.length-1,l=Potree.POCLoader.createChildAABB(y.boundingBox,g),T=new Potree.PointCloudOctreeGeometryNode(p,o,l);T.level=E,T.numPoints=f,y.addChild(T),u[p]=T}o.nodes=u,t(o)}},i.send(null)}catch(n){console.log("loading failed: '"+e+"'"),console.log(n),t()}},Potree.POCLoader.loadPointAttributes=function(e){for(var t=e.pointAttributes,o=new Potree.PointAttributes,i=0;i<t.length;i++){var n=Potree.PointAttribute[t[i]];o.add(n)}return o},Potree.POCLoader.createChildAABB=function(e,t){var o,i,o=(THREE.Vector3,e.min),i=e.max,n=(new THREE.Vector3).copy(i).sub(o).multiplyScalar(.5),r=new THREE.Vector3(n.x,0,0),a=new THREE.Vector3(0,n.y,0),s=new THREE.Vector3(0,0,n.z),l=o,d=(new THREE.Vector3).add(o).add(n);return 1===t?(o=(new THREE.Vector3).copy(l).add(s),i=(new THREE.Vector3).copy(d).add(s)):3===t?(o=(new THREE.Vector3).copy(l).add(s).add(a),i=(new THREE.Vector3).copy(d).add(s).add(a)):0===t?(o=l,i=d):2===t?(o=(new THREE.Vector3).copy(l).add(a),i=(new THREE.Vector3).copy(d).add(a)):5===t?(o=(new THREE.Vector3).copy(l).add(s).add(r),i=(new THREE.Vector3).copy(d).add(s).add(r)):7===t?(o=(new THREE.Vector3).copy(l).add(n),i=(new THREE.Vector3).copy(d).add(n)):4===t?(o=(new THREE.Vector3).copy(l).add(r),i=(new THREE.Vector3).copy(d).add(r)):6===t&&(o=(new THREE.Vector3).copy(l).add(r).add(a),i=(new THREE.Vector3).copy(d).add(r).add(a)),new THREE.Box3(o,i)},Potree.PointAttributeNames={},Potree.PointAttributeNames.POSITION_CARTESIAN=0,Potree.PointAttributeNames.COLOR_PACKED=1,Potree.PointAttributeNames.COLOR_FLOATS_1=2,Potree.PointAttributeNames.COLOR_FLOATS_255=3,Potree.PointAttributeNames.NORMAL_FLOATS=4,Potree.PointAttributeNames.FILLER=5,Potree.PointAttributeNames.INTENSITY=6,Potree.PointAttributeNames.CLASSIFICATION=7,Potree.PointAttributeNames.NORMAL_SPHEREMAPPED=8,Potree.PointAttributeNames.NORMAL_OCT16=9,Potree.PointAttributeNames.NORMAL=10,Potree.PointAttributeTypes={DATA_TYPE_DOUBLE:{ordinal:0,size:8},DATA_TYPE_FLOAT:{ordinal:1,size:4},DATA_TYPE_INT8:{ordinal:2,size:1},DATA_TYPE_UINT8:{ordinal:3,size:1},DATA_TYPE_INT16:{ordinal:4,size:2},DATA_TYPE_UINT16:{ordinal:5,size:2},DATA_TYPE_INT32:{ordinal:6,size:4},DATA_TYPE_UINT32:{ordinal:7,size:4},DATA_TYPE_INT64:{ordinal:8,size:8},DATA_TYPE_UINT64:{ordinal:9,size:8}};var i=0;for(var obj in Potree.PointAttributeTypes)Potree.PointAttributeTypes[i]=Potree.PointAttributeTypes[obj],i++;Potree.PointAttribute=function(e,t,o){this.name=e,this.type=t,this.numElements=o,this.byteSize=this.numElements*this.type.size},Potree.PointAttribute.POSITION_CARTESIAN=new Potree.PointAttribute(Potree.PointAttributeNames.POSITION_CARTESIAN,Potree.PointAttributeTypes.DATA_TYPE_FLOAT,3),Potree.PointAttribute.RGBA_PACKED=new Potree.PointAttribute(Potree.PointAttributeNames.COLOR_PACKED,Potree.PointAttributeTypes.DATA_TYPE_INT8,4),Potree.PointAttribute.COLOR_PACKED=Potree.PointAttribute.RGBA_PACKED,Potree.PointAttribute.RGB_PACKED=new Potree.PointAttribute(Potree.PointAttributeNames.COLOR_PACKED,Potree.PointAttributeTypes.DATA_TYPE_INT8,3),Potree.PointAttribute.NORMAL_FLOATS=new Potree.PointAttribute(Potree.PointAttributeNames.NORMAL_FLOATS,Potree.PointAttributeTypes.DATA_TYPE_FLOAT,3),Potree.PointAttribute.FILLER_1B=new Potree.PointAttribute(Potree.PointAttributeNames.FILLER,Potree.PointAttributeTypes.DATA_TYPE_UINT8,1),Potree.PointAttribute.INTENSITY=new Potree.PointAttribute(Potree.PointAttributeNames.INTENSITY,Potree.PointAttributeTypes.DATA_TYPE_UINT16,1),Potree.PointAttribute.CLASSIFICATION=new Potree.PointAttribute(Potree.PointAttributeNames.CLASSIFICATION,Potree.PointAttributeTypes.DATA_TYPE_UINT8,1),Potree.PointAttribute.NORMAL_SPHEREMAPPED=new Potree.PointAttribute(Potree.PointAttributeNames.NORMAL_SPHEREMAPPED,Potree.PointAttributeTypes.DATA_TYPE_UINT8,2),Potree.PointAttribute.NORMAL_OCT16=new Potree.PointAttribute(Potree.PointAttributeNames.NORMAL_OCT16,Potree.PointAttributeTypes.DATA_TYPE_UINT8,2),Potree.PointAttribute.NORMAL=new Potree.PointAttribute(Potree.PointAttributeNames.NORMAL,Potree.PointAttributeTypes.DATA_TYPE_FLOAT,3),Potree.PointAttributes=function(e){if(this.attributes=[],this.byteSize=0,this.size=0,null!=e)for(var t=0;t<e.length;t++){var o=e[t],i=Potree.PointAttribute[o];this.attributes.push(i),this.byteSize+=i.byteSize,this.size++}},Potree.PointAttributes.prototype.add=function(e){this.attributes.push(e),this.byteSize+=e.byteSize,this.size++},Potree.PointAttributes.prototype.hasColors=function(){for(var e in this.attributes){var t=this.attributes[e];if(t.name===Potree.PointAttributeNames.COLOR_PACKED)return!0}return!1},Potree.PointAttributes.prototype.hasNormals=function(){for(var e in this.attributes){var t=this.attributes[e];if(t===Potree.PointAttribute.NORMAL_SPHEREMAPPED||t===Potree.PointAttribute.NORMAL_FLOATS||t===Potree.PointAttribute.NORMAL||t===Potree.PointAttribute.NORMAL_OCT16)return!0}return!1},Potree.BinaryLoader=function(e,t,o){"string"==typeof e?this.version=new Potree.Version(e):this.version=e,this.boundingBox=t,this.scale=o},Potree.BinaryLoader.prototype.load=function(e){if(!e.loaded){var t=this,o=e.getURL();this.version.equalOrHigher("1.4")&&(o+=".bin");var i=new XMLHttpRequest;i.open("GET",o,!0),i.responseType="arraybuffer",i.overrideMimeType("text/plain; charset=x-user-defined"),i.onreadystatechange=function(){if(4===i.readyState)if(200===i.status||0===i.status){var n=i.response;t.parse(e,n)}else console.log("Failed to load file! HTTP status: "+i.status+", file: "+o)};try{i.send(null)}catch(n){console.log("fehler beim laden der punktwolke: "+n)}}},Potree.BinaryLoader.prototype.parse=function(e,t){var o=t.byteLength/e.pcoGeometry.pointAttributes.byteSize,i=e.pcoGeometry.pointAttributes;this.version.upTo("1.5")&&(e.numPoints=o);var n=Potree.workers.binaryDecoder.getWorker();n.onmessage=function(t){var i=t.data,r=i.attributeBuffers,a=new THREE.Box3((new THREE.Vector3).fromArray(i.tightBoundingBox.min),(new THREE.Vector3).fromArray(i.tightBoundingBox.max));Potree.workers.binaryDecoder.returnWorker(n);var s=new THREE.BufferGeometry;for(var l in r)if(r.hasOwnProperty(l)){var d=r[l].buffer,c=r[l].attribute;c.numElements;parseInt(l)===Potree.PointAttributeNames.POSITION_CARTESIAN?s.addAttribute("position",new THREE.BufferAttribute(new Float32Array(d),3)):parseInt(l)===Potree.PointAttributeNames.COLOR_PACKED?s.addAttribute("color",new THREE.BufferAttribute(new Float32Array(d),3)):parseInt(l)===Potree.PointAttributeNames.INTENSITY?s.addAttribute("intensity",new THREE.BufferAttribute(new Float32Array(d),1)):parseInt(l)===Potree.PointAttributeNames.CLASSIFICATION?s.addAttribute("classification",new THREE.BufferAttribute(new Float32Array(d),1)):parseInt(l)===Potree.PointAttributeNames.NORMAL_SPHEREMAPPED?s.addAttribute("normal",new THREE.BufferAttribute(new Float32Array(d),3)):parseInt(l)===Potree.PointAttributeNames.NORMAL_OCT16?s.addAttribute("normal",new THREE.BufferAttribute(new Float32Array(d),3)):parseInt(l)===Potree.PointAttributeNames.NORMAL&&s.addAttribute("normal",new THREE.BufferAttribute(new Float32Array(d),3))}if(s.addAttribute("indices",new THREE.BufferAttribute(new Float32Array(i.indices),1)),!s.attributes.normal){var d=new Float32Array(3*o);s.addAttribute("normal",new THREE.BufferAttribute(new Float32Array(d),3))}s.boundingBox=e.boundingBox,e.geometry=s,e.tightBoundingBox=a,e.loaded=!0,e.loading=!1,e.pcoGeometry.numNodesLoading--};var r={buffer:t,pointAttributes:i,version:this.version.version,min:[e.boundingBox.min.x,e.boundingBox.min.y,e.boundingBox.min.z],offset:[e.pcoGeometry.offset.x,e.pcoGeometry.offset.y,e.pcoGeometry.offset.z],scale:this.scale};n.postMessage(r,[r.buffer])},Potree.LasLazLoader=function(e){"string"==typeof e?this.version=new Potree.Version(e):this.version=e},Potree.LasLazLoader.prototype.load=function(e){if(!e.loaded){var t=e.pcoGeometry.pointAttributes,o=e.getURL();this.version.equalOrHigher("1.4")&&(o+="."+t.toLowerCase());var i=this,n=new XMLHttpRequest;n.open("GET",o,!0),n.responseType="arraybuffer",n.overrideMimeType("text/plain; charset=x-user-defined"),n.onreadystatechange=function(){if(4===n.readyState)if(200===n.status){var t=n.response;i.parse(e,t)}else console.log("Failed to load file! HTTP status: "+n.status+", file: "+o)},n.send(null)}},Potree.LasLazLoader.progressCB=function(e){},Potree.LasLazLoader.prototype.parse=function(e,t){var o=new LASFile(t),i=new Potree.LasLazBatcher(e);return Promise.resolve(o).cancellable().then(function(e){return e.open().then(function(){return e.isOpen=!0,e})["catch"](Promise.CancellationError,function(t){return e.close().then(function(){throw t})})}).then(function(e){return e.getHeader().then(function(t){return[e,t]})}).then(function(e){var t=e[0],o=e[1],n=1,r=0,a=1>=n?o.pointsCount:o.pointsCount/n,s=function(){var e=t.readData(1e6,0,n);return e.then(function(e){return i.push(new LASDecoder(e.buffer,o.pointsFormatId,o.pointsStructSize,e.count,o.scale,o.offset,o.mins,o.maxs)),r+=e.count,Potree.LasLazLoader.progressCB(r/a),e.hasMoreData?s():(o.totalRead=r,o.versionAsString=t.versionAsString,o.isCompressed=t.isCompressed,[t,o,i])})};return s()}).then(function(e){var t=e[0];return Potree.LasLazLoader.progressCB(1),t.close().then(function(){return t.isOpen=!1,Promise.delay(200).cancellable()}).then(function(){return e.slice(1)})})["catch"](Promise.CancellationError,function(e){if(o.isOpen)return o.close().then(function(){throw o.isOpen=!1,e});throw e})},Potree.LasLazLoader.prototype.handle=function(e,t){},Potree.LasLazBatcher=function(e){this.push=function(t){var o=Potree.workers.lasdecoder.getWorker(),i=new THREE.Vector3(t.mins[0],t.mins[1],t.mins[2]),n=new THREE.Vector3(t.maxs[0],t.maxs[1],t.maxs[2]);i.add(e.pcoGeometry.offset),n.add(e.pcoGeometry.offset),o.onmessage=function(r){for(var a=new THREE.BufferGeometry,s=t.pointsCount,l=r.data.position,d=r.data.color,c=r.data.intensity,u=new Uint8Array(r.data.classification),p=new Float32Array(u.byteLength),h=new Uint8Array(r.data.returnNumber),m=new Uint8Array(r.data.numberOfReturns),f=new Float32Array(h.byteLength),g=new Float32Array(m.byteLength),v=new Uint16Array(r.data.pointSourceID),y=new Float32Array(v.length),E=new ArrayBuffer(4*s),T=new Uint32Array(E),b=new THREE.Box3,P=new Float32Array(l),R=0;s>R;R++)p[R]=u[R],f[R]=h[R],g[R]=m[R],y[R]=v[R],T[R]=R,b.expandByPoint(new THREE.Vector3(P[3*R+0],P[3*R+1],P[3*R+2]));a.addAttribute("position",new THREE.BufferAttribute(new Float32Array(l),3)),a.addAttribute("color",new THREE.BufferAttribute(new Float32Array(d),3)),a.addAttribute("intensity",new THREE.BufferAttribute(new Float32Array(c),1)),a.addAttribute("classification",new THREE.BufferAttribute(new Float32Array(p),1)),a.addAttribute("returnNumber",new THREE.BufferAttribute(new Float32Array(f),1)),a.addAttribute("numberOfReturns",new THREE.BufferAttribute(new Float32Array(g),1)),a.addAttribute("pointSourceID",new THREE.BufferAttribute(new Float32Array(y),1)),a.addAttribute("indices",new THREE.BufferAttribute(E,1)),a.addAttribute("normal",new THREE.BufferAttribute(new Float32Array(3*s),3));var x=new THREE.Box3((new THREE.Vector3).fromArray(r.data.tightBoundingBox.min),(new THREE.Vector3).fromArray(r.data.tightBoundingBox.max));a.boundingBox=new THREE.Box3(i,n),e.tightBoundingBox=x,e.geometry=a,e.loaded=!0,e.loading=!1,e.pcoGeometry.numNodesLoading--,Potree.workers.lasdecoder.returnWorker(o)};var r={buffer:t.arrayb,numPoints:t.pointsCount,pointSize:t.pointSize,pointFormatID:2,scale:t.scale,offset:t.offset,mins:[e.pcoGeometry.boundingBox.min.x,e.pcoGeometry.boundingBox.min.y,e.pcoGeometry.boundingBox.min.z],maxs:[e.pcoGeometry.boundingBox.max.x,e.pcoGeometry.boundingBox.max.y,e.pcoGeometry.boundingBox.max.z],bbOffset:[e.pcoGeometry.offset.x,e.pcoGeometry.offset.y,e.pcoGeometry.offset.z]};o.postMessage(r,[r.buffer])}},Potree.Gradients={RAINBOW:[[0,new THREE.Color(.278,0,.714)],[1/6,new THREE.Color(0,0,1)],[2/6,new THREE.Color(0,1,1)],[.5,new THREE.Color(0,1,0)],[4/6,new THREE.Color(1,1,0)],[5/6,new THREE.Color(1,.64,0)],[1,new THREE.Color(1,0,0)]],GRAYSCALE:[[0,new THREE.Color(0,0,0)],[1,new THREE.Color(1,1,1)]]},Potree.Classification={DEFAULT:{0:new THREE.Vector4(.5,.5,.5,1),1:new THREE.Vector4(.5,.5,.5,1),2:new THREE.Vector4(.63,.32,.18,1),3:new THREE.Vector4(0,1,0,1),4:new THREE.Vector4(0,.8,0,1),5:new THREE.Vector4(0,.6,0,1),6:new THREE.Vector4(1,.66,0,1),7:new THREE.Vector4(1,0,1,1),8:new THREE.Vector4(1,0,0,1),9:new THREE.Vector4(0,0,1,1),12:new THREE.Vector4(1,1,0,1),DEFAULT:new THREE.Vector4(.3,.6,.6,1)}},Potree.PointSizeType={FIXED:0,ATTENUATED:1,ADAPTIVE:2},Potree.PointShape={SQUARE:0,CIRCLE:1},Potree.PointColorType={RGB:0,COLOR:1,DEPTH:2,HEIGHT:3,ELEVATION:3,INTENSITY:4,INTENSITY_GRADIENT:5,LOD:6,LEVEL_OF_DETAIL:6,POINT_INDEX:7,CLASSIFICATION:8,RETURN_NUMBER:9,SOURCE:10,NORMAL:11,PHONG:12},Potree.ClipMode={DISABLED:0,CLIP_OUTSIDE:1,HIGHLIGHT_INSIDE:2},Potree.TreeType={OCTREE:0,KDTREE:1},Potree.PointCloudMaterial=function(e){THREE.Material.call(this),e=e||{};var t=new THREE.Color(16777215),o=THREE.ImageUtils.generateDataTexture(2048,1,t);o.magFilter=THREE.NearestFilter,this.visibleNodesTexture=o;var i=e.size||1,n=e.minSize||1,r=e.maxSize||50,a=e.treeType||Potree.TreeType.OCTREE,s=1;this._pointSizeType=Potree.PointSizeType.ATTENUATED,this._pointShape=Potree.PointShape.SQUARE,this._interpolate=!1,this._pointColorType=Potree.PointColorType.RGB,this._useClipBox=!1,this.numClipBoxes=0,this._clipMode=Potree.ClipMode.DISABLED,this._weighted=!1,this._depthMap=null,this._gradient=Potree.Gradients.RAINBOW,this._classification=Potree.Classification.DEFAULT,this.gradientTexture=Potree.PointCloudMaterial.generateGradientTexture(this._gradient),this.classificationTexture=Potree.PointCloudMaterial.generateClassificationTexture(this._classification),this.lights=!0,this._treeType=a,this._useLogarithmicDepthBuffer=!1,this._useEDL=!1;var l={},d={spacing:{type:"f",value:1},blendHardness:{type:"f",value:2},blendDepthSupplement:{type:"f",value:0},fov:{type:"f",value:1},screenWidth:{type:"f",value:1},screenHeight:{type:"f",value:1},near:{type:"f",value:.1},far:{type:"f",value:1},uColor:{type:"c",value:new THREE.Color(16777215)},opacity:{type:"f",value:1},size:{type:"f",value:10},minSize:{type:"f",value:2},maxSize:{type:"f",value:2},octreeSize:{type:"f",value:0},bbSize:{type:"fv",value:[0,0,0]},heightMin:{type:"f",value:0},heightMax:{type:"f",value:1},intensityMin:{type:"f",value:0},intensityMax:{type:"f",value:1},clipBoxCount:{type:"f",value:0},visibleNodes:{type:"t",value:this.visibleNodesTexture},pcIndex:{type:"f",value:0},gradient:{type:"t",value:this.gradientTexture},classificationLUT:{type:"t",value:this.classificationTexture},clipBoxes:{type:"Matrix4fv",value:[]},clipBoxPositions:{type:"fv",value:null},depthMap:{type:"t",value:null},diffuse:{type:"fv",value:[1,1,1]},ambient:{type:"fv",value:[.1,.1,.1]},ambientLightColor:{type:"fv",value:[1,1,1]},directionalLightColor:{type:"fv",value:null},directionalLightDirection:{type:"fv",value:null},pointLightColor:{type:"fv",value:null},pointLightPosition:{type:"fv",value:null},pointLightDistance:{type:"fv1",value:null},pointLightDecay:{type:"fv1",value:null},spotLightColor:{type:"fv",value:null},spotLightPosition:{type:"fv",value:null},spotLightDistance:{type:"fv1",value:null},spotLightDecay:{type:"fv1",value:null},spotLightDirection:{type:"fv",value:null},spotLightAngleCos:{type:"fv1",value:null},spotLightExponent:{type:"fv1",value:null},hemisphereLightSkyColor:{type:"fv",value:null},hemisphereLightGroundColor:{type:"fv",value:null},hemisphereLightDirection:{type:"fv",value:null}};this.defaultAttributeValues.normal=[0,0,0],this.defaultAttributeValues.classification=[0,0,0],this.setValues({uniforms:d,attributes:l,vertexShader:this.getDefines()+Potree.Shaders["pointcloud.vs"],fragmentShader:this.getDefines()+Potree.Shaders["pointcloud.fs"],vertexColors:THREE.VertexColors,size:i,minSize:n,maxSize:r,nodeSize:s,pcIndex:0,alphaTest:.9})},Potree.PointCloudMaterial.prototype=new THREE.ShaderMaterial,Potree.PointCloudMaterial.prototype.updateShaderSource=function(){var e={};this.pointColorType===Potree.PointColorType.INTENSITY||this.pointColorType===Potree.PointColorType.INTENSITY_GRADIENT?e.intensity={type:"f",value:[]}:this.pointColorType===Potree.PointColorType.CLASSIFICATION||(this.pointColorType===Potree.PointColorType.RETURN_NUMBER?(e.returnNumber={type:"f",value:[]},e.numberOfReturns={type:"f",value:[]}):this.pointColorType===Potree.PointColorType.SOURCE?e.pointSourceID={type:"f",value:[]}:(this.pointColorType===Potree.PointColorType.NORMAL||this.pointColorType===Potree.PointColorType.PHONG)&&(e.normal={type:"f",value:[]})),e.classification={type:"f",value:0};var t=this.getDefines()+Potree.Shaders["pointcloud.vs"],o=this.getDefines()+Potree.Shaders["pointcloud.fs"];this.setValues({attributes:e,vertexShader:t,fragmentShader:o}),this.depthMap&&(this.uniforms.depthMap.value=this.depthMap,this.setValues({depthMap:this.depthMap})),1===this.opacity?this.setValues({blending:THREE.NoBlending,transparent:!1,depthTest:!0,depthWrite:!0}):this.setValues({blending:THREE.AdditiveBlending,transparent:!0,depthTest:!1,depthWrite:!0}),this.weighted&&this.setValues({blending:THREE.AdditiveBlending,transparent:!0,depthTest:!0,depthWrite:!1}),this.needsUpdate=!0},Potree.PointCloudMaterial.prototype.getDefines=function(){var e="";return this.pointSizeType===Potree.PointSizeType.FIXED?e+="#define fixed_point_size\n":this.pointSizeType===Potree.PointSizeType.ATTENUATED?e+="#define attenuated_point_size\n":this.pointSizeType===Potree.PointSizeType.ADAPTIVE&&(e+="#define adaptive_point_size\n"),this.pointShape===Potree.PointShape.SQUARE?e+="#define square_point_shape\n":this.pointShape===Potree.PointShape.CIRCLE&&(e+="#define circle_point_shape\n"),this._interpolate&&(e+="#define use_interpolation\n"),this._useLogarithmicDepthBuffer&&(e+="#define use_logarithmic_depth_buffer\n"),this._useEDL&&(e+="#define use_edl\n"),this._pointColorType===Potree.PointColorType.RGB?e+="#define color_type_rgb\n":this._pointColorType===Potree.PointColorType.COLOR?e+="#define color_type_color\n":this._pointColorType===Potree.PointColorType.DEPTH?e+="#define color_type_depth\n":this._pointColorType===Potree.PointColorType.HEIGHT?e+="#define color_type_height\n":this._pointColorType===Potree.PointColorType.INTENSITY?e+="#define color_type_intensity\n":this._pointColorType===Potree.PointColorType.INTENSITY_GRADIENT?e+="#define color_type_intensity_gradient\n":this._pointColorType===Potree.PointColorType.LOD?e+="#define color_type_lod\n":this._pointColorType===Potree.PointColorType.POINT_INDEX?e+="#define color_type_point_index\n":this._pointColorType===Potree.PointColorType.CLASSIFICATION?e+="#define color_type_classification\n":this._pointColorType===Potree.PointColorType.RETURN_NUMBER?e+="#define color_type_return_number\n":this._pointColorType===Potree.PointColorType.SOURCE?e+="#define color_type_source\n":this._pointColorType===Potree.PointColorType.NORMAL?e+="#define color_type_normal\n":this._pointColorType===Potree.PointColorType.PHONG&&(e+="#define color_type_phong\n"),
this.clipMode===Potree.ClipMode.DISABLED?e+="#define clip_disabled\n":this.clipMode===Potree.ClipMode.CLIP_OUTSIDE?e+="#define clip_outside\n":this.clipMode===Potree.ClipMode.HIGHLIGHT_INSIDE&&(e+="#define clip_highlight_inside\n"),this._treeType===Potree.TreeType.OCTREE?e+="#define tree_type_octree\n":this._treeType===Potree.TreeType.KDTREE&&(e+="#define tree_type_kdtree\n"),this.weighted&&(e+="#define weighted_splats\n"),this.numClipBoxes>0&&(e+="#define use_clip_box\n"),e},Potree.PointCloudMaterial.prototype.setClipBoxes=function(e){if(e){this.clipBoxes=e;var t=this.numClipBoxes!=e.length&&(0===e.length||0===this.numClipBoxes);this.numClipBoxes=e.length,this.uniforms.clipBoxCount.value=this.numClipBoxes,t&&this.updateShaderSource(),this.uniforms.clipBoxes.value=new Float32Array(16*this.numClipBoxes),this.uniforms.clipBoxPositions.value=new Float32Array(3*this.numClipBoxes);for(var o=0;o<this.numClipBoxes;o++){var i=e[o];this.uniforms.clipBoxes.value.set(i.inverse.elements,16*o),this.uniforms.clipBoxPositions.value[3*o+0]=i.position.x,this.uniforms.clipBoxPositions.value[3*o+1]=i.position.y,this.uniforms.clipBoxPositions.value[3*o+2]=i.position.z}}},Object.defineProperty(Potree.PointCloudMaterial.prototype,"gradient",{get:function(){return this._gradient},set:function(e){this._gradient!==e&&(this._gradient=e,this.gradientTexture=Potree.PointCloudMaterial.generateGradientTexture(this._gradient),this.uniforms.gradient.value=this.gradientTexture)}}),Object.defineProperty(Potree.PointCloudMaterial.prototype,"classification",{get:function(){return this._classification},set:function(e){this._classification=e,this.classificationTexture=Potree.PointCloudMaterial.generateClassificationTexture(this._classification),this.uniforms.classificationLUT.value=this.classificationTexture}}),Object.defineProperty(Potree.PointCloudMaterial.prototype,"spacing",{get:function(){return this.uniforms.spacing.value},set:function(e){this.uniforms.spacing.value!==e&&(this.uniforms.spacing.value=e)}}),Object.defineProperty(Potree.PointCloudMaterial.prototype,"useClipBox",{get:function(){return this._useClipBox},set:function(e){this._useClipBox!==e&&(this._useClipBox=e,this.updateShaderSource())}}),Object.defineProperty(Potree.PointCloudMaterial.prototype,"weighted",{get:function(){return this._weighted},set:function(e){this._weighted!==e&&(this._weighted=e,this.updateShaderSource())}}),Object.defineProperty(Potree.PointCloudMaterial.prototype,"fov",{get:function(){return this.uniforms.fov.value},set:function(e){this.uniforms.fov.value!==e&&(this.uniforms.fov.value=e)}}),Object.defineProperty(Potree.PointCloudMaterial.prototype,"screenWidth",{get:function(){return this.uniforms.screenWidth.value},set:function(e){this.uniforms.screenWidth.value!==e&&(this.uniforms.screenWidth.value=e)}}),Object.defineProperty(Potree.PointCloudMaterial.prototype,"screenHeight",{get:function(){return this.uniforms.screenHeight.value},set:function(e){this.uniforms.screenHeight.value!==e&&(this.uniforms.screenHeight.value=e)}}),Object.defineProperty(Potree.PointCloudMaterial.prototype,"near",{get:function(){return this.uniforms.near.value},set:function(e){this.uniforms.near.value!==e&&(this.uniforms.near.value=e)}}),Object.defineProperty(Potree.PointCloudMaterial.prototype,"far",{get:function(){return this.uniforms.far.value},set:function(e){this.uniforms.far.value!==e&&(this.uniforms.far.value=e)}}),Object.defineProperty(Potree.PointCloudMaterial.prototype,"opacity",{get:function(){return this.uniforms.opacity.value},set:function(e){this.uniforms.opacity&&this.uniforms.opacity.value!==e&&(this.uniforms.opacity.value=e,this.updateShaderSource())}}),Object.defineProperty(Potree.PointCloudMaterial.prototype,"pointColorType",{get:function(){return this._pointColorType},set:function(e){this._pointColorType!==e&&(this._pointColorType=e,this.updateShaderSource())}}),Object.defineProperty(Potree.PointCloudMaterial.prototype,"depthMap",{get:function(){return this._depthMap},set:function(e){this._depthMap!==e&&(this._depthMap=e,this.updateShaderSource())}}),Object.defineProperty(Potree.PointCloudMaterial.prototype,"pointSizeType",{get:function(){return this._pointSizeType},set:function(e){this._pointSizeType!==e&&(this._pointSizeType=e,this.updateShaderSource())}}),Object.defineProperty(Potree.PointCloudMaterial.prototype,"clipMode",{get:function(){return this._clipMode},set:function(e){this._clipMode!==e&&(this._clipMode=e,this.updateShaderSource())}}),Object.defineProperty(Potree.PointCloudMaterial.prototype,"interpolate",{get:function(){return this._interpolate},set:function(e){this._interpolate!==e&&(this._interpolate=e,this.updateShaderSource())}}),Object.defineProperty(Potree.PointCloudMaterial.prototype,"useEDL",{get:function(){return this._useEDL},set:function(e){this._useEDL!==e&&(this._useEDL=e,this.updateShaderSource())}}),Object.defineProperty(Potree.PointCloudMaterial.prototype,"useLogarithmicDepthBuffer",{get:function(){return this._useLogarithmicDepthBuffer},set:function(e){this._useLogarithmicDepthBuffer!==e&&(this._useLogarithmicDepthBuffer=e,this.updateShaderSource())}}),Object.defineProperty(Potree.PointCloudMaterial.prototype,"color",{get:function(){return this.uniforms.uColor.value},set:function(e){this.uniforms.uColor.value!==e&&(this.uniforms.uColor.value.copy(e),this.updateShaderSource())}}),Object.defineProperty(Potree.PointCloudMaterial.prototype,"pointShape",{get:function(){return this._pointShape},set:function(e){this._pointShape!==e&&(this._pointShape=e,this.updateShaderSource())}}),Object.defineProperty(Potree.PointCloudMaterial.prototype,"size",{get:function(){return this.uniforms.size.value},set:function(e){this.uniforms.size.value=e}}),Object.defineProperty(Potree.PointCloudMaterial.prototype,"minSize",{get:function(){return this.uniforms.minSize.value},set:function(e){this.uniforms.minSize.value=e}}),Object.defineProperty(Potree.PointCloudMaterial.prototype,"maxSize",{get:function(){return this.uniforms.maxSize.value},set:function(e){this.uniforms.maxSize.value=e}}),Object.defineProperty(Potree.PointCloudMaterial.prototype,"heightMin",{get:function(){return this.uniforms.heightMin.value},set:function(e){this.uniforms.heightMin.value=e}}),Object.defineProperty(Potree.PointCloudMaterial.prototype,"heightMax",{get:function(){return this.uniforms.heightMax.value},set:function(e){this.uniforms.heightMax.value=e}}),Object.defineProperty(Potree.PointCloudMaterial.prototype,"intensityMin",{get:function(){return this.uniforms.intensityMin.value},set:function(e){this.uniforms.intensityMin.value=e}}),Object.defineProperty(Potree.PointCloudMaterial.prototype,"intensityMax",{get:function(){return this.uniforms.intensityMax.value},set:function(e){this.uniforms.intensityMax.value=e}}),Object.defineProperty(Potree.PointCloudMaterial.prototype,"pcIndex",{get:function(){return this.uniforms.pcIndex.value},set:function(e){this.uniforms.pcIndex.value=e}}),Object.defineProperty(Potree.PointCloudMaterial.prototype,"treeType",{get:function(){return this._treeType},set:function(e){this._treeType!=e&&(this._treeType=e,this.updateShaderSource())}}),Object.defineProperty(Potree.PointCloudMaterial.prototype,"bbSize",{get:function(){return this.uniforms.bbSize.value},set:function(e){this.uniforms.bbSize.value=e}}),Potree.PointCloudMaterial.generateGradientTexture=function(e){var t=64;canvas=document.createElement("canvas"),canvas.width=t,canvas.height=t;var o=canvas.getContext("2d");o.rect(0,0,t,t);for(var i=o.createLinearGradient(0,0,t,t),n=0;n<e.length;n++){var r=e[n];i.addColorStop(r[0],"#"+r[1].getHexString())}o.fillStyle=i,o.fill();var a=new THREE.Texture(canvas);return a.needsUpdate=!0,textureImage=a.image,a},Potree.PointCloudMaterial.generateClassificationTexture=function(e){for(var t=256,o=256,i=t*o,n=new Uint8Array(4*i),r=0;t>r;r++)for(var a=0;o>a;a++){var s,l=r+t*a;s=e[r]?e[r]:e.DEFAULT,n[4*l+0]=255*s.x,n[4*l+1]=255*s.y,n[4*l+2]=255*s.z,n[4*l+3]=255*s.w}var d=new THREE.DataTexture(n,t,o,THREE.RGBAFormat);return d.magFilter=THREE.NearestFilter,d.needsUpdate=!0,d},Potree.EyeDomeLightingMaterial=function(e){THREE.Material.call(this),e=e||{};for(var t=8,o=new Float32Array(2*t),i=0;t>i;i++)o[2*i+0]=Math.cos(2*i*Math.PI/t),o[2*i+1]=Math.sin(2*i*Math.PI/t);var n=new THREE.Vector3(0,0,1).normalize(),r={screenWidth:{type:"f",value:0},screenHeight:{type:"f",value:0},near:{type:"f",value:0},far:{type:"f",value:0},expScale:{type:"f",value:100},edlScale:{type:"f",value:1},radius:{type:"f",value:3},lightDir:{type:"v3",value:n},neighbours:{type:"2fv",value:o},depthMap:{type:"t",value:null},colorMap:{type:"t",value:null},opacity:{type:"f",value:1}};this.setValues({uniforms:r,vertexShader:Potree.Shaders["edl.vs"],fragmentShader:Potree.Shaders["edl.fs"]})},Potree.EyeDomeLightingMaterial.prototype=new THREE.ShaderMaterial,Potree.BlurMaterial=function(e){THREE.Material.call(this),e=e||{};var t={near:{type:"f",value:0},far:{type:"f",value:0},screenWidth:{type:"f",value:0},screenHeight:{type:"f",value:0},map:{type:"t",value:null}};this.setValues({uniforms:t,vertexShader:Potree.Shaders["blur.vs"],fragmentShader:Potree.Shaders["blur.fs"]})},Potree.BlurMaterial.prototype=new THREE.ShaderMaterial,THREE.FirstPersonControls=function(e,t){function o(e){l.enabled!==!1&&(e.preventDefault(),0===e.button?(P=b.ROTATE,d.set(e.clientX,e.clientY)):2===e.button&&(P=b.PAN,p.set(e.clientX,e.clientY)),l.domElement.addEventListener("mousemove",i,!1),l.domElement.addEventListener("mouseup",n,!1),l.dispatchEvent(x))}function i(e){if(l.enabled!==!1){e.preventDefault();var t=l.domElement===document?l.domElement.body:l.domElement;P===b.ROTATE?(c.set(e.clientX,e.clientY),u.subVectors(c,d),l.rotateLeft(2*Math.PI*u.x/t.clientWidth*l.rotateSpeed),l.rotateUp(2*Math.PI*u.y/t.clientHeight*l.rotateSpeed),d.copy(c)):P===b.PAN&&(h.set(e.clientX,e.clientY),m.subVectors(h,p),m.multiplyScalar(5e-4).multiplyScalar(l.moveSpeed),l.pan(m.x,m.y),p.copy(h))}}function n(){l.enabled!==!1&&(l.domElement.removeEventListener("mousemove",i,!1),l.domElement.removeEventListener("mouseup",n,!1),l.dispatchEvent(w),P=b.NONE)}function r(e){if(l.enabled!==!1&&l.noZoom!==!0){e.preventDefault();var t=e.detail<0||e.wheelDelta>0?1:-1,o=l.moveSpeed+.1*l.moveSpeed*t;o=Math.max(.1,o),l.setMoveSpeed(o),l.dispatchEvent(x),l.dispatchEvent(w)}}function a(e){if(l.enabled!==!1)switch(e.keyCode){case l.keys.UP:l.moveForward=!0;break;case l.keys.BOTTOM:l.moveBackward=!0;break;case l.keys.LEFT:l.moveLeft=!0;break;case l.keys.RIGHT:l.moveRight=!0;break;case l.keys.W:l.moveForward=!0;break;case l.keys.S:l.moveBackward=!0;break;case l.keys.A:l.moveLeft=!0;break;case l.keys.D:l.moveRight=!0}}function s(e){switch(e.keyCode){case l.keys.W:l.moveForward=!1;break;case l.keys.S:l.moveBackward=!1;break;case l.keys.A:l.moveLeft=!1;break;case l.keys.D:l.moveRight=!1;break;case l.keys.UP:l.moveForward=!1;break;case l.keys.BOTTOM:l.moveBackward=!1;break;case l.keys.LEFT:l.moveLeft=!1;break;case l.keys.RIGHT:l.moveRight=!1}}this.object=e,this.domElement=void 0!==t?t:document,this.enabled=!0,this.rotateSpeed=1,this.moveSpeed=10,this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40,A:"A".charCodeAt(0),S:"S".charCodeAt(0),D:"D".charCodeAt(0),W:"W".charCodeAt(0)};var l=this,d=new THREE.Vector2,c=new THREE.Vector2,u=new THREE.Vector2,p=new THREE.Vector2,h=new THREE.Vector2,m=new THREE.Vector2,f=new THREE.Vector3,g=(new THREE.Vector3,0),v=0,y=1,E=new THREE.Vector3,T=new THREE.Vector3,b={NONE:-1,ROTATE:0,SPEEDCHANGE:1,PAN:2},P=b.NONE;this.position0=this.object.position.clone();var R={type:"change"},x={type:"start"},w={type:"end"};this.rotateLeft=function(e){v-=e},this.rotateUp=function(e){g-=e},this.panLeft=function(e){var t=this.object.matrix.elements;f.set(t[0],t[1],t[2]),f.multiplyScalar(-e),E.add(f)},this.panUp=function(e){var t=this.object.matrix.elements;f.set(t[4],t[5],t[6]),f.multiplyScalar(e),E.add(f)},this.panForward=function(e){var t=this.object.matrix.elements;f.set(t[8],t[9],t[10]),f.multiplyScalar(e),E.add(f)},this.pan=function(e,t){var o=l.domElement===document?l.domElement.body:l.domElement;if(void 0!==l.object.fov){var i=l.object.position,n=i.clone(),r=n.length();r*=Math.tan(l.object.fov/2*Math.PI/180),l.panLeft(2*e*r/o.clientHeight),l.panUp(2*t*r/o.clientHeight)}else void 0!==l.object.top?(l.panLeft(e*(l.object.right-l.object.left)/o.clientWidth),l.panUp(t*(l.object.top-l.object.bottom)/o.clientHeight)):console.warn("WARNING: FirstPersonControls.js encountered an unknown camera type - pan disabled.")},this.update=function(e){this.object.rotation.order="ZYX";var t=this.object;this.object=new THREE.Object3D,this.object.position.copy(t.position),this.object.rotation.copy(t.rotation),this.object.updateMatrix(),this.object.updateMatrixWorld();var o=this.object.position;if(void 0!==e&&(this.moveRight&&this.panLeft(-e*this.moveSpeed),this.moveLeft&&this.panLeft(e*this.moveSpeed),this.moveForward&&this.panForward(-e*this.moveSpeed),this.moveBackward&&this.panForward(e*this.moveSpeed)),!E.equals(new THREE.Vector3(0,0,0))){var i={type:"move",translation:E.clone()};this.dispatchEvent(i)}if(o.add(E),0!==v||0!==g){var i={type:"rotate",thetaDelta:v,phiDelta:g};this.dispatchEvent(i)}this.object.updateMatrix();var n=(new THREE.Matrix4).makeRotationY(v),r=(new THREE.Matrix4).multiplyMatrices(n,this.object.matrix);this.object.quaternion.setFromRotationMatrix(r),this.object.rotation.x+=g,this.object.updateMatrixWorld();var a={type:"proposeTransform",oldPosition:t.position,newPosition:this.object.position,objections:0,counterProposals:[]};if(this.dispatchEvent(a),a.objections>0&&a.counterProposals.length>0){var s=a.counterProposals;this.object.position.copy(s[0]),a.objections=0,a.counterProposals=[]}a.objections>0||t.position.copy(this.object.position),t.rotation.copy(this.object.rotation),this.object=t,v=0,g=0,y=1,E.set(0,0,0),T.distanceTo(this.object.position)>0&&(this.dispatchEvent(R),T.copy(this.object.position))},this.reset=function(){P=b.NONE,this.object.position.copy(this.position0)},this.setMoveSpeed=function(e){l.moveSpeed!==e&&(l.moveSpeed=e,l.dispatchEvent({type:"move_speed_changed",controls:l}))},this.domElement.addEventListener("contextmenu",function(e){e.preventDefault()},!1),this.domElement.addEventListener("mousedown",o,!1),this.domElement.addEventListener("mousewheel",r,!1),this.domElement.addEventListener("DOMMouseScroll",r,!1),-1===this.domElement.tabIndex&&(this.domElement.tabIndex=2222),this.domElement.addEventListener("keydown",a,!1),this.domElement.addEventListener("keyup",s,!1)},THREE.FirstPersonControls.prototype=Object.create(THREE.EventDispatcher.prototype),Potree.GeoControls=function(e,t){function o(e){l.enabled!==!1&&(e.preventDefault(),0===e.button?(P=b.ROTATE,d.set(e.clientX,e.clientY)):1===e.button?(P=b.PAN,p.set(e.clientX,e.clientY)):2===e.button&&(l.moveForwardMouse=!0),l.dispatchEvent(x))}function i(e){if(l.enabled!==!1){e.preventDefault();var t=l.domElement===document?l.domElement.body:l.domElement;P===b.ROTATE?(c.set(e.clientX,e.clientY),u.subVectors(c,d),l.rotateLeft(2*Math.PI*u.x/t.clientWidth*l.rotateSpeed),l.rotateUp(2*Math.PI*u.y/t.clientHeight*l.rotateSpeed),d.copy(c)):P===b.PAN&&(h.set(e.clientX,e.clientY),m.subVectors(h,p),m.multiplyScalar(.002).multiplyScalar(l.moveSpeed),l.pan(m.x,m.y),p.copy(h))}}function n(e){l.enabled!==!1&&(2===e.button?l.moveForwardMouse=!1:(l.dispatchEvent(w),P=b.NONE))}function r(e){if(l.enabled!==!1&&l.noZoom!==!0){e.preventDefault();var t=e.detail<0||e.wheelDelta>0?1:-1,o=l.moveSpeed+.1*l.moveSpeed*t;o=Math.max(.1,o),l.setMoveSpeed(o),l.dispatchEvent(x),l.dispatchEvent(w)}}function a(e){if(l.enabled!==!1)switch(l.shiftDown=e.shiftKey,e.keyCode){case l.keys.UP:l.moveForward=!0;break;case l.keys.BOTTOM:l.moveBackward=!0;break;case l.keys.LEFT:l.moveLeft=!0;break;case l.keys.RIGHT:l.moveRight=!0;break;case l.keys.W:l.moveForward=!0;break;case l.keys.S:l.moveBackward=!0;break;case l.keys.A:l.moveLeft=!0;break;case l.keys.D:l.moveRight=!0;break;case l.keys.Q:l.rotLeft=!0;break;case l.keys.E:l.rotRight=!0;break;case l.keys.R:l.raiseCamera=!0;break;case l.keys.F:l.lowerCamera=!0}}function s(e){switch(l.shiftDown=e.shiftKey,e.keyCode){case l.keys.W:l.moveForward=!1;break;case l.keys.S:l.moveBackward=!1;break;case l.keys.A:l.moveLeft=!1;break;case l.keys.D:l.moveRight=!1;break;case l.keys.UP:l.moveForward=!1;break;case l.keys.BOTTOM:l.moveBackward=!1;break;case l.keys.LEFT:l.moveLeft=!1;break;case l.keys.RIGHT:l.moveRight=!1;break;case l.keys.Q:l.rotLeft=!1;break;case l.keys.E:l.rotRight=!1;break;case l.keys.R:l.raiseCamera=!1;break;case l.keys.F:l.lowerCamera=!1}}this.object=e,this.domElement=void 0!==t?t:document,this.enabled=!0,this.track=null,this.trackPos=0,this.rotateSpeed=1,this.moveSpeed=10,this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40,A:"A".charCodeAt(0),S:"S".charCodeAt(0),D:"D".charCodeAt(0),W:"W".charCodeAt(0),Q:"Q".charCodeAt(0),E:"E".charCodeAt(0),R:"R".charCodeAt(0),F:"F".charCodeAt(0)};var l=this,d=new THREE.Vector2,c=new THREE.Vector2,u=new THREE.Vector2,p=new THREE.Vector2,h=new THREE.Vector2,m=new THREE.Vector2,f=new THREE.Vector3,g=(new THREE.Vector3,0),v=0,y=1,E=new THREE.Vector3;this.shiftDown=!1;var T=new THREE.Vector3,b={NONE:-1,ROTATE:0,SPEEDCHANGE:1,PAN:2},P=b.NONE;this.position0=this.object.position.clone();var R={type:"change"},x={type:"start"},w={type:"end"};this.setTrack=function(e){this.track!==e&&(this.track=e,this.trackPos=null)},this.setTrackPos=function(e,t){var o=Math.max(0,Math.min(1,e)),i=this.trackPos||o,n=this.track.getTangentAt(o),r=this.track.getTangentAt(i);if(n.equals(r));else{var a=(new THREE.Vector3).crossVectors(r,n).normalize(),s=r.angleTo(n),d=(new THREE.Matrix4).makeRotationAxis(a,s),c=this.object.getWorldDirection().clone();c=c.applyMatrix4(d);var u=(new THREE.Vector3).addVectors(this.object.position,c);this.object.lookAt(u),this.object.updateMatrixWorld();var p={type:"path_relative_rotation",angle:s,axis:a,controls:l};this.dispatchEvent(p)}if(null===this.trackPos){var u=(new THREE.Vector3).addVectors(this.object.position,n);this.object.lookAt(u)}if(this.trackPos=o,o!==i){var p={type:"move",translation:E.clone()};this.dispatchEvent(p)}},this.getTrackPos=function(){return this.trackPos},this.rotateLeft=function(e){v-=e},this.rotateUp=function(e){g-=e},this.panLeft=function(e){var t=this.object.matrix.elements;f.set(t[0],t[1],t[2]),f.multiplyScalar(-e),E.add(f)},this.panUp=function(e){var t=this.object.matrix.elements;f.set(t[4],t[5],t[6]),f.multiplyScalar(e),E.add(f)},this.panForward=function(e){if(this.track)this.setTrackPos(this.getTrackPos()-e/this.track.getLength());else{var t=this.object.matrix.elements;f.set(t[8],t[9],t[10]),f.multiplyScalar(e),E.add(f)}},this.pan=function(e,t){var o=l.domElement===document?l.domElement.body:l.domElement;if(void 0!==l.object.fov){var i=l.object.position,n=i.clone(),r=n.length();r*=Math.tan(l.object.fov/2*Math.PI/180),l.panLeft(2*e*r/o.clientHeight),l.panUp(2*t*r/o.clientHeight)}else void 0!==l.object.top?(l.panLeft(e*(l.object.right-l.object.left)/o.clientWidth),l.panUp(t*(l.object.top-l.object.bottom)/o.clientHeight)):console.warn("WARNING: GeoControls.js encountered an unknown camera type - pan disabled.")},this.update=function(e){this.object.rotation.order="ZYX";var t=this.object;this.object=new THREE.Object3D,this.object.position.copy(t.position),this.object.rotation.copy(t.rotation),this.object.updateMatrix(),this.object.updateMatrixWorld();var o=this.object.position;if(void 0!==e){var i=l.shiftDown?4:1;this.moveRight&&this.panLeft(-e*this.moveSpeed*i),this.moveLeft&&this.panLeft(e*this.moveSpeed*i),(this.moveForward||this.moveForwardMouse)&&this.panForward(-e*this.moveSpeed*i),this.moveBackward&&this.panForward(e*this.moveSpeed*i),this.rotLeft&&l.rotateLeft(-.5*Math.PI*e/l.rotateSpeed),this.rotRight&&l.rotateLeft(.5*Math.PI*e/l.rotateSpeed),this.raiseCamera&&l.panUp(e*this.moveSpeed*i),this.lowerCamera&&l.panUp(-e*this.moveSpeed*i)}if(!E.equals(new THREE.Vector3(0,0,0))){var n={type:"move",translation:E.clone()};this.dispatchEvent(n)}if(o.add(E),0!==v||0!==g){var n={type:"rotate",thetaDelta:v,phiDelta:g};this.dispatchEvent(n)}this.object.updateMatrix();var r=(new THREE.Matrix4).makeRotationY(v),a=(new THREE.Matrix4).multiplyMatrices(r,this.object.matrix);this.object.quaternion.setFromRotationMatrix(a),this.object.rotation.x+=g,this.object.updateMatrixWorld();var s={type:"proposeTransform",oldPosition:t.position,newPosition:this.object.position,objections:0,counterProposals:[]};if(this.dispatchEvent(s),s.objections>0&&s.counterProposals.length>0){var d=s.counterProposals;this.object.position.copy(d[0]),s.objections=0,s.counterProposals=[]}if(s.objections>0||t.position.copy(this.object.position),t.rotation.copy(this.object.rotation),this.object=t,v=0,g=0,y=1,E.set(0,0,0),T.distanceTo(this.object.position)>0&&(this.dispatchEvent(R),T.copy(this.object.position)),this.track){var c=this.track.getPointAt(this.trackPos);t.position.copy(c)}},this.reset=function(){P=b.NONE,this.object.position.copy(this.position0)},this.setMoveSpeed=function(e){l.moveSpeed!==e&&(l.moveSpeed=e,l.dispatchEvent({type:"move_speed_changed",controls:l}))},this.domElement.addEventListener("contextmenu",function(e){e.preventDefault()},!1),this.domElement.addEventListener("mousedown",o,!1),this.domElement.addEventListener("mousewheel",r,!1),this.domElement.addEventListener("DOMMouseScroll",r,!1),l.domElement.addEventListener("mousemove",i,!1),l.domElement.addEventListener("mouseup",n,!1),-1===this.domElement.tabIndex&&(this.domElement.tabIndex=2222),l.domElement.addEventListener("keydown",a,!1),l.domElement.addEventListener("keyup",s,!1)},Potree.GeoControls.prototype=Object.create(THREE.EventDispatcher.prototype),Potree.OrbitControls=function(e,t){function o(){return 2*Math.PI/60/60*p.autoRotateSpeed}function i(){return Math.pow(.95,p.zoomSpeed)}function n(e){if(p.enabled!==!1){if(e.preventDefault(),e.button===THREE.MOUSE.LEFT){if(p.noRotate===!0)return;A=M.ROTATE,m.set(e.clientX,e.clientY)}else if(e.button===THREE.MOUSE.MIDDLE){if(p.noZoom===!0)return;A=M.DOLLY,P.set(e.clientX,e.clientY)}else if(e.button===THREE.MOUSE.RIGHT){if(p.noPan===!0)return;A=M.PAN,v.set(e.clientX,e.clientY)}p.domElement.addEventListener("mousemove",r,!1),p.domElement.addEventListener("mouseup",a,!1),p.dispatchEvent(V)}}function r(e){if(p.enabled!==!1){e.preventDefault();var t=p.domElement===document?p.domElement.body:p.domElement;if(A===M.ROTATE){if(p.noRotate===!0)return;f.set(e.clientX,e.clientY),g.subVectors(f,m),p.rotateLeft(2*Math.PI*g.x/t.clientWidth*p.rotateSpeed),p.rotateUp(2*Math.PI*g.y/t.clientHeight*p.rotateSpeed),m.copy(f)}else if(A===M.DOLLY){if(p.noZoom===!0)return;R.set(e.clientX,e.clientY),x.subVectors(R,P),x.y>0?p.dollyIn():p.dollyOut(),P.copy(R)}else if(A===M.PAN){if(p.noPan===!0)return;y.set(e.clientX,e.clientY),E.subVectors(y,v),p.pan(E.x,E.y),v.copy(y)}}}function a(){p.enabled!==!1&&(p.domElement.removeEventListener("mousemove",r,!1),p.domElement.removeEventListener("mouseup",a,!1),p.dispatchEvent(L),A=M.NONE)}function s(e){if(p.enabled!==!1&&p.noZoom!==!0){e.preventDefault();var t=0;void 0!==e.wheelDelta?t=e.wheelDelta:void 0!==e.detail&&(t=-e.detail),t>0?p.dollyOut():p.dollyIn(),p.dispatchEvent(V),p.dispatchEvent(L)}}function l(e){if(p.enabled!==!1&&p.noKeys!==!0&&p.noPan!==!0)switch(e.keyCode){case p.keys.UP:p.pan(0,p.keyPanSpeed);break;case p.keys.BOTTOM:p.pan(0,-p.keyPanSpeed);break;case p.keys.LEFT:p.pan(p.keyPanSpeed,0);break;case p.keys.RIGHT:p.pan(-p.keyPanSpeed,0)}}function d(e){if(p.enabled!==!1){switch(e.touches.length){case 1:if(p.noRotate===!0)return;A=M.TOUCH_ROTATE,m.set(e.touches[0].pageX,e.touches[0].pageY);break;case 2:if(p.noZoom===!0)return;A=M.TOUCH_DOLLY;var t=e.touches[0].pageX-e.touches[1].pageX,o=e.touches[0].pageY-e.touches[1].pageY,i=Math.sqrt(t*t+o*o);P.set(0,i);break;case 3:if(p.noPan===!0)return;A=M.TOUCH_PAN,v.set(e.touches[0].pageX,e.touches[0].pageY);break;default:A=M.NONE}p.dispatchEvent(V)}}function c(e){if(p.enabled!==!1){e.preventDefault(),e.stopPropagation();var t=p.domElement===document?p.domElement.body:p.domElement;switch(e.touches.length){case 1:if(p.noRotate===!0)return;if(A!==M.TOUCH_ROTATE)return;f.set(e.touches[0].pageX,e.touches[0].pageY),g.subVectors(f,m),p.rotateLeft(2*Math.PI*g.x/t.clientWidth*p.rotateSpeed),p.rotateUp(2*Math.PI*g.y/t.clientHeight*p.rotateSpeed),m.copy(f);break;case 2:if(p.noZoom===!0)return;if(A!==M.TOUCH_DOLLY)return;var o=e.touches[0].pageX-e.touches[1].pageX,i=e.touches[0].pageY-e.touches[1].pageY,n=Math.sqrt(o*o+i*i);R.set(0,n),x.subVectors(R,P);var r=t.clientWidth,a=t.clientHeight,s=Math.sqrt(r*r+a*a),l=x.y/s;x.y>0?p.dollyOut(1-l):p.dollyIn(1+l),P.copy(R);break;case 3:if(p.noPan===!0)return;if(A!==M.TOUCH_PAN)return;y.set(e.touches[0].pageX,e.touches[0].pageY),E.subVectors(y,v),p.pan(E.x,E.y),v.copy(y);break;default:A=M.NONE}}}function u(){p.enabled!==!1&&(p.dispatchEvent(L),A=M.NONE)}this.object=e,this.domElement=void 0!==t?t:document,this.enabled=!0,this.target=new THREE.Vector3,this.center=this.target,this.noZoom=!1,this.zoomSpeed=1,this.minDistance=0,this.maxDistance=1/0,this.noRotate=!1,this.rotateSpeed=1,this.noPan=!1,this.keyPanSpeed=7,this.autoRotate=!1,this.autoRotateSpeed=2,this.fadeFactor=10,this.minPolarAngle=0,this.maxPolarAngle=Math.PI,this.noKeys=!1,this.keys={LEFT:37,UP:38,RIGHT:39,BOTTOM:40};var p=this,h=1e-6,m=new THREE.Vector2,f=new THREE.Vector2,g=new THREE.Vector2,v=new THREE.Vector2,y=new THREE.Vector2,E=new THREE.Vector2,T=new THREE.Vector3,b=new THREE.Vector3,P=new THREE.Vector2,R=new THREE.Vector2,x=new THREE.Vector2,w=0,C=0,S=1,H=new THREE.Vector3,B=new THREE.Vector3,M={NONE:-1,ROTATE:0,DOLLY:1,PAN:2,TOUCH_ROTATE:3,TOUCH_DOLLY:4,TOUCH_PAN:5},A=M.NONE;this.target0=this.target.clone(),this.position0=this.object.position.clone();var I={type:"change"},V={type:"start"},L={type:"end"};this.rotateLeft=function(e){void 0===e&&(e=o()),C-=e},this.rotateUp=function(e){void 0===e&&(e=o()),w-=e},this.panLeft=function(e){var t=this.object.matrix.elements;T.set(t[0],t[1],t[2]),T.multiplyScalar(-e),H.add(T)},this.panUp=function(e){var t=this.object.matrix.elements;T.set(t[4],t[5],t[6]),T.multiplyScalar(e),H.add(T)},this.pan=function(e,t){var o=p.domElement===document?p.domElement.body:p.domElement;if(void 0!==p.object.fov){var i=p.object.position,n=i.clone().sub(p.target),r=n.length();r*=Math.tan(p.object.fov/2*Math.PI/180),p.panLeft(2*e*r/o.clientHeight),p.panUp(2*t*r/o.clientHeight)}else void 0!==p.object.top?(p.panLeft(e*(p.object.right-p.object.left)/o.clientWidth),p.panUp(t*(p.object.top-p.object.bottom)/o.clientHeight)):console.warn("WARNING: OrbitControls.js encountered an unknown camera type - pan disabled.")},this.dollyIn=function(e){void 0===e&&(e=i()),S/=e},this.dollyOut=function(e){void 0===e&&(e=i()),S*=e},this.update=function(e){var t=this.object.position.clone();b.copy(t).sub(this.target);var i=Math.atan2(b.x,b.z),n=Math.atan2(Math.sqrt(b.x*b.x+b.z*b.z),b.y);this.autoRotate&&this.rotateLeft(o());var r=Math.min(1,this.fadeFactor*e);i+=r*C,n+=r*w,n=Math.max(this.minPolarAngle,Math.min(this.maxPolarAngle,n)),n=Math.max(h,Math.min(Math.PI-h,n));var a=b.length();a+=(S-1)*a*r,a=Math.max(this.minDistance,Math.min(this.maxDistance,a)),this.target.add(H.clone().multiplyScalar(r)),b.x=a*Math.sin(n)*Math.sin(i),b.y=a*Math.cos(n),b.z=a*Math.sin(n)*Math.cos(i),t.copy(this.target).add(b);var s={type:"proposeTransform",oldPosition:this.object.position,newPosition:t,objections:0,counterProposals:[]};if(this.dispatchEvent(s),s.objections>0&&s.counterProposals.length>0){var l=s.counterProposals;t.copy(l[0]),s.objections=0,s.counterProposals=[]}if(s.objections>0)C=0,w=0,S=1,H.set(0,0,0);else{this.object.position.copy(t),this.object.lookAt(this.target);var d=Math.max(0,1-this.fadeFactor*e);C*=d,w*=d,S=1+(S-1)*d,H.multiplyScalar(d)}B.distanceTo(this.object.position)>0&&(this.dispatchEvent(I),B.copy(this.object.position))},this.reset=function(){A=M.NONE,this.target.copy(this.target0),this.object.position.copy(this.position0),this.update()},this.domElement.addEventListener("contextmenu",function(e){e.preventDefault()},!1),this.domElement.addEventListener("mousedown",n,!1),this.domElement.addEventListener("mousewheel",s,!1),this.domElement.addEventListener("DOMMouseScroll",s,!1),this.domElement.addEventListener("touchstart",d,!1),this.domElement.addEventListener("touchend",u,!1),this.domElement.addEventListener("touchmove",c,!1),-1===this.domElement.tabIndex&&(this.domElement.tabIndex=2222),this.domElement.addEventListener("keydown",l,!1)},Potree.OrbitControls.prototype=Object.create(THREE.EventDispatcher.prototype),THREE.EarthControls=function(e,t,o){function i(e){if(s.enabled!==!1){e.preventDefault();var t=s.domElement.getBoundingClientRect(),o={x:(e.clientX-t.left)/s.domElement.clientWidth*2-1,y:2*-((e.clientY-t.top)/s.domElement.clientHeight)+1},i=getMousePointCloudIntersection(o,s.camera,s.renderer,s.pointclouds);if(i){var a=(new THREE.Plane).setFromNormalAndCoplanarPoint(new THREE.Vector3(0,1,0),i),p=new THREE.Vector3(o.x,o.y,.5);p.unproject(s.camera);var h=p.sub(s.camera.position).normalize(),m=new THREE.Ray(s.camera.position,h);g=m.intersectPlane(a),f=s.camera.clone(),f.rotation.copy(s.camera.rotation),c.set(e.clientX-t.left,e.clientY-t.top),u.set(e.clientX-t.left,e.clientY-t.top),s.scene.add(s.pivotNode),s.pivotNode.position.copy(g),e.button===THREE.MOUSE.LEFT?d=l.DRAG:e.button===THREE.MOUSE.RIGHT&&(d=l.ROTATE),s.domElement.addEventListener("mousemove",n,!1),s.domElement.addEventListener("mouseup",r,!1),s.dispatchEvent(v)}}}function n(e){if(s.enabled!==!1){e.preventDefault();var t=s.domElement.getBoundingClientRect();s.domElement===document?s.domElement.body:s.domElement;m.set(e.clientX-t.left-u.x,e.clientY-t.top-u.y),u.set(e.clientX-t.left,e.clientY-t.top)}}function r(){s.enabled!==!1&&(s.domElement.removeEventListener("mousemove",n,!1),s.domElement.removeEventListener("mouseup",r,!1),d=l.NONE,s.scene.remove(s.pivotNode),s.dispatchEvent(y))}function a(e){if(s.enabled!==!1&&s.noZoom!==!0){e.preventDefault();var t=s.domElement.getBoundingClientRect(),o=e.detail<0||e.wheelDelta>0?1:-1,i={x:(e.clientX-t.left)/s.domElement.clientWidth*2-1,y:2*-((e.clientY-t.top)/s.domElement.clientHeight)+1},n=getMousePointCloudIntersection(i,s.camera,s.renderer,s.pointclouds);if(n){var r=n.distanceTo(s.camera.position),a=(new THREE.Vector3).subVectors(n,s.camera.position).normalize();s.camera.position.add(a.multiplyScalar(.1*r*o))}s.dispatchEvent(v),s.dispatchEvent(y)}}this.camera=e,this.renderer=t,this.pointclouds=[],this.domElement=t.domElement,this.scene=o,this.enabled=!0;var s=this,l={NONE:-1,DRAG:0,ROTATE:1},d=l.NONE,c=new THREE.Vector2,u=new THREE.Vector2,p=new THREE.SphereGeometry(1,32,32),h=new THREE.MeshNormalMaterial({shading:THREE.SmoothShading,transparent:!0,opacity:.5});this.pivotNode=new THREE.Mesh(p,h);var m=new THREE.Vector2,f=null,g=null,v={type:"start"},y={type:"end"};this.minAngle=10/180*Math.PI,this.maxAngle=70/180*Math.PI,this.update=function(e){this.camera.position;this.camera.updateMatrixWorld();var t=new THREE.Object3D;if(t.position.copy(this.camera.position),t.rotation.copy(this.camera.rotation),t.updateMatrix(),t.updateMatrixWorld(),g){if(d===l.DRAG){var o=(new THREE.Plane).setFromNormalAndCoplanarPoint(new THREE.Vector3(0,1,0),g),i={x:u.x/this.domElement.clientWidth*2-1,y:2*-(u.y/this.domElement.clientHeight)+1},n=new THREE.Vector3(i.x,i.y,.5);n.unproject(f);var r=n.sub(f.position).normalize(),a=new THREE.Ray(f.position,r),s=a.distanceToPlane(o);if(s>0){var c=(new THREE.Vector3).subVectors(g,r.clone().multiplyScalar(s));t.position.copy(c)}}else if(d===l.ROTATE){var p=m.clone().multiplyScalar(e);p.x*=.3,p.y*=-.2;var h=new THREE.Object3D,v=new THREE.Object3D;h.add(v),h.position.copy(g),v.position.copy(this.camera.position).sub(g),v.rotation.copy(this.camera.rotation),h.rotation.y+=-p.x;var r=this.camera.getWorldDirection(),y=new THREE.Vector3(0,1,0),E=(new THREE.Vector3).crossVectors(y,r),T=v.position.clone();T.y=0,T.normalize();var b=T.dot(v.position.clone().normalize()),P=Math.acos(b);
v.position.y<0&&(P=-P);var R=0;R=p.y>0?p.y-Math.max(0,this.minAngle-(P-p.y)):p.y+Math.max(0,P-p.y-this.maxAngle),h.rotateOnAxis(E,-R),h.updateMatrixWorld(),t.position.copy(v.getWorldPosition()),t.quaternion.copy(v.getWorldQuaternion())}var x={type:"proposeTransform",oldPosition:this.camera.position,newPosition:t.position,objections:0};this.dispatchEvent(x),x.objections>0||(this.camera.position.copy(t.position),this.camera.rotation.copy(t.rotation));var w=this.pivotNode.getWorldPosition().applyMatrix4(this.camera.matrixWorldInverse),C=Math.abs(w.z/30),S=this.pivotNode.scale.length();this.pivotNode.scale.multiplyScalar(C/S)}m.set(0,0)},this.reset=function(){d=l.NONE,this.camera.position.copy(this.position0)},this.domElement.addEventListener("contextmenu",function(e){e.preventDefault()},!1),this.domElement.addEventListener("mousedown",i,!1),this.domElement.addEventListener("mousewheel",a,!1),this.domElement.addEventListener("DOMMouseScroll",a,!1)},THREE.EarthControls.prototype=Object.create(THREE.EventDispatcher.prototype),LRU.prototype.size=function(){return this.elements},LRU.prototype.contains=function(e){return null==this.items[e.id]},LRU.prototype.touch=function(e){if(e.loaded){var t;null==this.items[e.id]?(t=new LRUItem(e),t.previous=this.last,this.last=t,null!==t.previous&&(t.previous.next=t),this.items[e.id]=t,this.elements++,null===this.first&&(this.first=t),this.numPoints+=e.numPoints):(t=this.items[e.id],null===t.previous?null!==t.next&&(this.first=t.next,this.first.previous=null,t.previous=this.last,t.next=null,this.last=t,t.previous.next=t):null===t.next||(t.previous.next=t.next,t.next.previous=t.previous,t.previous=this.last,t.next=null,this.last=t,t.previous.next=t))}},LRU.prototype.remove=function(e){var t=this.items[e.id];t&&(1===this.elements?(this.first=null,this.last=null):(t.previous||(this.first=t.next,this.first.previous=null),t.next||(this.last=t.previous,this.last.next=null),t.previous&&t.next&&(t.previous.next=t.next,t.next.previous=t.previous)),delete this.items[e.id],this.elements--,this.numPoints-=e.numPoints)},LRU.prototype.getLRUItem=function(){if(null===this.first)return null;var e=this.first;return e.node},LRU.prototype.toString=function(){for(var e="{ ",t=this.first;null!==t;)e+=t.node.id,null!==t.next&&(e+=", "),t=t.next;return e+="}",e+="("+this.size()+")"},LRU.prototype.freeMemory=function(){if(!(this.elements<=1))for(;this.numPoints>Potree.pointLoadLimit;){var e=this.first,t=e.node;this.disposeDescendants(t)}},LRU.prototype.disposeDescendants=function(e){var t=[];for(t.push(e);t.length>0;){var o=t.pop();o.dispose(),this.remove(o);for(var i in o.children)if(o.children.hasOwnProperty(i)){var n=o.children[i];n.loaded&&t.push(o.children[i])}}},Potree.Annotation=function(e,t){var o=this;Potree.Annotation.counter++,this.viewer=e,this.ordinal=t.title||Potree.Annotation.counter,this.title=t.title||"No Title",this.description=t.description||"",this.scene=t.scene||null,this.position=t.position||new THREE.Vector3(0,0,0),this.cameraPosition=t.cameraPosition,this.cameraTarget=t.cameraTarget||this.position,this.view=t.view||null,this.keepOpen=!1,this.descriptionVisible=!1,this.domElement=document.createElement("div"),this.domElement.style.position="absolute",this.domElement.style.opacity="0.5",this.domElement.style.padding="10px",this.domElement.style.whiteSpace="nowrap",this.domElement.className="annotation",this.elOrdinal=document.createElement("div"),this.elOrdinal.style.position="relative",this.elOrdinal.style.color="white",this.elOrdinal.style.backgroundColor="black",this.elOrdinal.style.borderRadius="1.5em",this.elOrdinal.style.fontSize="1em",this.elOrdinal.style.opacity="1",this.elOrdinal.style.margin="auto",this.elOrdinal.style.zIndex="100",this.elOrdinal.style.width="fit-content",this.domElement.appendChild(this.elOrdinal),this.domDescription=document.createElement("div"),this.domDescription.style.position="relative",this.domDescription.style.color="white",this.domDescription.style.backgroundColor="black",this.domDescription.style.padding="10px",this.domDescription.style.margin="5px 0px 0px 0px",this.domDescription.style.borderRadius="4px",this.domDescription.style.display="none",this.domDescription.className="annotation",this.domElement.appendChild(this.domDescription),this.elOrdinal.onmouseenter=function(){},this.elOrdinal.onmouseleave=function(){},this.elOrdinal.onclick=function(){o.moveHere(o.viewer.camera),o.dispatchEvent({type:"click",target:o}),o.viewer.geoControls&&o.viewer.geoControls.setTrack(null)},this.elOrdinalText=document.createElement("span"),this.elOrdinalText.style.display="inline-block",this.elOrdinalText.style.verticalAlign="middle",this.elOrdinalText.style.lineHeight="1.5em",this.elOrdinalText.style.textAlign="center",this.elOrdinalText.style.fontFamily="Arial",this.elOrdinalText.style.fontWeight="bold",this.elOrdinalText.style.padding="1px 8px 0px 8px",this.elOrdinalText.style.cursor="default",this.elOrdinalText.innerHTML=this.ordinal,this.elOrdinalText.userSelect="none",this.elOrdinal.appendChild(this.elOrdinalText),this.elDescriptionText=document.createElement("span"),this.elDescriptionText.style.color="#ffffff",this.elDescriptionText.innerHTML=this.description,this.domDescription.appendChild(this.elDescriptionText),this.domElement.onmouseenter=function(){o.domElement.style.opacity="0.8",o.domElement.style.zIndex="1000",o.description&&(o.descriptionVisible=!0,o.domDescription.style.display="block")},this.domElement.onmouseleave=function(){o.domElement.style.opacity="0.5",o.domElement.style.zIndex="100",o.descriptionVisible=!0,o.domDescription.style.display="none"},this.moveHere=function(e){var t=800,i=TWEEN.Easing.Quartic.Out,n=new TWEEN.Tween(e.position).to(o.cameraPosition,t);n.easing(i),n.start();var r=e.position.distanceTo(o.cameraTarget),a=(new THREE.Vector3).addVectors(e.position,e.getWorldDirection().clone().multiplyScalar(r)),n=new TWEEN.Tween(a).to(o.cameraTarget,t);n.easing(i),n.onUpdate(function(){e.lookAt(a),o.viewer.orbitControls.target.copy(a)}),n.onComplete(function(){e.lookAt(a),o.viewer.orbitControls.target.copy(a),o.dispatchEvent({type:"focusing_finished",target:o})}),o.dispatchEvent({type:"focusing_started",target:o}),n.start()},this.dispose=function(){this.domElement.parentElement&&this.domElement.parentElement.removeChild(this.domElement)}},Potree.Annotation.prototype=Object.create(THREE.EventDispatcher.prototype),Potree.Annotation.counter=0,Potree.ProfileData=function(e){this.profile=e,this.segments=[],this.boundingBox=new THREE.Box3,this.projectedBoundingBox=new THREE.Box2;for(var t=new THREE.Vector3,o=0;o<e.points.length-1;o++){var i=e.points[o],n=e.points[o+1],r=new THREE.Vector3(i.x,0,i.z),a=new THREE.Vector3(n.x,0,n.z),s=(new THREE.Vector3).addVectors(a,r).multiplyScalar(.5),l=r.distanceTo(a),d=(new THREE.Vector3).subVectors(a,r).normalize(),c=new THREE.Vector3(0,1,0),u=(new THREE.Vector3).crossVectors(d,c).normalize(),p=u,h=(new THREE.Plane).setFromNormalAndCoplanarPoint(p,r),m=(new THREE.Plane).setFromNormalAndCoplanarPoint(d,s),f=function(e,t,o){var i=e,n=t,r=o,a=new THREE.Vector3(1,0,0),s=(new THREE.Vector3).subVectors(n,i);s.y=0,s.normalize();var l=Math.acos(a.dot(s));return s.z>0&&(l=-l),function(e){var t=(new THREE.Matrix4).makeTranslation(-i.x,0,-i.z),o=(new THREE.Matrix4).makeRotationY(-l),n=(new THREE.Matrix4).makeTranslation(r.x,0,0),a=e.clone();return a.applyMatrix4(t),a.applyMatrix4(o),a.applyMatrix4(n),a}}(i,n,t.clone()),g={start:i,end:n,cutPlane:h,halfPlane:m,length:l,points:null,project:f};this.segments.push(g),t.x+=l,t.y+=n.y-i.y}this.projectedBoundingBox.min.x=0,this.projectedBoundingBox.min.y=Number.POSITIVE_INFINITY,this.projectedBoundingBox.max.x=t.x,this.projectedBoundingBox.max.y=Number.NEGATIVE_INFINITY,this.size=function(){for(var e=0,t=0;t<this.segments.length;t++)this.segments[t].points&&(e+=this.segments[t].points.numPoints);return e}},Potree.ProfileRequest=function(e,t,o,i){this.pointcloud=e,this.profile=t,this.maxDepth=o||Number.MAX_VALUE,this.callback=i,this.temporaryResult=new Potree.ProfileData(this.profile),this.pointsServed=0,this.priorityQueue=new BinaryHeap(function(e){return 1/e.weight}),this.initialize=function(){this.priorityQueue.push({node:e.pcoGeometry.root,weight:1}),this.traverse(e.pcoGeometry.root)},this.traverse=function(t){for(var o=[],i=0;8>i;i++){var n=t.children[i];n&&e.nodeIntersectsProfile(n,this.profile)&&o.push(n)}for(;o.length>0;){var t=o.pop(),r=t.boundingSphere.radius;if(this.priorityQueue.push({node:t,weight:r}),t.level<this.maxDepth)for(var i=0;8>i;i++){var n=t.children[i];n&&e.nodeIntersectsProfile(n,this.profile)&&o.push(n)}}},this.update=function(){for(var t=[],o=0;o<Math.min(2,this.priorityQueue.size());o++){var n=this.priorityQueue.pop(),r=n.node;r.loaded?(t.push(r),Potree.getLRU().touch(r),r.level%r.pcoGeometry.hierarchyStepSize===0&&r.hasChildren&&this.traverse(r)):(r.load(),this.priorityQueue.push(n))}if(t.length>0&&(this.getPointsInsideProfile(t,this.temporaryResult),this.temporaryResult.size()>100&&(this.pointsServed+=this.temporaryResult.size(),i.onProgress({request:this,points:this.temporaryResult}),this.temporaryResult=new Potree.ProfileData(this.profile))),0===this.priorityQueue.size()){this.temporaryResult.size()>0&&(this.pointsServed+=this.temporaryResult.size(),i.onProgress({request:this,points:this.temporaryResult}),this.temporaryResult=new Potree.ProfileData(this.profile)),i.onFinish({request:this});var a=e.profileRequests.indexOf(this);a>=0&&e.profileRequests.splice(a,1)}},this.getPointsInsideProfile=function(o,i){for(var n=0;n<i.segments.length;n++){for(var r=i.segments[n],a=0;a<o.length;a++){var s=o[a],l=s.geometry,d=l.attributes.position,c=d.array,u=s.numPoints;if(!r.points){r.points={},r.points.boundingBox=new THREE.Box3;for(var p in l.attributes)l.attributes.hasOwnProperty(p)&&("indices"===p||(r.points[p]=[]))}for(var h=0;u>h;h++){var m=new THREE.Vector3(c[3*h],c[3*h+1],c[3*h+2]);m.applyMatrix4(e.matrixWorld);var f=Math.abs(r.cutPlane.distanceToPoint(m)),g=Math.abs(r.halfPlane.distanceToPoint(m));if(f<t.width/2&&g<r.length/2){r.points.boundingBox.expandByPoint(m);for(var p in l.attributes)if(l.attributes.hasOwnProperty(p))if("position"===p)r.points[p].push(m);else if("indices"===p);else{var v=l.attributes[p];if(1===v.itemSize)r.points[p].push(v.array[h]);else{for(var y=[],E=0;E<v.itemSize;E++)y.push(v.array[h*v.itemSize+E]);r.points[p].push(y)}}}else;}}r.points.numPoints=r.points.position.length,r.points.numPoints>0&&(i.boundingBox.expandByPoint(r.points.boundingBox.min),i.boundingBox.expandByPoint(r.points.boundingBox.max),i.projectedBoundingBox.expandByPoint(new THREE.Vector2(0,i.boundingBox.min.y)),i.projectedBoundingBox.expandByPoint(new THREE.Vector2(0,i.boundingBox.max.y)))}},this.cancel=function(){i.onCancel(),this.priorityQueue=new BinaryHeap(function(e){return 1/e.weight});var t=e.profileRequests.indexOf(this);t>=0&&e.profileRequests.splice(t,1)},this.initialize()},Potree.PointCloudOctreeNode=function(){this.children={},this.sceneNode=null,this.octree=null,this.getNumPoints=function(){return this.geometryNode.numPoints},this.isLoaded=function(){return!0},this.isTreeNode=function(){return!0},this.isGeometryNode=function(){return!1},this.getLevel=function(){return this.geometryNode.level},this.getBoundingSphere=function(){return this.geometryNode.boundingSphere},this.getBoundingBox=function(){return this.geometryNode.boundingBox},this.getChildren=function(){for(var e=[],t=0;8>t;t++)this.children[t]&&e.push(this.children[t]);return e}},Potree.PointCloudOctreeNode.prototype=Object.create(Potree.PointCloudTreeNode.prototype),Potree.PointCloudOctree=function(e,t){Potree.PointCloudTree.call(this),this.pcoGeometry=e,this.boundingBox=this.pcoGeometry.tightBoundingBox,this.boundingSphere=this.boundingBox.getBoundingSphere(),this.material=t||new Potree.PointCloudMaterial,this.visiblePointsTarget=2e6,this.minimumNodePixelSize=150,this.level=0,this.position.sub(e.offset),this.updateMatrix(),this.showBoundingBox=!1,this.boundingBoxNodes=[],this.loadQueue=[],this.visibleBounds=new THREE.Box3,this.visibleNodes=[],this.visibleGeometry=[],this.pickTarget=null,this.generateDEM=!1,this.profileRequests=[],this.name="",this.projection=e.projection,this.root=this.pcoGeometry.root},Potree.PointCloudOctree.prototype=Object.create(Potree.PointCloudTree.prototype),Potree.PointCloudOctree.prototype.setName=function(e){this.name!==e&&(this.name=e,this.dispatchEvent({type:"name_changed",name:e,pointcloud:this}))},Potree.PointCloudOctree.prototype.getName=function(){return this.name},Potree.PointCloudOctree.prototype.toTreeNode=function(e,t){var o=new Potree.PointCloudOctreeNode,i=new THREE.PointCloud(e.geometry,pointcloud.material);o.geometryNode=e,o.sceneNode=i,o.pointcloud=pointcloud,o.children={};for(var n in e.children)o.children[n]=e.children[n];if(t){var r=parseInt(e.name[e.name.length-1]);t.sceneNode.add(i),t.children[r]=o}else this.root=o,this.add(i);var a=function(){var i=parseInt(e.name[e.name.length-1]);t.sceneNode.remove(o.sceneNode),t.children[i]=e};return e.oneTimeDisposeHandlers.push(a),o},Potree.PointCloudOctree.prototype.updateVisibleBounds=function(){for(var e=[],t=0;t<this.visibleNodes.length;t++){for(var o=this.visibleNodes[t],i=!0,n=0;n<o.children.length;n++){var r=o.children[n];r instanceof Potree.PointCloudOctreeNode?i=i&&!r.sceneNode.visible:r instanceof Potree.PointCloudOctreeGeometryNode&&(i=!0)}i&&e.push(o)}this.visibleBounds.min=new THREE.Vector3(1/0,1/0,1/0),this.visibleBounds.max=new THREE.Vector3(-(1/0),-(1/0),-(1/0));for(var t=0;t<e.length;t++){var o=e[t];this.visibleBounds.expandByPoint(o.getBoundingBox().min),this.visibleBounds.expandByPoint(o.getBoundingBox().max)}},Potree.PointCloudOctree.prototype.updateMaterial=function(e,t,o,i){e.fov=o.fov*(Math.PI/180),e.screenWidth=i.domElement.clientWidth,e.screenHeight=i.domElement.clientHeight,e.spacing=this.pcoGeometry.spacing,e.near=o.near,e.far=o.far,e.uniforms.octreeSize.value=this.pcoGeometry.boundingBox.size().x,e.pointSizeType>=0&&(e.pointSizeType===Potree.PointSizeType.ADAPTIVE||e.pointColorType===Potree.PointColorType.LOD)&&this.updateVisibilityTexture(e,t)},Potree.PointCloudOctree.prototype.updateVisibilityTexture=function(e,t){if(e){var o=e.visibleNodesTexture,i=o.image.data;t=t.slice();var n=function(e,t){var o=e.geometryNode.name,i=t.geometryNode.name;return o.length!=i.length?o.length-i.length:i>o?-1:o>i?1:0};t.sort(n);for(var r=0;r<t.length;r++){for(var a=t[r],s=[],l=0;8>l;l++){var d=a.children[l];d instanceof Potree.PointCloudOctreeNode&&d.sceneNode.visible&&t.indexOf(d)>=0&&s.push(d)}s.sort(function(e,t){return e.geometryNode.name<t.geometryNode.name?-1:e.geometryNode.name>t.geometryNode.name?1:0}),i[3*r+0]=0,i[3*r+1]=0,i[3*r+2]=0;for(var l=0;l<s.length;l++){var d=s[l],c=parseInt(d.geometryNode.name.substr(-1));if(i[3*r+0]+=Math.pow(2,c),0===l){var u=t.indexOf(d);i[3*r+1]=u-r}}}o.needsUpdate=!0}},Potree.PointCloudOctree.prototype.nodeIntersectsProfile=function(e,t){for(var o=e.boundingBox.clone().applyMatrix4(this.matrixWorld),i=o.getBoundingSphere(),n=0;n<t.points.length-1;n++){var r=new THREE.Vector3(t.points[n].x,i.center.y,t.points[n].z),a=new THREE.Vector3(t.points[n+1].x,i.center.y,t.points[n+1].z),s=new THREE.Ray(r,(new THREE.Vector3).subVectors(a,r).normalize()),l=new THREE.Ray(a,(new THREE.Vector3).subVectors(r,a).normalize());if(s.isIntersectionSphere(i)&&l.isIntersectionSphere(i))return!0}return!1},Potree.PointCloudOctree.prototype.nodesOnRay=function(e,t){for(var o=[],i=t.clone(),n=0;n<e.length;n++){var r=e[n],a=r.getBoundingSphere().clone().applyMatrix4(r.sceneNode.matrixWorld);i.isIntersectionSphere(a)&&o.push(r)}return o},Potree.PointCloudOctree.prototype.updateMatrixWorld=function(e){this.matrixAutoUpdate===!0&&this.updateMatrix(),(this.matrixWorldNeedsUpdate===!0||e===!0)&&(void 0===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1,e=!0)},Potree.PointCloudOctree.prototype.hideDescendants=function(e){for(var t=[],o=0;o<e.children.length;o++){var i=e.children[o];i.visible&&t.push(i)}for(;t.length>0;){var e=t.shift();e.visible=!1;for(var o=0;o<e.children.length;o++){var i=e.children[o];i.visible&&t.push(i)}}},Potree.PointCloudOctree.prototype.moveToOrigin=function(){this.position.set(0,0,0),this.updateMatrixWorld(!0);var e=this.boundingBox,t=this.matrixWorld,o=Potree.utils.computeTransformedBoundingBox(e,t);this.position.set(0,0,0).sub(o.center())},Potree.PointCloudOctree.prototype.moveToGroundPlane=function(){this.updateMatrixWorld(!0);var e=this.boundingBox,t=this.matrixWorld,o=Potree.utils.computeTransformedBoundingBox(e,t);this.position.y+=-o.min.y},Potree.PointCloudOctree.prototype.getBoundingBoxWorld=function(){this.updateMatrixWorld(!0);var e=this.boundingBox,t=this.matrixWorld,o=Potree.utils.computeTransformedBoundingBox(e,t);return o},Potree.PointCloudOctree.prototype.getPointsInProfile=function(e,t,o){if(o){var i=new Potree.ProfileRequest(this,e,t,o);return this.profileRequests.push(i),i}for(var n={segments:[],boundingBox:new THREE.Box3,projectedBoundingBox:new THREE.Box2},r=0;r<e.points.length-1;r++){var a=e.points[r],s=e.points[r+1],l=this.getProfile(a,s,e.width,t),d={start:a,end:s,points:l,project:null};n.segments.push(d),n.boundingBox.expandByPoint(l.boundingBox.min),n.boundingBox.expandByPoint(l.boundingBox.max)}for(var c=new THREE.Vector3,r=0;r<n.segments.length;r++){var d=n.segments[r],a=d.start,s=d.end,u=function(e,t,o,i){var n=e,r=t,a=o,s=i,l=new THREE.Vector3(1,0,0),d=(new THREE.Vector3).subVectors(r,n);d.y=0,d.normalize();var c=Math.acos(l.dot(d));return d.z>0&&(c=-c),function(e){var t=(new THREE.Matrix4).makeTranslation(-n.x,-s.min.y,-n.z),o=(new THREE.Matrix4).makeRotationY(-c),i=(new THREE.Matrix4).makeTranslation(a.x,0,0),r=e.clone();return r.applyMatrix4(t),r.applyMatrix4(o),r.applyMatrix4(i),r}}(a,s,c.clone(),n.boundingBox.clone());d.project=u,c.x+=new THREE.Vector3(a.x,0,a.z).distanceTo(new THREE.Vector3(s.x,0,s.z)),c.y+=s.y-a.y}return n.projectedBoundingBox.min.x=0,n.projectedBoundingBox.min.y=n.boundingBox.min.y,n.projectedBoundingBox.max.x=c.x,n.projectedBoundingBox.max.y=n.boundingBox.max.y,n},Potree.PointCloudOctree.prototype.getProfile=function(e,t,o,i,n){if(void 0===n){var r=[];r.push(this);for(var a=(new THREE.Vector3).addVectors(t,e).multiplyScalar(.5),s=(new THREE.Vector3).subVectors(t,e).length(),l=(new THREE.Vector3).subVectors(t,e).normalize(),d=new THREE.Vector3(0,1,0),c=(new THREE.Vector3).crossVectors(l,d).normalize(),u=c,p=(new THREE.Plane).setFromNormalAndCoplanarPoint(u,e),h=(new THREE.Plane).setFromNormalAndCoplanarPoint(l,a),m=null,f=new THREE.Box3;r.length>0;){var g=r.shift(),v=0;if(g instanceof THREE.PointCloud){var y=g.geometry,E=y.attributes.position,T=E.array,b=g.numPoints;if(!m){m={};for(var P in y.attributes)y.attributes.hasOwnProperty(P)&&("indices"===P||(m[P]=[]))}for(var R=0;b>R;R++){var x=new THREE.Vector3(T[3*R],T[3*R+1],T[3*R+2]);x.applyMatrix4(this.matrixWorld);var w=Math.abs(p.distanceToPoint(x)),C=Math.abs(h.distanceToPoint(x));if(o/2>w&&s/2>C){f.expandByPoint(x);for(var P in y.attributes)if(y.attributes.hasOwnProperty(P))if("position"===P)m[P].push(x);else if("indices"===P);else{var S=y.attributes[P];if(1===S.itemSize)m[P].push(S.array[R+B]);else{for(var H=[],B=0;B<S.itemSize;B++)H.push(S.array[R*S.itemSize+B]);m[P].push(H)}}v++}}}if(g==this||g.level<i)for(var R=0;R<g.children.length;R++){var M=g.children[R];if(M instanceof THREE.PointCloud){var A=M.boundingSphere.clone().applyMatrix4(M.matrixWorld);p.distanceToSphere(A)<A.radius&&r.push(M)}}}m.numPoints=m.position.length;var I=function(e,t){var o=e,i=t,n=new THREE.Vector3(1,0,0),r=(new THREE.Vector3).subVectors(i,o);r.y=0,r.normalize();var a=Math.acos(n.dot(r));return r.z>0&&(a=-a),function(e){var t=(new THREE.Matrix4).makeTranslation(-o.x,-o.y,-o.z),i=(new THREE.Matrix4).makeRotationY(-a),n=e.clone();return n.applyMatrix4(t),n.applyMatrix4(i),n}}(e,t);return m.project=I,m.boundingBox=f,m}var V=new Potree.ProfileRequest(e,t,o,i,n);this.profileRequests.push(V)},Potree.PointCloudOctree.prototype.getVisibleExtent=function(){return this.visibleBounds.applyMatrix4(this.matrixWorld)},Potree.PointCloudOctree.prototype.pick=function(e,t,o,i){var i=i||{},n=i.pickWindowSize||17,r=i.pickOutsideClipRegion||!1,a=this.nodesOnRay(this.visibleNodes,o);if(0===a.length)return null;var s=Math.ceil(e.domElement.clientWidth),l=Math.ceil(e.domElement.clientHeight),d=(new THREE.Vector3).addVectors(t.position,o.direction).project(t);d.addScalar(1).multiplyScalar(.5),d.x*=s,d.y*=l,this.pickTarget?(this.pickTarget.width!=s||this.pickTarget.height!=l)&&(this.pickTarget.dispose(),this.pickTarget=new THREE.WebGLRenderTarget(1,1,{minFilter:THREE.LinearFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat})):this.pickTarget=new THREE.WebGLRenderTarget(1,1,{minFilter:THREE.LinearFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat}),this.pickTarget.setSize(s,l),this.pickMaterial||(this.pickMaterial=new Potree.PointCloudMaterial,this.pickMaterial.pointColorType=Potree.PointColorType.POINT_INDEX),this.pickMaterial.pointSizeType=this.material.pointSizeType,this.pickMaterial.size=this.material.size,this.pickMaterial.pointShape=this.material.pointShape,this.pickMaterial.interpolate=this.material.interpolate,this.pickMaterial.minSize=this.material.minSize+2,this.pickMaterial.maxSize=this.material.maxSize,this.pickMaterial.classification=this.material.classification,r?this.pickMaterial.clipMode=Potree.ClipMode.DISABLED:(this.pickMaterial.clipMode=this.material.clipMode,this.material.clipMode===Potree.ClipMode.CLIP_OUTSIDE?this.pickMaterial.setClipBoxes(this.material.clipBoxes):this.pickMaterial.setClipBoxes([])),this.updateMaterial(this.pickMaterial,a,t,e);var c=e.context;c.enable(c.SCISSOR_TEST),c.scissor(d.x-(n-1)/2,d.y-(n-1)/2,n,n),c.disable(c.SCISSOR_TEST);var u=this.pickMaterial;e.setRenderTarget(this.pickTarget),e.state.setDepthTest(u.depthTest),e.state.setDepthWrite(u.depthWrite),e.state.setBlending(THREE.NoBlending),e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil),a.length>0&&a.push(a[0]);for(var p=0;p<a.length;p++){var h=a[p].sceneNode,m=h.geometry;if(m.attributes.indices.buffer){if(u.pcIndex=p+1,u.program){var f=u.program.program;c.useProgram(f);var g=c.getAttribLocation(f,"indices"),v=4;c.bindBuffer(c.ARRAY_BUFFER,m.attributes.indices.buffer),c.enableVertexAttribArray(g),c.vertexAttribPointer(g,v,c.UNSIGNED_BYTE,!0,0,0),c.uniform1f(u.program.uniforms.pcIndex,u.pcIndex)}e.renderBufferDirect(t,[],null,u,m,h);var f=u.program.program;c.useProgram(f);var g=c.getAttribLocation(f,"indices");c.disableVertexAttribArray(g)}}var y=n*n,E=new ArrayBuffer(4*y),T=new Uint8Array(E),b=new Uint32Array(E);e.context.readPixels(d.x-(n-1)/2,d.y-(n-1)/2,n,n,e.context.RGBA,e.context.UNSIGNED_BYTE,T);for(var P=Number.MAX_VALUE,R=null,x=0;n>x;x++)for(var w=0;n>w;w++){var C=x+w*n,S=Math.pow(x-(n-1)/2,2)+Math.pow(w-(n-1)/2,2),H=T[4*C+3];T[4*C+3]=0;var B=b[C];(0!==B||0!==H)&&P>S&&(R={pIndex:B,pcIndex:H-1},P=S)}if(R){var M={},A=a[R.pcIndex].sceneNode,I=A.geometry.attributes;for(var V in I)if(I.hasOwnProperty(V)){var L=A.geometry.attributes[V];if("position"===V){var N=L.array,D=N[3*R.pIndex+0],z=N[3*R.pIndex+1],G=N[3*R.pIndex+2],_=new THREE.Vector3(D,z,G);_.applyMatrix4(this.matrixWorld),M[V]=_}else if("indices"===V);else if(1===L.itemSize)M[V]=L.array[R.pIndex];else{for(var k=[],O=0;O<L.itemSize;O++)k.push(L.array[L.itemSize*R.pIndex+O]);M[V]=k}}return M}return null};var demTime=0;Potree.PointCloudOctree.prototype.createDEM=function(e){for(var t=(new Date).getTime(),o=e.sceneNode,i=o.matrixWorld,n=o.boundingBox.clone().applyMatrix4(i),r=n.size(),a=o.geometry.attributes.position.array,s=64,l=new Array(s*s),d=new Float32Array(s*s),c=a.length/3,u=0;c>u;u++){var p=a[3*u+0],h=a[3*u+1],m=a[3*u+2],f=new THREE.Vector3(p,h,m).applyMatrix4(i),g=parseInt(s*(f.x-n.min.x)/r.x),v=parseInt(s*(f.z-n.min.z)/r.z);g=Math.min(g,s-1),v=Math.min(v,s-1);var y=g+v*s;l[y]||(l[y]=[]),l[y].push(f.y)}for(var u=0;u<l.length;u++){var E=l[u];if(E)if(0===E.length)d[u]=0;else{var T=parseInt((E.length-1)/2);d[u]=E[T]}else d[u]=0}var b=new THREE.Box2;b.expandByPoint(new THREE.Vector3(n.min.x,n.min.z)),b.expandByPoint(new THREE.Vector3(n.max.x,n.max.z));var P={boundingBox:n,boundingBox2D:b,dem:d,demSize:s},R=(new Date).getTime(),x=R-t;return demTime+=x,P},Potree.PointCloudOctree.prototype.getDEMHeight=function(e){var t=new THREE.Vector2(e.x,e.z),o=function(e){var o=e.demSize,i=e.boundingBox2D;i.containsPoint(t);if(i.containsPoint(t)){var n=t.clone().sub(i.min).divide(i.size()),r=n.clone().multiplyScalar(o),a=0;if(r.x>.5&&r.x<o-.5&&r.y>.5&&r.y<o-.5){var s=Math.floor(r.x-.5),l=Math.floor(r.y-.5);s=s===o-1?o-2:s,l=l===o-1?o-2:l;var d=r.x-s-.5,c=r.y-l-.5,u=s+l*o,p=s+1+l*o,h=s+(l+1)*o,m=s+1+(l+1)*o,f=e.dem[u],g=e.dem[p],v=e.dem[h],y=e.dem[m];if(0===f||0===g||0===v||0===y)a=null;else{var E=f*(1-d)+g*d,T=v*(1-d)+y*d;a=E*(1-c)+T*c}}else{r.x=Math.min(parseInt(Math.min(r.x,o)),o-1),r.y=Math.min(parseInt(Math.min(r.y,o)),o-1);var b=r.x+r.y*o;a=e.dem[b]}return a}return null},i=null,n=[];for(this.root.dem&&n.push(this.root);n.length>0;){var r=n.shift(),a=r.dem,s=(a.demSize,a.boundingBox2D),l=s.containsPoint(t);if(l){var d=o(a);if(i?null!=d&&d>0&&(i=d):i=d,r.level<=6)for(var c=0;8>c;c++){var u=r.children[c];"undefined"!=typeof u&&"undefined"!=typeof u.dem&&n.push(u)}}}return i},Object.defineProperty(Potree.PointCloudOctree.prototype,"progress",{get:function(){return this.visibleNodes.length/this.visibleGeometry.length}});var nodesLoadTimes={};Potree.PointCloudOctreeGeometry=function(){this.url=null,this.octreeDir=null,this.spacing=0,this.boundingBox=null,this.root=null,this.numNodesLoading=0,this.nodes=null,this.pointAttributes=null,this.hierarchyStepSize=-1,this.loader=null},Potree.PointCloudOctreeGeometryNode=function(e,t,o){this.id=Potree.PointCloudOctreeGeometryNode.IDCount++,this.name=e,this.index=parseInt(e.charAt(e.length-1)),this.pcoGeometry=t,this.geometry=null,this.boundingBox=o,this.boundingSphere=o.getBoundingSphere(),this.children={},this.numPoints=0,this.level=null,this.loaded=!1,this.oneTimeDisposeHandlers=[]},Potree.PointCloudOctreeGeometryNode.IDCount=0,Potree.PointCloudOctreeGeometryNode.prototype=Object.create(Potree.PointCloudTreeNode.prototype),Potree.PointCloudOctreeGeometryNode.prototype.isGeometryNode=function(){return!0},Potree.PointCloudOctreeGeometryNode.prototype.isTreeNode=function(){return!1},Potree.PointCloudOctreeGeometryNode.prototype.isLoaded=function(){return this.loaded},Potree.PointCloudOctreeGeometryNode.prototype.getBoundingSphere=function(){return this.boundingSphere},Potree.PointCloudOctreeGeometryNode.prototype.getBoundingBox=function(){return this.boundingBox},Potree.PointCloudOctreeGeometryNode.prototype.getChildren=function(){for(var e=[],t=0;8>t;t++)this.children[t]&&e.push(this.children[t]);return e},Potree.PointCloudOctreeGeometryNode.prototype.getBoundingBox=function(){return this.boundingBox},Potree.PointCloudOctreeGeometryNode.prototype.getURL=function(){var e="",t=this.pcoGeometry.loader.version;return t.equalOrHigher("1.5")?e=this.pcoGeometry.octreeDir+"/"+this.getHierarchyPath()+"/"+this.name:t.equalOrHigher("1.4")?e=this.pcoGeometry.octreeDir+"/"+this.name:t.upTo("1.3")&&(e=this.pcoGeometry.octreeDir+"/"+this.name),e},Potree.PointCloudOctreeGeometryNode.prototype.getHierarchyPath=function(){for(var e="r/",t=this.pcoGeometry.hierarchyStepSize,o=this.name.substr(1),i=Math.floor(o.length/t),n=0;i>n;n++)e+=o.substr(n*t,t)+"/";return e=e.slice(0,-1)},Potree.PointCloudOctreeGeometryNode.prototype.addChild=function(e){this.children[e.index]=e,e.parent=this},Potree.PointCloudOctreeGeometryNode.prototype.load=function(){this.loading===!0||this.loaded===!0||this.pcoGeometry.numNodesLoading>3||(this.loading=!0,this.pcoGeometry.numNodesLoading++,this.pcoGeometry.loader.version.equalOrHigher("1.5")&&this.level%this.pcoGeometry.hierarchyStepSize===0&&this.hasChildren?this.loadHierachyThenPoints():this.loadPoints())},Potree.PointCloudOctreeGeometryNode.prototype.loadPoints=function(){this.pcoGeometry.loader.load(this)},Potree.PointCloudOctreeGeometryNode.prototype.loadHierachyThenPoints=function(){var e=this,t=function(e,t){var o=(t.byteLength/5,new DataView(t)),i=[],n=o.getUint8(0),r=o.getUint32(1,!0);e.numPoints=r,i.push({children:n,numPoints:r,name:e.name});for(var a=[],s=5;i.length>0;){for(var l=i.shift(),d=1,c=0;8>c;c++){if(0!==(l.children&d)){var u=l.name+c,p=o.getUint8(s),h=o.getUint32(s+1,!0);i.push({children:p,numPoints:h,name:u}),a.push({children:p,numPoints:h,name:u}),s+=5}d=2*d}if(s===t.byteLength)break}var m={};m[e.name]=e;for(var f=e.pcoGeometry,c=0;c<a.length;c++){var g=a[c].name,r=a[c].numPoints,v=parseInt(g.charAt(g.length-1)),y=g.substring(0,g.length-1),E=m[y],T=g.length-1,b=Potree.POCLoader.createChildAABB(E.boundingBox,v),P=new Potree.PointCloudOctreeGeometryNode(g,f,b);P.level=T,P.numPoints=r,P.hasChildren=a[c].children>0,E.addChild(P),m[g]=P}e.loadPoints()};if(e.level%e.pcoGeometry.hierarchyStepSize===0){var o=e.pcoGeometry.octreeDir+"/"+e.getHierarchyPath()+"/"+e.name+".hrc",i=new XMLHttpRequest;i.open("GET",o,!0),i.responseType="arraybuffer",i.overrideMimeType("text/plain; charset=x-user-defined"),i.onreadystatechange=function(){if(4===i.readyState)if(200===i.status||0===i.status){var o=i.response;t(e,o)}else console.log("Failed to load file! HTTP status: "+i.status+", file: "+url)};try{i.send(null)}catch(n){console.log("fehler beim laden der punktwolke: "+n)}}},Potree.PointCloudOctreeGeometryNode.prototype.getNumPoints=function(){return this.numPoints},Potree.PointCloudOctreeGeometryNode.prototype.dispose=function(){if(this.geometry&&null!=this.parent){this.geometry.dispose(),this.geometry=null,this.loaded=!1;for(var e=0;e<this.oneTimeDisposeHandlers.length;e++){var t=this.oneTimeDisposeHandlers[e];t()}this.oneTimeDisposeHandlers=[]}},THREE.EventDispatcher.prototype.apply(Potree.PointCloudOctreeGeometryNode.prototype),Potree.utils=function(){},Potree.utils.pathExists=function(e){var t=new XMLHttpRequest;return t.open("GET",e,!1),t.send(null),200!==t.status?!1:!0},Potree.utils.computeTransformedBoundingBox=function(e,t){var o=[new THREE.Vector3(e.min.x,e.min.y,e.min.z).applyMatrix4(t),new THREE.Vector3(e.min.x,e.min.y,e.min.z).applyMatrix4(t),new THREE.Vector3(e.max.x,e.min.y,e.min.z).applyMatrix4(t),new THREE.Vector3(e.min.x,e.max.y,e.min.z).applyMatrix4(t),new THREE.Vector3(e.min.x,e.min.y,e.max.z).applyMatrix4(t),new THREE.Vector3(e.min.x,e.max.y,e.max.z).applyMatrix4(t),new THREE.Vector3(e.max.x,e.max.y,e.min.z).applyMatrix4(t),new THREE.Vector3(e.max.x,e.min.y,e.max.z).applyMatrix4(t),new THREE.Vector3(e.max.x,e.max.y,e.max.z).applyMatrix4(t)],i=new THREE.Box3;return i.setFromPoints(o),i},Potree.utils.addCommas=function(e){e+="",x=e.split("."),x1=x[0],x2=x.length>1?"."+x[1]:"";for(var t=/(\d+)(\d{3})/;t.test(x1);)x1=x1.replace(t,"$1,$2");return x1+x2},Potree.utils.createWorker=function(e){var t=new Blob([e],{type:"application/javascript"}),o=new Worker(URL.createObjectURL(t));return o},Potree.utils.loadSkybox=function(e){var t=new THREE.PerspectiveCamera(75,window.innerWidth/window.innerHeight,1,1e5),o=new THREE.Scene,i=".jpg",n=[e+"px"+i,e+"nx"+i,e+"py"+i,e+"ny"+i,e+"pz"+i,e+"nz"+i],r=THREE.ImageUtils.loadTextureCube(n,THREE.CubeRefractionMapping),a={uniforms:{tCube:{type:"t",value:r},tFlip:{type:"f",value:-1}},vertexShader:THREE.ShaderLib.cube.vertexShader,fragmentShader:THREE.ShaderLib.cube.fragmentShader},s=new THREE.ShaderMaterial({fragmentShader:a.fragmentShader,vertexShader:a.vertexShader,uniforms:a.uniforms,depthWrite:!1,side:THREE.BackSide}),l=new THREE.Mesh(new THREE.BoxGeometry(100,100,100),s);return o.add(l),{camera:t,scene:o}},Potree.utils.createGrid=function(e,t,o,i){for(var n=new THREE.LineBasicMaterial({color:i||8947848}),r=new THREE.Geometry,a=0;t>=a;a++)r.vertices.push(new THREE.Vector3(-(o*e)/2,0,a*o-o*t/2)),
r.vertices.push(new THREE.Vector3(+(o*e)/2,0,a*o-o*t/2));for(var a=0;e>=a;a++)r.vertices.push(new THREE.Vector3(a*o-o*e/2,0,-(o*t)/2)),r.vertices.push(new THREE.Vector3(a*o-o*e/2,0,+(o*t)/2));var s=new THREE.Line(r,n,THREE.LinePieces);return s.receiveShadow=!0,s},Potree.utils.createBackgroundTexture=function(e,t){function o(e,t){return 1/(2*Math.PI)*Math.exp(-(e*e+t*t)/2)}var i=THREE.ImageUtils.generateDataTexture(e,t,new THREE.Color);i.magFilter=THREE.NearestFilter;for(var n=i.image.data,r=[1,1.5,1.7],a=o(0,0),s=0;e>s;s++)for(var l=0;t>l;l++){var d=2*(s/e)-1,c=2*(l/t)-1,u=s+e*l,p=o(2*d,2*c)/a,h=(Math.random()+Math.random()+Math.random())/3;h=(.5*p+.5)*h*.03,h=.4*h,n[3*u+0]=255*(p/15+.05+h)*r[0],n[3*u+1]=255*(p/15+.05+h)*r[1],n[3*u+2]=255*(p/15+.05+h)*r[2]}return i},Potree.utils.topView=function(e,t){e.position.set(0,1,0),e.rotation.set(-Math.PI/2,0,0),e.zoomTo(t,1)},Potree.utils.frontView=function(e,t){e.position.set(0,0,1),e.rotation.set(0,0,0),e.zoomTo(t,1)},Potree.utils.leftView=function(e,t){e.position.set(-1,0,0),e.rotation.set(0,-Math.PI/2,0),e.zoomTo(t,1)},Potree.utils.rightView=function(e,t){e.position.set(1,0,0),e.rotation.set(0,Math.PI/2,0),e.zoomTo(t,1)},Potree.utils.frustumSphereIntersection=function(e,t){for(var o=e.planes,i=t.center,n=-t.radius,r=Number.MAX_VALUE,a=0;6>a;a++){var s=o[a].distanceToPoint(i);if(n>s)return 0;r=Math.min(r,s)}return r>=t.radius?2:1},Potree.utils.screenPass=new function(){this.screenScene=new THREE.Scene,this.screenQuad=new THREE.Mesh(new THREE.PlaneBufferGeometry(2,2,0)),this.screenQuad.material.depthTest=!0,this.screenQuad.material.depthWrite=!0,this.screenQuad.material.transparent=!0,this.screenScene.add(this.screenQuad),this.camera=new THREE.Camera,this.render=function(e,t,o){this.screenQuad.material=t,void 0===typeof o?e.render(this.screenScene,this.camera):e.render(this.screenScene,this.camera,o)}},Potree.utils.getParameterByName=function(e){e=e.replace(/[\[]/,"\\[").replace(/[\]]/,"\\]");var t=new RegExp("[\\?&]"+e+"=([^&#]*)"),o=t.exec(location.search);return null===o?null:decodeURIComponent(o[1].replace(/\+/g," "))},Potree.Features=function(){var e=document.createElement("canvas"),t=e.getContext("webgl")||e.getContext("experimental-webgl");if(null===t)return null;var o,i=t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.HIGH_FLOAT),n=t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.MEDIUM_FLOAT),r=(t.getShaderPrecisionFormat(t.VERTEX_SHADER,t.LOW_FLOAT),t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.HIGH_FLOAT)),a=t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.MEDIUM_FLOAT),s=(t.getShaderPrecisionFormat(t.FRAGMENT_SHADER,t.LOW_FLOAT),i.precision>0&&r.precision>0),l=n.precision>0&&a.precision>0;return o=s?"highp":l?"mediump":"lowp",{SHADER_INTERPOLATION:{isSupported:function(){var e=!0;return e=e&&t.getExtension("EXT_frag_depth"),e=e&&t.getParameter(t.MAX_VARYING_VECTORS)>=8}},SHADER_SPLATS:{isSupported:function(){var e=!0;return e=e&&t.getExtension("EXT_frag_depth"),e=e&&t.getExtension("OES_texture_float"),e=e&&t.getParameter(t.MAX_VARYING_VECTORS)>=8}},SHADER_EDL:{isSupported:function(){var e=!0;return e=e&&t.getExtension("EXT_frag_depth"),e=e&&t.getExtension("OES_texture_float"),e=e&&t.getParameter(t.MAX_VARYING_VECTORS)>=8}},precision:o}}(),Potree.TextSprite=function(e){THREE.Object3D.call(this);var t=new THREE.Texture;t.minFilter=THREE.LinearFilter,t.magFilter=THREE.LinearFilter;var o=new THREE.SpriteMaterial({map:t,useScreenCoordinates:!1,depthTest:!1,depthWrite:!1});this.material=o,this.sprite=new THREE.Sprite(o),this.add(this.sprite),this.borderThickness=4,this.fontface="Arial",this.fontsize=28,this.borderColor={r:0,g:0,b:0,a:1},this.backgroundColor={r:255,g:255,b:255,a:1},this.textColor={r:255,g:255,b:255,a:1},this.text="",this.setText(e)},Potree.TextSprite.prototype=new THREE.Object3D,Potree.TextSprite.prototype.setText=function(e){this.text!==e&&(this.text=e,this.update())},Potree.TextSprite.prototype.setTextColor=function(e){this.textColor=e,this.update()},Potree.TextSprite.prototype.setBorderColor=function(e){this.borderColor=e,this.update()},Potree.TextSprite.prototype.setBackgroundColor=function(e){this.backgroundColor=e,this.update()},Potree.TextSprite.prototype.update=function(){var e=document.createElement("canvas"),t=e.getContext("2d");t.font="Bold "+this.fontsize+"px "+this.fontface;var o=t.measureText(this.text),i=o.width,n=5,r=2*n+i+2*this.borderThickness,a=1.4*this.fontsize+2*this.borderThickness,e=document.createElement("canvas"),t=e.getContext("2d");t.canvas.width=r,t.canvas.height=a,t.font="Bold "+this.fontsize+"px "+this.fontface,t.fillStyle="rgba("+this.backgroundColor.r+","+this.backgroundColor.g+","+this.backgroundColor.b+","+this.backgroundColor.a+")",t.strokeStyle="rgba("+this.borderColor.r+","+this.borderColor.g+","+this.borderColor.b+","+this.borderColor.a+")",t.lineWidth=this.borderThickness,this.roundRect(t,this.borderThickness/2,this.borderThickness/2,i+this.borderThickness+2*n,1.4*this.fontsize+this.borderThickness,6),t.strokeStyle="rgba(0, 0, 0, 1.0)",t.strokeText(this.text,this.borderThickness+n,this.fontsize+this.borderThickness),t.fillStyle="rgba("+this.textColor.r+","+this.textColor.g+","+this.textColor.b+","+this.textColor.a+")",t.fillText(this.text,this.borderThickness+n,this.fontsize+this.borderThickness);var s=new THREE.Texture(e);s.minFilter=THREE.LinearFilter,s.magFilter=THREE.LinearFilter,s.needsUpdate=!0,this.sprite.material.map=s,this.sprite.scale.set(.01*r,.01*a,1)},Potree.TextSprite.prototype.roundRect=function(e,t,o,i,n,r){e.beginPath(),e.moveTo(t+r,o),e.lineTo(t+i-r,o),e.quadraticCurveTo(t+i,o,t+i,o+r),e.lineTo(t+i,o+n-r),e.quadraticCurveTo(t+i,o+n,t+i-r,o+n),e.lineTo(t+r,o+n),e.quadraticCurveTo(t,o+n,t,o+n-r),e.lineTo(t,o+r),e.quadraticCurveTo(t,o,t+r,o),e.closePath(),e.fill(),e.stroke()},Potree.Version=function(e){this.version=e;var t=-1===e.indexOf(".")?e.length:e.indexOf(".");this.versionMajor=parseInt(e.substr(0,t)),this.versionMinor=parseInt(e.substr(t+1)),0===this.versionMinor.length&&(this.versionMinor=0)},Potree.Version.prototype.newerThan=function(e){var t=new Potree.Version(e);return this.versionMajor>t.versionMajor?!0:this.versionMajor===t.versionMajor&&this.versionMinor>t.versionMinor?!0:!1},Potree.Version.prototype.equalOrHigher=function(e){var t=new Potree.Version(e);return this.versionMajor>t.versionMajor?!0:this.versionMajor===t.versionMajor&&this.versionMinor>=t.versionMinor?!0:!1},Potree.Version.prototype.upTo=function(e){return!this.newerThan(e)},Potree.Measure=function(){var e=this;THREE.Object3D.call(this),this.points=[],this._showDistances=!0,this._showCoordinates=!1,this._showArea=!0,this._closed=!0,this._showAngles=!1,this.maxMarkers=Number.MAX_SAFE_INTEGER,this.spheres=[],this.edges=[],this.sphereLabels=[],this.edgeLabels=[],this.angleLabels=[],this.coordinateLabels=[],this.areaLabel=new Potree.TextSprite(""),this.areaLabel.setBorderColor({r:0,g:0,b:0,a:.8}),this.areaLabel.setBackgroundColor({r:0,g:0,b:0,a:.3}),this.areaLabel.setTextColor({r:180,g:220,b:180,a:1}),this.areaLabel.material.depthTest=!1,this.areaLabel.material.opacity=1,this.areaLabel.visible=!1,this.add(this.areaLabel);var t=new THREE.SphereGeometry(.4,10,10);this.color=new THREE.Color(16711680);var o=function(){var t=new THREE.MeshLambertMaterial({shading:THREE.SmoothShading,color:e.color,ambient:11184810,depthTest:!1,depthWrite:!1});return t},i=function(e){e.target.material.emissive.setHex(8947848)},n=function(e){e.target.material.emissive.setHex(0)},r=function(t){var o=t.tool,i=(o.dragstart,o.mouse,o.getMousePointCloudIntersection());if(i){var n=(i.position,e.spheres.indexOf(o.dragstart.object));e.setMarker(n,i)}t.event.stopImmediatePropagation()},a=function(e){};this.addMarker=function(e){e instanceof THREE.Vector3&&(e={position:e}),this.points.push(e);var s=new THREE.Mesh(t,o());s.addEventListener("move",i),s.addEventListener("leave",n),s.addEventListener("drag",r),s.addEventListener("drop",a),this.add(s),this.spheres.push(s);var l=new THREE.Geometry;l.vertices.push(new THREE.Vector3,new THREE.Vector3),l.colors.push(this.color,this.color,this.color);var d=new THREE.LineBasicMaterial({linewidth:1});d.depthTest=!1;var c=new THREE.Line(l,d);c.visible=!0,this.add(c),this.edges.push(c);var u=new Potree.TextSprite;u.setBorderColor({r:0,g:0,b:0,a:.8}),u.setBackgroundColor({r:0,g:0,b:0,a:.3}),u.material.depthTest=!1,u.visible=!1,this.edgeLabels.push(u),this.add(u);var p=new Potree.TextSprite;p.setBorderColor({r:0,g:0,b:0,a:.8}),p.setBackgroundColor({r:0,g:0,b:0,a:.3}),p.material.depthTest=!1,p.material.opacity=1,p.visible=!1,this.angleLabels.push(p),this.add(p);var h=new Potree.TextSprite;h.setBorderColor({r:0,g:0,b:0,a:.8}),h.setBackgroundColor({r:0,g:0,b:0,a:.3}),h.material.depthTest=!1,h.material.opacity=1,h.visible=!1,this.coordinateLabels.push(h),this.add(h);var m={type:"marker_added",measurement:this};this.dispatchEvent(m),this.setMarker(this.points.length-1,e)},this.removeMarker=function(e){this.points.splice(e,1),this.remove(this.spheres[e]);var t=0===e?0:e-1;this.remove(this.edges[t]),this.edges.splice(t,1),this.remove(this.edgeLabels[t]),this.edgeLabels.splice(t,1),this.coordinateLabels.splice(e,1),this.spheres.splice(e,1),this.update(),this.dispatchEvent({type:"marker_removed",measurement:this})},this.setMarker=function(e,t){this.points[e]=t;var o={type:"marker_moved",measure:this,index:e,position:t.position.clone()};this.dispatchEvent(o),this.update()},this.setPosition=function(e,t){var o=this.points[e];o.position.copy(t);var i={type:"marker_moved",measure:this,index:e,position:t.clone()};this.dispatchEvent(i),this.update()},this.getArea=function(){for(var e=0,t=this.points.length-1,o=0;o<this.points.length;o++){var i=this.points[o].position,n=this.points[t].position;e+=(n.x+i.x)*(i.z-n.z),t=o}return Math.abs(e/2)},this.getAngleBetweenLines=function(e,t,o){var i=(new THREE.Vector3).subVectors(t.position,e.position),n=(new THREE.Vector3).subVectors(o.position,e.position);return i.angleTo(n)},this.getAngle=function(e){if(this.points.length<3||e>=this.points.length)return 0;var t=0===e?this.points[this.points.length-1]:this.points[e-1],o=this.points[e],i=this.points[(e+1)%this.points.length];return this.getAngleBetweenLines(o,t,i)},this.update=function(){if(0!==this.points.length){if(1===this.points.length){var t=this.points[0],o=t.position;this.spheres[0].position.copy(o);var i=this.coordinateLabels[0],n=o.clone().add(new THREE.Vector3(0,1,0));i.position.copy(n);var r=o.x.toFixed(2)+" / "+o.y.toFixed(2)+" / "+o.z.toFixed(2);return i.setText(r),void(i.visible=this.showCoordinates&&(a>d||this.closed))}for(var a=this.points.length-1,s=new THREE.Vector3,l=0;a>=l;l++){var t=this.points[l];s.add(t.position)}s.divideScalar(this.points.length);for(var l=0;a>=l;l++){var d=l,c=l+1>a?0:l+1,u=0===l?a:l-1,t=this.points[d],p=this.points[c],h=this.points[u],m=this.spheres[d];m.position.copy(t.position),m.material.color=e.color;var f=this.edges[d];f.material.color=this.color,f.geometry.vertices[0].copy(t.position),f.geometry.vertices[1].copy(p.position),f.geometry.verticesNeedUpdate=!0,f.geometry.computeBoundingSphere(),f.visible=a>d||this.closed;var g=this.edgeLabels[l],v=(new THREE.Vector3).add(t.position);v.add(p.position),v=v.multiplyScalar(.5);var y=t.position.distanceTo(p.position);g.position.copy(v),g.setText(y.toFixed(2)),g.visible=this.showDistances&&(a>d||this.closed)&&this.points.length>=2&&y>0;var E=this.angleLabels[l],T=this.getAngleBetweenLines(t,h,p),b=p.position.clone().sub(h.position);b.multiplyScalar(.5),b=h.position.clone().add(b).sub(t.position).normalize();var P=Math.min(t.position.distanceTo(h.position),t.position.distanceTo(p.position));P/=9;var n=t.position.clone().add(b.multiplyScalar(P));E.position.copy(n);var r=Potree.utils.addCommas((T*(180/Math.PI)).toFixed(1))+"";E.setText(r),E.visible=this.showAngles&&(a>d||this.closed)&&this.points.length>=3&&T>0;var i=this.coordinateLabels[0],n=t.position.clone().add(new THREE.Vector3(0,1,0));i.position.copy(n);var r=t.position.x.toFixed(2)+" / "+t.position.y.toFixed(2)+" / "+t.position.z.toFixed(2);i.setText(r),i.visible=this.showCoordinates&&(a>d||this.closed)}this.areaLabel.position.copy(s),this.areaLabel.visible=this.showArea&&this.points.length>=3;var r=Potree.utils.addCommas(this.getArea().toFixed(1))+"";this.areaLabel.setText(r)}},this.raycast=function(e,t){for(var o=0;o<this.points.length;o++){var i=this.spheres[o];i.raycast(e,t)}for(var o=0;o<t.length;o++){var n=t[o];n.distance=e.ray.origin.distanceTo(n.point)}t.sort(function(e,t){return e.distance-t.distance})}},Potree.Measure.prototype=Object.create(THREE.Object3D.prototype),Object.defineProperty(Potree.Measure.prototype,"showCoordinates",{get:function(){return this._showCoordinates},set:function(e){this._showCoordinates=e,this.update()}}),Object.defineProperty(Potree.Measure.prototype,"showAngles",{get:function(){return this._showAngles},set:function(e){this._showAngles=e,this.update()}}),Object.defineProperty(Potree.Measure.prototype,"showArea",{get:function(){return this._showArea},set:function(e){this._showArea=e,this.update()}}),Object.defineProperty(Potree.Measure.prototype,"closed",{get:function(){return this._closed},set:function(e){this._closed=e,this.update()}}),Object.defineProperty(Potree.Measure.prototype,"showDistances",{get:function(){return this._showDistances},set:function(e){this._showDistances=e,this.update()}}),Potree.MeasuringTool=function(e,t,o,i){function n(e){if(h===p.INSERT){var t=u.getMousePointCloudIntersection();if(t){var o=t.position.clone();u.activeMeasurement.addMarker(o);var e={type:"newpoint",position:o.clone()};u.dispatchEvent(e),u.activeMeasurement.points.length>u.activeMeasurement.maxMarkers&&u.finishInsertion()}}}function r(e){var t=u.domElement.getBoundingClientRect();if(u.mouse.x=(e.clientX-t.left)/u.domElement.clientWidth*2-1,u.mouse.y=2*-((e.clientY-t.top)/u.domElement.clientHeight)+1,u.dragstart){var o={type:"drag",event:e,tool:u};u.dragstart.object.dispatchEvent(o)}else if(h==p.INSERT&&u.activeMeasurement){var i=u.getMousePointCloudIntersection();if(i){var n=(i.position,u.activeMeasurement.points.length-1);u.activeMeasurement.setMarker(n,i)}}else{var r=c();r?(r.object.dispatchEvent({type:"move",target:r.object,event:e}),u.hoveredElement&&u.hoveredElement!==r.object&&u.hoveredElement.dispatchEvent({type:"leave",target:u.hoveredElement,event:e}),u.hoveredElement=r.object):(u.hoveredElement&&u.hoveredElement.dispatchEvent({type:"leave",target:u.hoveredElement,event:e}),u.hoveredElement=null)}}function a(e){h==p.INSERT&&u.finishInsertion()}function s(e){if(1===e.which){h!==p.DEFAULT&&e.stopImmediatePropagation();var t=c();t&&(u.dragstart={object:t.object,sceneClickPos:t.point,sceneStartPos:u.sceneRoot.position.clone(),mousePos:{x:u.mouse.x,y:u.mouse.y}},e.stopImmediatePropagation())}else 3===e.which&&a(e)}function l(e){window.getSelection?window.getSelection().removeAllRanges():document.selection&&document.selection.empty(),u.activeMeasurement&&h===p.INSERT&&(u.activeMeasurement.removeMarker(u.activeMeasurement.points.length-1),u.finishInsertion(),e.stopImmediatePropagation())}function d(e){u.dragstart&&(u.dragstart.object.dispatchEvent({type:"drop",event:e}),u.dragstart=null)}function c(){var e=new THREE.Vector3(u.mouse.x,u.mouse.y,.5);e.unproject(u.camera);var t=new THREE.Raycaster;t.ray.set(u.camera.position,e.sub(u.camera.position).normalize());for(var o=[],i=0;i<u.measurements.length;i++)for(var n=u.measurements[i],r=0;r<n.spheres.length;r++)o.push(n.spheres[r]);var a=t.intersectObjects(o,!0);return a.length>0?a[0]:!1}var u=this;this.enabled=!1,this.toGeo=i,this.scene=e,this.camera=t,this.renderer=o,this.domElement=o.domElement,this.mouse={x:0,y:0};var p={DEFAULT:0,INSERT:1},h=p.DEFAULT;this.activeMeasurement=null,this.measurements=[],this.sceneMeasurement=new THREE.Scene,this.sceneRoot=new THREE.Object3D,this.sceneMeasurement.add(this.sceneRoot),this.light=new THREE.DirectionalLight(16777215,1),this.light.position.set(0,0,10),this.light.lookAt(new THREE.Vector3(0,0,0)),this.sceneMeasurement.add(this.light),this.hoveredElement=null,this.getState=function(){return h},this.getMousePointCloudIntersection=function(){var e=new THREE.Vector3(u.mouse.x,u.mouse.y,.5);e.unproject(u.camera);var t=e.sub(u.camera.position).normalize(),o=new THREE.Ray(u.camera.position,t),i=[];u.scene.traverse(function(e){(e instanceof Potree.PointCloudOctree||e instanceof Potree.PointCloudArena4D)&&i.push(e)});for(var n=null,r=null,a=0;a<i.length;a++){var s=i[a],l=s.pick(u.renderer,u.camera,o);if(l){var d=u.camera.position.distanceTo(l.position);(!n||r>d)&&(n=l,r=d)}}return n?n:null},this.startInsertion=function(e){h=p.INSERT;var e=e||{},t="undefined"!=typeof e.showDistances?e.showDistances:!0,o="undefined"!=typeof e.showArea?e.showArea:!1,i="undefined"!=typeof e.showAngles?e.showAngles:!1,n="undefined"!=typeof e.closed?e.closed:!1,r="undefined"!=typeof e.showCoordinates?e.showCoordinates:!1,a=e.maxMarkers||Number.MAX_SAFE_INTEGER,s=new Potree.Measure;s.showDistances=t,s.showArea=o,s.showAngles=i,s.closed=n,s.showCoordinates=r,s.maxMarkers=a,this.addMeasurement(s),s.addMarker(new THREE.Vector3(1/0,1/0,1/0)),this.activeMeasurement=s},this.finishInsertion=function(){this.activeMeasurement.removeMarker(this.activeMeasurement.points.length-1);var e={type:"insertion_finished",measurement:this.activeMeasurement};this.dispatchEvent(e),this.activeMeasurement=null,h=p.DEFAULT},this.addMeasurement=function(e){this.sceneMeasurement.add(e),this.measurements.push(e),this.dispatchEvent({type:"measurement_added",measurement:e}),e.addEventListener("marker_added",function(e){u.dispatchEvent(e)}),e.addEventListener("marker_removed",function(e){u.dispatchEvent(e)}),e.addEventListener("marker_moved",function(e){u.dispatchEvent(e)})},this.removeMeasurement=function(e){this.sceneMeasurement.remove(e);var t=this.measurements.indexOf(e);t>=0&&(this.measurements.splice(t,1),this.dispatchEvent({type:"measurement_removed",measurement:e}))},this.reset=function(){for(var e=this.measurements.length-1;e>=0;e--){var t=this.measurements[e];this.removeMeasurement(t)}},this.update=function(){for(var e=[],i=0;i<this.measurements.length;i++)e.push(this.measurements[i]);this.activeMeasurement&&e.push(this.activeMeasurement);for(var i=0;i<e.length;i++){for(var n=e[i],r=0;r<n.spheres.length;r++){var a=n.spheres[r],s=u.camera.position.distanceTo(a.getWorldPosition()),l=projectedRadius(1,u.camera.fov*Math.PI/180,s,o.domElement.clientHeight),d=15/l;a.scale.set(d,d,d)}for(var r=0;r<n.edgeLabels.length;r++){var c=n.edgeLabels[r],s=u.camera.position.distanceTo(c.getWorldPosition()),l=projectedRadius(1,u.camera.fov*Math.PI/180,s,o.domElement.clientHeight),d=70/l;c.scale.set(d,d,d)}for(var r=0;r<n.edgeLabels.length;r++){var c=n.angleLabels[r],s=u.camera.position.distanceTo(c.getWorldPosition()),l=projectedRadius(1,u.camera.fov*Math.PI/180,s,o.domElement.clientHeight),d=70/l;c.scale.set(d,d,d)}for(var r=0;r<n.coordinateLabels.length;r++){var c=n.coordinateLabels[r],a=n.spheres[r],p=n.points[r],s=u.camera.position.distanceTo(a.getWorldPosition()),h=a.getWorldPosition().clone().project(t);h.x=Math.round((h.x+1)*u.renderer.domElement.clientWidth/2),h.y=Math.round((-h.y+1)*u.renderer.domElement.clientHeight/2),h.z=0,h.y-=30;var m=new THREE.Vector3(h.x/u.renderer.domElement.clientWidth*2-1,2*-(h.y/u.renderer.domElement.clientHeight)+1,.5);m.unproject(u.camera);var f=m.sub(u.camera.position).normalize();m=(new THREE.Vector3).addVectors(u.camera.position,f.multiplyScalar(s)),c.position.copy(m);var l=projectedRadius(1,u.camera.fov*Math.PI/180,s,o.domElement.clientHeight),d=70/l;c.scale.set(d,d,d);var g=u.toGeo(p.position),v=g.x.toFixed(2)+" / ";v+=g.y.toFixed(2)+" / ",v+=g.z.toFixed(2),c.setText(v)}var s=u.camera.position.distanceTo(n.areaLabel.getWorldPosition()),l=projectedRadius(1,u.camera.fov*Math.PI/180,s,o.domElement.clientHeight),d=80/l;n.areaLabel.scale.set(d,d,d)}this.light.position.copy(this.camera.position),this.light.lookAt(this.camera.getWorldDirection().add(this.camera.position))},this.render=function(){this.update(),this.renderer.render(this.sceneMeasurement,this.camera)},this.domElement.addEventListener("click",n,!1),this.domElement.addEventListener("dblclick",l,!1),this.domElement.addEventListener("mousemove",r,!1),this.domElement.addEventListener("mousedown",s,!1),this.domElement.addEventListener("mouseup",d,!0)},Potree.MeasuringTool.prototype=Object.create(THREE.EventDispatcher.prototype),Potree.HeightProfile=function(){var e=this;THREE.Object3D.call(this),this.points=[],this.spheres=[],this.edges=[],this.boxes=[],this.width=1,this.height=20,this._modifiable=!0;var t=new THREE.SphereGeometry(.4,10,10),o=new THREE.Color(16711680),i=function(){var e=new THREE.MeshLambertMaterial({shading:THREE.SmoothShading,color:16711680,ambient:11184810,depthTest:!1,depthWrite:!1});return e},n=function(e){e.target.material.emissive.setHex(8947848)},r=function(e){e.target.material.emissive.setHex(0)},a=function(t){var o=t.tool,i=o.dragstart,n=o.mouse;if(t.event.ctrlKey){var r=new THREE.Vector3(i.mousePos.x,i.mousePos.y,0),a=new THREE.Vector3(n.x,n.y,0),s=i.widthStart,l=1-10*(r.y-a.y);l=Math.max(.01,l),s&&e.setWidth(s*l)}else{var d=o.getMousePointCloudIntersection();if(d){var c=e.spheres.indexOf(o.dragstart.object);e.setPosition(c,d)}}t.event.stopImmediatePropagation()},s=function(e){};this.addMarker=function(e){this.points.push(e);var l=new THREE.Mesh(t,i());if(l.addEventListener("mousemove",n),l.addEventListener("mouseleave",r),l.addEventListener("mousedrag",a),l.addEventListener("drop",s),this.add(l),this.spheres.push(l),this.points.length>1){var d=new THREE.Geometry;d.vertices.push(new THREE.Vector3,new THREE.Vector3),d.colors.push(o,o,o);var c=new THREE.LineBasicMaterial({vertexColors:THREE.VertexColors,linewidth:2,transparent:!0,opacity:.4});c.depthTest=!1;var u=new THREE.Line(d,c);u.visible=!1,this.add(u),this.edges.push(u);var p=new THREE.BoxGeometry(1,1,1),h=new THREE.MeshBasicMaterial({color:16711680,transparent:!0,opacity:.2}),m=new THREE.Mesh(p,h);m.visible=!1,this.add(m),this.boxes.push(m)}var f={type:"marker_added",profile:this};this.dispatchEvent(f),this.setPosition(this.points.length-1,e)},this.removeMarker=function(e){this.points.splice(e,1),this.remove(this.spheres[e]);var t=0===e?0:e-1;this.remove(this.edges[t]),this.edges.splice(t,1),this.remove(this.boxes[t]),this.boxes.splice(t,1),this.spheres.splice(e,1),this.update();var o={type:"marker_removed",profile:this};this.dispatchEvent(o)},this.getArea=function(){for(var e=0,t=this.points.length-1,o=0;o<this.points.length;o++){var i=this.points[o],n=this.points[t];e+=(n.x+i.x)*(i.z-n.z),t=o}return Math.abs(e/2)},this.setPosition=function(e,t){var o=this.points[e];o.copy(t);var i={type:"marker_moved",profile:this,index:e,position:t.clone()};this.dispatchEvent(i),this.update()},this.setWidth=function(e){this.width=e;var t={type:"width_changed",profile:this,width:e};this.dispatchEvent(t),this.update()},this.getWidth=function(){return this.width},this.update=function(){if(0!==this.points.length){if(1===this.points.length){var e=this.points[0];return void this.spheres[0].position.copy(e)}for(var t=this.points[0].clone(),o=this.points[0].clone(),i=new THREE.Vector3,n=this.points.length-1,r=0;n>=r;r++){var e=this.points[r],a=this.spheres[r],s=0===r?n:r-1,l=r===n?0:r+1,d=this.points[s],c=this.points[l],u=this.edges[s],p=this.edges[r],h=this.boxes[s];this.boxes[r],e.distanceTo(d),e.distanceTo(c),(new THREE.Vector3).addVectors(d,e).multiplyScalar(.5),(new THREE.Vector3).addVectors(e,c).multiplyScalar(.5);if(a.position.copy(e),this._modifiable?a.visible=!0:a.visible=!1,u&&(u.geometry.vertices[1].copy(e),u.geometry.verticesNeedUpdate=!0,u.geometry.computeBoundingSphere()),p&&(p.geometry.vertices[0].copy(e),p.geometry.verticesNeedUpdate=!0,p.geometry.computeBoundingSphere()),h){var m=d,f=e,g=m.clone().setY(0).distanceTo(f.clone().setY(0));h.scale.set(g,this.height,this.width);var v=(new THREE.Vector3).addVectors(m,f).multiplyScalar(.5),y=(new THREE.Vector3).subVectors(f,m),E=new THREE.Vector3(y.z,0,-y.x);h.position.set(0,0,0),h.lookAt(E),h.position.copy(v)}i.add(e),t.min(e),o.max(e)}i.multiplyScalar(1/this.points.length);for(var r=0;r<this.boxes.length;r++){var T=this.boxes[r];T.position.y=t.y+(o.y-t.y)/2,T.scale.y=1e6}}},this.raycast=function(e,t){for(var o=0;o<this.points.length;o++){var i=this.spheres[o];i.raycast(e,t)}for(var o=0;o<t.length;o++){var n=t[o];n.distance=e.ray.origin.distanceTo(n.point)}t.sort(function(e,t){return e.distance-t.distance})}},Potree.HeightProfile.prototype=Object.create(THREE.Object3D.prototype),Object.defineProperty(Potree.HeightProfile.prototype,"modifiable",{get:function(){return this.modifiable},set:function(e){this._modifiable=e,this.update()}}),Potree.ProfileTool=function(e,t,o){function i(e){if(p===u.INSERT){var o=c.getMousePointCloudIntersection();if(o){var i=o.clone();1===c.activeProfile.points.length&&null===c.activeProfile.width&&c.activeProfile.setWidth(t.position.distanceTo(i)/50),c.activeProfile.addMarker(i);var e={type:"newpoint",position:i.clone()};c.dispatchEvent(e)}}}function n(e){var t=c.domElement.getBoundingClientRect();if(c.mouse.x=(e.clientX-t.left)/c.domElement.clientWidth*2-1,c.mouse.y=2*-((e.clientY-t.top)/c.domElement.clientHeight)+1,c.dragstart){var o={type:"mousedrag",event:e,tool:c};c.dragstart.object.dispatchEvent(o)}else if(p==u.INSERT&&c.activeProfile){var i=c.getMousePointCloudIntersection();if(i){var n=c.activeProfile.points.length-1;c.activeProfile.setPosition(n,i)}}else{var i=d();i?(i.object.dispatchEvent({type:"mousemove",target:i.object,event:e}),c.hoveredElement&&c.hoveredElement!==i.object&&c.hoveredElement.dispatchEvent({type:"mouseleave",target:c.hoveredElement,event:e}),c.hoveredElement=i.object):(c.hoveredElement&&c.hoveredElement.dispatchEvent({type:"mouseleave",target:c.hoveredElement,event:e}),c.hoveredElement=null)}}function r(e){p==u.INSERT&&c.finishInsertion()}function a(e){if(p!==u.DEFAULT&&e.stopImmediatePropagation(),1===e.which){var t=d();if(t){for(var o=null,i=0;i<c.profiles.length;i++)for(var n=c.profiles[i],a=0;a<n.spheres.length;a++){var s=n.spheres[a];s===t.object&&(o=n.width)}c.dragstart={object:t.object,sceneClickPos:t.point,sceneStartPos:c.sceneRoot.position.clone(),mousePos:{x:c.mouse.x,y:c.mouse.y},widthStart:o},e.stopImmediatePropagation()}}else 3===e.which&&r(e)}function s(e){window.getSelection?window.getSelection().removeAllRanges():document.selection&&document.selection.empty(),c.activeProfile&&p===u.INSERT&&(c.activeProfile.removeMarker(c.activeProfile.points.length-1),c.finishInsertion(),e.stopImmediatePropagation())}function l(e){c.dragstart&&(c.dragstart.object.dispatchEvent({type:"drop",event:e}),c.dragstart=null)}function d(){var e=new THREE.Vector3(c.mouse.x,c.mouse.y,.5);e.unproject(c.camera);var t=new THREE.Raycaster;t.ray.set(c.camera.position,e.sub(c.camera.position).normalize());var o=t.intersectObjects(c.profiles);return o.length>0?o[0]:!1}var c=this;this.enabled=!1,this.scene=e,this.camera=t,this.renderer=o,this.domElement=o.domElement,this.mouse={x:0,y:0};var u={DEFAULT:0,INSERT:1},p=u.DEFAULT;new THREE.SphereGeometry(.4,10,10);this.activeProfile=null,this.profiles=[],this.sceneProfile=new THREE.Scene,this.sceneRoot=new THREE.Object3D,this.sceneProfile.add(this.sceneRoot),this.light=new THREE.DirectionalLight(16777215,1),this.light.position.set(0,0,10),this.light.lookAt(new THREE.Vector3(0,0,0)),this.sceneProfile.add(this.light),this.hoveredElement=null,this.getMousePointCloudIntersection=function(){var e=new THREE.Vector3(c.mouse.x,c.mouse.y,.5);e.unproject(c.camera);var t=e.sub(c.camera.position).normalize(),o=new THREE.Ray(c.camera.position,t),i=[];c.scene.traverse(function(e){(e instanceof Potree.PointCloudOctree||e instanceof Potree.PointCloudArena4D)&&i.push(e)});for(var n=null,r=null,a=0;a<i.length;a++){var s=i[a],l=s.pick(c.renderer,c.camera,o,{pickOutsideClipRegion:!0});if(l){var d=c.camera.position.distanceTo(l.position);(!n||r>d)&&(n=l,r=d)}}return n?n.position:null},this.startInsertion=function(e){p=u.INSERT;var e=e||{},t=e.clip||!1,o=e.width||null;return this.activeProfile=new Potree.HeightProfile,this.activeProfile.clip=t,this.activeProfile.setWidth(o),this.addProfile(this.activeProfile),this.activeProfile.addMarker(new THREE.Vector3(0,0,0)),this.activeProfile},this.finishInsertion=function(){this.activeProfile.removeMarker(this.activeProfile.points.length-1);var e={type:"insertion_finished",profile:this.activeProfile};this.dispatchEvent(e),this.activeProfile=null,p=u.DEFAULT},this.addProfile=function(e){this.profiles.push(e),this.sceneProfile.add(e),e.update(),this.dispatchEvent({type:"profile_added",profile:e}),e.addEventListener("marker_added",function(e){c.dispatchEvent(e)}),e.addEventListener("marker_removed",function(e){c.dispatchEvent(e)}),e.addEventListener("marker_moved",function(e){c.dispatchEvent(e)}),e.addEventListener("width_changed",function(e){c.dispatchEvent(e)})},this.removeProfile=function(e){this.sceneProfile.remove(e);var t=this.profiles.indexOf(e);t>=0&&(this.profiles.splice(t,1),this.dispatchEvent({type:"profile_removed",profile:e}))},this.reset=function(){for(var e=this.profiles.length-1;e>=0;e--){var t=this.profiles[e];this.removeProfile(t)}},this.update=function(){for(var e=0;e<this.profiles.length;e++)for(var t=this.profiles[e],i=0;i<t.spheres.length;i++){var n=t.spheres[i],r=c.camera.position.distanceTo(n.getWorldPosition()),a=projectedRadius(1,c.camera.fov*Math.PI/180,r,o.domElement.clientHeight),s=15/a;n.scale.set(s,s,s)}this.light.position.copy(this.camera.position),this.light.lookAt(this.camera.getWorldDirection().add(this.camera.position))},this.render=function(){this.update(),o.render(this.sceneProfile,this.camera)},this.domElement.addEventListener("click",i,!1),this.domElement.addEventListener("dblclick",s,!1),this.domElement.addEventListener("mousemove",n,!1),this.domElement.addEventListener("mousedown",a,!1),this.domElement.addEventListener("mouseup",l,!0)},Potree.ProfileTool.prototype=Object.create(THREE.EventDispatcher.prototype),Potree.TransformationTool=function(e,t,o){function i(e){var t=s.domElement.getBoundingClientRect();if(s.mouse.x=(e.clientX-t.left)/s.domElement.clientWidth*2-1,s.mouse.y=2*-((e.clientY-t.top)/s.domElement.clientHeight)+1,s.dragstart)s.dragstart.object.dispatchEvent({type:"mousedrag",event:e});else{var o=a();if(o){var i=o.object;i.dispatchEvent({type:"mousemove",event:e}),s.hoveredElement&&s.hoveredElement!==i&&s.hoveredElement.dispatchEvent({type:"mouseleave",event:e}),s.hoveredElement=i}else s.hoveredElement&&s.hoveredElement.dispatchEvent({type:"mouseleave",event:e}),s.hoveredElement=null}}function n(e){if(1===e.which){var t=a();if(t){for(var o=[],i=[],n=0;n<s.targets.length;n++)o.push(s.targets[n].scale.clone()),i.push(s.targets[n].rotation.clone());s.dragstart={object:t.object,sceneClickPos:t.point,sceneStartPos:s.sceneRoot.position.clone(),mousePos:{x:s.mouse.x,y:s.mouse.y},scales:o,rotations:i},e.stopImmediatePropagation()}}else 3===e.which&&s.setTargets([])}function r(e){s.dragstart&&(s.dragstart.object.dispatchEvent({type:"drop",event:e}),s.dragstart=null)}function a(){if(0!==s.targets.length){var e=new THREE.Vector3(s.mouse.x,s.mouse.y,.5);e.unproject(s.camera);var t=new THREE.Raycaster;t.ray.set(s.camera.position,e.sub(s.camera.position).normalize()),t.linePrecision=.2;var o=[];s.translationNode.visible?o.push(s.translationNode):s.scaleNode.visible?o.push(s.scaleNode):s.rotationNode.visible&&(o.push(s.rotationNode),o.push(s.sceneRotation));for(var i=t.intersectObjects(o,!0),n=0;n<i.length;n++){var r=i[n];r.distance=s.camera.position.distanceTo(r.point)}return i.sort(function(e,t){return e.distance-t.distance}),i.length>0?i[0]:!1}}var s=this;this.enabled=!1,this.scene=e,this.camera=t,this.renderer=o,this.domElement=o.domElement,this.mouse={x:0,y:0},this.dragstart=null,this.sceneTransformation=new THREE.Scene,this.sceneRoot=new THREE.Object3D,this.sceneTransformation.add(this.sceneRoot),
this.sceneRotation=new THREE.Scene,this.translationNode=new THREE.Object3D,this.rotationNode=new THREE.Object3D,this.scaleNode=new THREE.Object3D,this.sceneRoot.add(this.translationNode),this.sceneRoot.add(this.rotationNode),this.sceneRoot.add(this.scaleNode),this.sceneRoot.visible=!1,this.hoveredElement=null,this.STATE={DEFAULT:0,TRANSLATE_X:1,TRANSLATE_Y:2,TRANSLATE_Z:3,SCALE_X:1,SCALE_Y:2,SCALE_Z:3},this.parts={ARROW_X:{name:"arrow_x",object:void 0,color:new THREE.Color(16711680),state:this.STATE.TRANSLATE_X},ARROW_Z:{name:"arrow_z",object:void 0,color:new THREE.Color(255),state:this.STATE.TRANSLATE_Z},ARROW_Y:{name:"arrow_y",object:void 0,color:new THREE.Color(65280),state:this.STATE.TRANSLATE_Y},SCALE_X:{name:"scale_x",object:void 0,color:new THREE.Color(16711680),state:this.STATE.SCALE_X},SCALE_Z:{name:"scale_z",object:void 0,color:new THREE.Color(255),state:this.STATE.SCALE_Z},SCALE_Y:{name:"scale_y",object:void 0,color:new THREE.Color(65280),state:this.STATE.SCALE_Y},ROTATE_X:{name:"rotate_x",object:void 0,color:new THREE.Color(16711680),state:this.STATE.ROTATE_X},ROTATE_Z:{name:"rotate_z",object:void 0,color:new THREE.Color(255),state:this.STATE.ROTATE_Z},ROTATE_Y:{name:"rotate_y",object:void 0,color:new THREE.Color(65280),state:this.STATE.ROTATE_Y}},this.buildTranslationNode=function(){var e=s.createArrow(s.parts.ARROW_X,s.parts.ARROW_X.color);e.rotation.z=-Math.PI/2;var t=s.createArrow(s.parts.ARROW_Y,s.parts.ARROW_Y.color),o=s.createArrow(s.parts.ARROW_Z,s.parts.ARROW_Z.color);o.rotation.x=-Math.PI/2,this.translationNode.add(e),this.translationNode.add(t),this.translationNode.add(o)},this.buildScaleNode=function(){var e=this.createScaleHandle(s.parts.SCALE_X,16711680);e.rotation.z=-Math.PI/2;var t=this.createScaleHandle(s.parts.SCALE_Y,65280),o=this.createScaleHandle(s.parts.SCALE_Z,255);o.rotation.x=-Math.PI/2,this.scaleNode.add(e),this.scaleNode.add(t),this.scaleNode.add(o)},this.buildRotationNode=function(){var e=this.createRotationCircle(s.parts.ROTATE_X,16711680);e.rotation.y=-Math.PI/2;var t=this.createRotationCircle(s.parts.ROTATE_Y,65280),o=this.createRotationCircle(s.parts.ROTATE_Z,255);t.rotation.x=-Math.PI/2,this.rotationNode.add(e),this.rotationNode.add(t),this.rotationNode.add(o);var i=new THREE.SphereGeometry(2.9,24,24),n=new THREE.Mesh(i,new THREE.MeshBasicMaterial({color:11184810,transparent:!0,opacity:.4}));this.sceneRotation.add(n);var r=function(e){n.material.color.setHex(5592405)},a=function(e){n.material.color.setHex(11184810)},l=function(e){e.event.stopImmediatePropagation();for(var t=new THREE.Vector3(s.dragstart.mousePos.x,s.dragstart.mousePos.y,.1),o=new THREE.Vector3(s.mouse.x,s.mouse.y,.1),i=(new THREE.Vector3).subVectors(o,t),n=t.clone().unproject(s.camera),r=o.clone().unproject(s.camera),a=(new THREE.Vector3).subVectors(r,n),l=a.clone().normalize(),d=(new THREE.Vector3).subVectors(s.camera.position,n).normalize(),c=d.clone().cross(l),u=6*i.length(),p=0;p<s.targets.length;p++){var h=s.targets[p],m=s.dragstart.rotations[p];h.rotation.copy(m);var f=new THREE.Quaternion;f.setFromAxisAngle(c,u),h.quaternion.multiplyQuaternions(f,h.quaternion)}},d=function(e){};n.addEventListener("mousemove",r),n.addEventListener("mouseleave",a),n.addEventListener("mousedrag",l),n.addEventListener("drop",d)},this.createBox=function(e){var t=new THREE.BoxGeometry(1,1,1),o=new THREE.MeshBasicMaterial({color:e,transparent:!0,opacity:.5}),i=new THREE.Mesh(t,o);return i};this.createRotationCircle=function(e,t){for(var o=[],i=128,n=0;i>=n;n++){var r=2*Math.PI*n/i,a=3*Math.cos(r),l=3*Math.sin(r);o.push(new THREE.Vector3(a,l,0))}for(var d=new THREE.Geometry,n=0;n<o.length;n++)d.vertices.push(o[n]);var c=new THREE.LineBasicMaterial({color:t}),u=new THREE.Line(d,c);u.mode=THREE.LineStrip,u.scale.set(1,1,1);var p=function(e){c.color.setRGB(1,1,0)},h=function(e){c.color.setHex(t)},m=function(t){t.event.stopImmediatePropagation();var o=new THREE.Vector3;e===s.parts.ROTATE_X?o.x=1:e===s.parts.ROTATE_Y?o.y=1:e===s.parts.ROTATE_Z&&(o.z=-1);var i=s.dragstart.sceneClickPos.clone(),n=s.sceneRoot.position.clone(),r=i.clone().sub(n).normalize(),a=i.clone().project(s.camera),l=n.clone().project(s.camera),d=a.clone().sub(l).normalize(),c=(new THREE.Vector3(d.y,d.x,0),new THREE.Vector3(s.dragstart.mousePos.x,s.dragstart.mousePos.y,0),new THREE.Vector3(s.mouse.x,s.mouse.y,0)),u=(new THREE.Plane).setFromNormalAndCoplanarPoint(o,s.sceneRoot.position),p=s.camera.position,h=(new THREE.Vector3(0,0,-1).applyQuaternion(s.camera.quaternion),new THREE.Vector3(c.x,c.y,.5).unproject(s.camera).sub(s.camera.position).normalize()),m=new THREE.Ray(p,h),f=m.intersectPlane(u);if(f){sceneTargetNormal=f.clone().sub(n).normalize();var g,v;e===s.parts.ROTATE_X?(g=2*Math.PI+Math.atan2(r.y,-r.z),v=4*Math.PI+Math.atan2(sceneTargetNormal.y,-sceneTargetNormal.z)):e===s.parts.ROTATE_Y?(g=2*Math.PI+Math.atan2(-r.z,r.x),v=4*Math.PI+Math.atan2(-sceneTargetNormal.z,sceneTargetNormal.x)):e===s.parts.ROTATE_Z&&(g=2*Math.PI+Math.atan2(r.x,r.y),v=4*Math.PI+Math.atan2(sceneTargetNormal.x,sceneTargetNormal.y));for(var y=v-g,E=0;E<s.targets.length;E++){var T=s.targets[E],b=s.dragstart.rotations[E];T.rotation.copy(b);var P=new THREE.Quaternion;P.setFromAxisAngle(o,y),T.quaternion.multiplyQuaternions(P,T.quaternion)}}},f=function(e){};return u.addEventListener("mousemove",p),u.addEventListener("mouseleave",h),u.addEventListener("mousedrag",m),u.addEventListener("drop",f),u},this.createScaleHandle=function(e,t){var o=new THREE.BoxGeometry(1,1,1),i=new THREE.MeshBasicMaterial({color:t,depthTest:!1,depthWrite:!1}),n=new THREE.Mesh(o,i);n.scale.set(.3,.3,.3),n.position.set(0,3,0);var r=new THREE.Geometry;r.vertices.push(new THREE.Vector3(0,0,0)),r.vertices.push(new THREE.Vector3(0,3,0));var a=new THREE.LineBasicMaterial({color:t,depthTest:!1,depthWrite:!1}),l=new THREE.Line(r,a),d=new THREE.Object3D;d.add(n),d.add(l),d.partID=e;var c=function(e){a.color.setRGB(1,1,0),i.color.setRGB(1,1,0)},u=function(e){a.color.setHex(t),i.color.setHex(t)},p=function(t){var o=new THREE.Vector3;e===s.parts.SCALE_X?o.x=1:e===s.parts.SCALE_Y?o.y=1:e===s.parts.SCALE_Z&&(o.z=-1);var i=s.dragstart.sceneClickPos.clone();i.multiply(o),i.z*=-1;var n=s.dragstart.sceneStartPos.clone().project(s.camera),r=s.dragstart.sceneStartPos.clone().add(o).project(s.camera),a=n.clone(),l=r.clone().sub(n);l.normalize();var d=new THREE.Vector3(s.dragstart.mousePos.x,s.dragstart.mousePos.y,0),c=new THREE.Vector3(s.mouse.x,s.mouse.y,0),u=(new THREE.Vector3).subVectors(c,d).dot(l),p=l.clone().multiplyScalar(u).add(a);p.unproject(s.camera);var h=s.sceneRoot.position.clone().sub(p);h.multiply(new THREE.Vector3(-1,-1,1));for(var m=0;m<s.targets.length;m++){var f=s.targets[m],g=s.dragstart.scales[m];f.scale.copy(g).add(h),f.scale.x=Math.max(f.scale.x,.01),f.scale.y=Math.max(f.scale.y,.01),f.scale.z=Math.max(f.scale.z,.01)}t.event.stopImmediatePropagation()},h=function(e){i.color.set(t)};return n.addEventListener("mousemove",c),n.addEventListener("mouseleave",u),n.addEventListener("mousedrag",p),n.addEventListener("drop",h),l.addEventListener("mousemove",c),l.addEventListener("mouseleave",u),l.addEventListener("mousedrag",p),l.addEventListener("drop",h),d},this.createArrow=function(e,t){var o=new THREE.MeshBasicMaterial({color:t,depthTest:!1,depthWrite:!1}),i=new THREE.Geometry;i.vertices.push(new THREE.Vector3(0,0,0)),i.vertices.push(new THREE.Vector3(0,3,0));var n=new THREE.LineBasicMaterial({color:t,depthTest:!1,depthWrite:!1}),r=new THREE.Line(i,n),a=new THREE.CylinderGeometry(0,.2,.5,10,1,!1),l=o,d=new THREE.Mesh(a,l);d.position.y=3;var c=new THREE.Object3D;c.add(r),c.add(d),c.partID=e,c.material=o;var u=function(e){l.color.setRGB(1,1,0),n.color.setRGB(1,1,0)},p=function(e){l.color.set(t),n.color.set(t)},h=function(t){var o=new THREE.Vector3;e===s.parts.ARROW_X?o.x=1:e===s.parts.ARROW_Y?o.y=1:e===s.parts.ARROW_Z&&(o.z=-1);var i=s.dragstart.sceneClickPos.clone();i.multiply(o),i.z*=-1;var n=s.dragstart.sceneStartPos.clone().project(s.camera),r=s.dragstart.sceneStartPos.clone().add(o).project(s.camera),a=n.clone(),l=r.clone().sub(n);l.normalize();var d=new THREE.Vector3(s.dragstart.mousePos.x,s.dragstart.mousePos.y,0),c=new THREE.Vector3(s.mouse.x,s.mouse.y,0),u=(new THREE.Vector3).subVectors(c,d).dot(l),p=l.clone().multiplyScalar(u).add(a);p.unproject(s.camera);var h=s.sceneRoot.position.clone();i.clone().sub(s.dragstart.sceneStartPos);s.sceneRoot.position.copy(p),h.sub(s.sceneRoot.position);for(var m=0;m<s.targets.length;m++){var f=s.targets[m];f.position.sub(h)}t.event.stopImmediatePropagation()},m=function(e){n.color.set(t)};return r.addEventListener("mousemove",u),d.addEventListener("mousemove",u),r.addEventListener("mouseleave",p),d.addEventListener("mouseleave",p),r.addEventListener("mousedrag",h),d.addEventListener("mousedrag",h),r.addEventListener("drop",m),d.addEventListener("drop",m),c},this.setTargets=function(e){if(s.targets=e,0===s.targets.length)return this.sceneRoot.visible=!1,void(this.sceneRotation.visible=!1);this.sceneRoot.visible=!0;var t,o=e[0];if(t=o.geometry&&o.geometry.boundingBox?o.geometry.boundingBox:o.boundingBox){var i=t.clone().applyMatrix4(o.matrixWorld).center();s.sceneRoot.position.copy(i)}},this.getBoundingBox=function(){for(var e=new THREE.Box3,t=0;t<s.targets.length;t++){var o,i=s.targets[t];i.boundingBox?o=i.boundingBox:i.boundingSphere?o=i.boundingSphere.getBoundingBox():i.geometry&&(i.geometry.boundingBox?o=i.geometry.boundingBox:i.geometry.boundingSphere&&(o=i.geometry.boundingSphere.getBoundingBox())),o=Potree.utils.computeTransformedBoundingBox(o,i.matrixWorld),e.union(o)}return e},this.update=function(){var e=this.sceneRoot,o=e.getWorldPosition().applyMatrix4(this.camera.matrixWorldInverse),i=(new THREE.Vector4(o.x,o.y,o.z).applyMatrix4(t.projectionMatrix),Math.abs(o.z/20));e.scale.set(i,i,i),this.targets&&1===this.targets.length&&this.scaleNode.rotation.copy(this.targets[0].rotation),this.sceneRotation.scale.set(i,i,i)},this.render=function(){this.update(),this.sceneRotation.position.copy(this.sceneRoot.position),this.sceneRotation.visible=this.rotationNode.visible&&this.sceneRoot.visible,o.render(this.sceneRotation,this.camera),o.render(this.sceneTransformation,this.camera)},this.translate=function(){this.translationNode.visible=!0,this.scaleNode.visible=!1,this.rotationNode.visible=!1},this.scale=function(){this.translationNode.visible=!1,this.scaleNode.visible=!0,this.rotationNode.visible=!1},this.rotate=function(){this.translationNode.visible=!1,this.scaleNode.visible=!1,this.rotationNode.visible=!0},this.reset=function(){this.setTargets([])},this.buildTranslationNode(),this.buildScaleNode(),this.buildRotationNode(),this.rotate(),this.setTargets([]),this.domElement.addEventListener("mousemove",i,!0),this.domElement.addEventListener("mousedown",n,!0),this.domElement.addEventListener("mouseup",r,!0)},Potree.Volume=function(e){THREE.Object3D.call(this),e=e||{},this._clip=e.clip||!1,this._modifiable=e.modifiable||!0;var t=new THREE.BoxGeometry(1,1,1);t.computeBoundingBox();var o=new THREE.Geometry;o.vertices.push(new THREE.Vector3(-.5,-.5,.5)),o.vertices.push(new THREE.Vector3(.5,-.5,.5)),o.vertices.push(new THREE.Vector3(.5,-.5,.5)),o.vertices.push(new THREE.Vector3(.5,-.5,-.5)),o.vertices.push(new THREE.Vector3(.5,-.5,-.5)),o.vertices.push(new THREE.Vector3(-.5,-.5,-.5)),o.vertices.push(new THREE.Vector3(-.5,-.5,-.5)),o.vertices.push(new THREE.Vector3(-.5,-.5,.5)),o.vertices.push(new THREE.Vector3(-.5,.5,.5)),o.vertices.push(new THREE.Vector3(.5,.5,.5)),o.vertices.push(new THREE.Vector3(.5,.5,.5)),o.vertices.push(new THREE.Vector3(.5,.5,-.5)),o.vertices.push(new THREE.Vector3(.5,.5,-.5)),o.vertices.push(new THREE.Vector3(-.5,.5,-.5)),o.vertices.push(new THREE.Vector3(-.5,.5,-.5)),o.vertices.push(new THREE.Vector3(-.5,.5,.5)),o.vertices.push(new THREE.Vector3(-.5,-.5,.5)),o.vertices.push(new THREE.Vector3(-.5,.5,.5)),o.vertices.push(new THREE.Vector3(.5,-.5,.5)),o.vertices.push(new THREE.Vector3(.5,.5,.5)),o.vertices.push(new THREE.Vector3(.5,-.5,-.5)),o.vertices.push(new THREE.Vector3(.5,.5,-.5)),o.vertices.push(new THREE.Vector3(-.5,-.5,-.5)),o.vertices.push(new THREE.Vector3(-.5,.5,-.5)),this.dimension=new THREE.Vector3(1,1,1);var i=new THREE.MeshBasicMaterial({color:65280,transparent:!0,opacity:.3,depthTest:!0,depthWrite:!0});this.box=new THREE.Mesh(t,i),this.box.geometry.computeBoundingBox(),this.boundingBox=this.box.geometry.boundingBox,this.add(this.box),this.frame=new THREE.Line(o,new THREE.LineBasicMaterial({color:0})),this.frame.mode=THREE.LinePieces,this.add(this.frame),this.label=new Potree.TextSprite("0"),this.label.setBorderColor({r:0,g:255,b:0,a:0}),this.label.setBackgroundColor({r:0,g:255,b:0,a:0}),this.label.material.depthTest=!1,this.label.material.depthWrite=!1,this.label.material.transparent=!0,this.label.position.y-=.5,this.add(this.label);var n=this;this.label.updateMatrixWorld=function(){var e=new THREE.Vector3;e.setFromMatrixPosition(n.matrixWorld),n.label.position.copy(e),n.label.updateMatrix(),n.label.matrixWorld.copy(n.label.matrix),n.label.matrixWorldNeedsUpdate=!1;for(var t=0,o=n.label.children.length;o>t;t++)n.label.children[t].updateMatrixWorld(!0)},this.setDimension=function(e,t,o){this.dimension.set(e,t,o),this.box.scale.set(e,t,o),this.frame.scale.set(e,t,o)},this.volume=function(){return Math.abs(this.scale.x*this.scale.y*this.scale.z)},this.update=function(){this.boundingBox=this.box.geometry.boundingBox,this.boundingSphere=this.boundingBox.getBoundingSphere(),this._clip?(this.box.visible=!1,this.label.visible=!1):(this.box.visible=!0,this.label.visible=!0)},this.raycast=function(e,t){var o=[];if(this.box.raycast(e,o),o.length>0){var i=o[0];t.push({distance:i.distance,object:this,point:i.point.clone()})}},this.update()},Potree.Volume.prototype=Object.create(THREE.Object3D.prototype),Object.defineProperty(Potree.Volume.prototype,"clip",{get:function(){return this._clip},set:function(e){this._clip=e,this.update()}}),Object.defineProperty(Potree.Volume.prototype,"modifiable",{get:function(){return this._modifiable},set:function(e){this._modifiable=e,this.update()}}),Potree.VolumeTool=function(e,t,o,i){function n(e){var t=c.domElement.getBoundingClientRect();c.mouse.x=(e.clientX-t.left)/c.domElement.clientWidth*2-1,c.mouse.y=2*-((e.clientY-t.top)/c.domElement.clientHeight)+1}function r(e){}function a(e){if(p!==u.DEFAULT&&e.stopImmediatePropagation(),p===u.INSERT_VOLUME)c.finishInsertion();else if(1===e.which){var t=l();t&&t.object.modifiable&&c.transformationTool.setTargets([t.object])}3===e.which}function s(e){return e.preventDefault(),!1}function l(){var e=new THREE.Vector3(c.mouse.x,c.mouse.y,.5);e.unproject(c.camera);var t=new THREE.Raycaster;t.ray.set(c.camera.position,e.sub(c.camera.position).normalize());for(var o=[],i=0;i<c.volumes.length;i++){var n=c.volumes[i];o.push(n)}var r=t.intersectObjects(o,!1);return r.length>0?r[0]:!1}function d(){var e=new THREE.Vector3(c.mouse.x,c.mouse.y,.5);e.unproject(c.camera);var t=e.sub(c.camera.position).normalize(),o=new THREE.Ray(c.camera.position,t),i=[];c.scene.traverse(function(e){(e instanceof Potree.PointCloudOctree||e instanceof Potree.PointCloudArena4D)&&i.push(e)});for(var n=null,r=null,a=0;a<i.length;a++){var s=i[a],l=s.pick(c.renderer,c.camera,o);if(l){var d=c.camera.position.distanceTo(l.position);(!n||r>d)&&(n=l,r=d)}}return n?n.position:null}var c=this;this.enabled=!1,this.scene=e,this.sceneVolume=new THREE.Scene,this.camera=t,this.renderer=o,this.transformationTool=i,this.domElement=this.renderer.domElement,this.mouse={x:0,y:0},this.volumes=[];var u={DEFAULT:0,INSERT_VOLUME:1},p=u.DEFAULT;this.update=function(e){if(p===u.INSERT_VOLUME){var t=d();if(t){this.activeVolume.position.copy(t);var o=this.activeVolume.getWorldPosition().applyMatrix4(this.camera.matrixWorldInverse),i=(new THREE.Vector4(o.x,o.y,o.z).applyMatrix4(this.camera.projectionMatrix),Math.abs(o.z/10));this.activeVolume.scale.set(i,i,i)}}for(var n=[],r=0;r<this.volumes.length;r++)n.push(this.volumes[r]);this.activeVolume&&n.push(this.activeVolume);for(var r=0;r<n.length;r++){var a=n[r],s=(a.box,a.label),l=a.volume(),h=Potree.utils.addCommas(l.toFixed(1))+"";s.setText(h);var m=c.camera.position.distanceTo(s.getWorldPosition()),f=projectedRadius(1,c.camera.fov*Math.PI/180,m,c.renderer.domElement.clientHeight),g=70/f;s.scale.set(g,g,g)}},this.startInsertion=function(e){p=u.INSERT_VOLUME;var e=e||{},t=e.clip||!1;this.activeVolume=new Potree.Volume,this.activeVolume.clip=t,this.sceneVolume.add(this.activeVolume),this.volumes.push(this.activeVolume)},this.finishInsertion=function(){c.transformationTool.setTargets([this.activeVolume]);var e={type:"insertion_finished",volume:this.activeVolume};this.dispatchEvent(e),this.activeVolume=null,p=u.DEFAULT},this.addVolume=function(e){this.sceneVolume.add(e),this.volumes.push(e)},this.removeVolume=function(e){this.sceneVolume.remove(e);var t=this.volumes.indexOf(e);t>=0&&this.volumes.splice(t,1)},this.reset=function(){for(var e=this.volumes.length-1;e>=0;e--){var t=this.volumes[e];this.removeVolume(t)}},this.render=function(e){c.renderer.render(this.sceneVolume,this.camera,e)},this.domElement.addEventListener("click",r,!1),this.domElement.addEventListener("mousedown",a,!1),this.domElement.addEventListener("mousemove",n,!1),this.domElement.addEventListener("contextmenu",s,!1)},Potree.VolumeTool.prototype=Object.create(THREE.EventDispatcher.prototype),Potree.PointCloudArena4DNode=function(){this.left=null,this.right=null,this.sceneNode=null,this.kdtree=null,this.getNumPoints=function(){return this.geometryNode.numPoints},this.isLoaded=function(){return!0},this.isTreeNode=function(){return!0},this.isGeometryNode=function(){return!1},this.getLevel=function(){return this.geometryNode.level},this.getBoundingSphere=function(){return this.geometryNode.boundingSphere},this.getBoundingBox=function(){return this.geometryNode.boundingBox},this.toTreeNode=function(e){var t=null;if(this.left===e?t=this.left:this.right===e&&(t=this.right),t.loaded){var o=new Potree.PointCloudArena4DNode,i=THREE.PointCloud(t.geometry,this.kdtree.material);i.visible=!1,o.kdtree=this.kdtree,o.geometryNode=t,o.sceneNode=i,o.parent=this,o.left=this.geometryNode.left,o.right=this.geometryNode.right}},this.getChildren=function(){var e=[];return this.left&&e.push(this.left),this.right&&e.push(this.right),e}},Potree.PointCloudOctreeNode.prototype=Object.create(Potree.PointCloudTreeNode.prototype),Potree.PointCloudArena4D=function(e){THREE.Object3D.call(this);var t=this;this.root=null,e.root?this.root=e.root:e.addEventListener("hierarchy_loaded",function(){t.root=e.root}),this.visiblePointsTarget=2e6,this.minimumNodePixelSize=150,this.position.sub(e.offset),this.updateMatrix(),this.numVisibleNodes=0,this.numVisiblePoints=0,this.boundingBoxNodes=[],this.loadQueue=[],this.visibleNodes=[],this.pcoGeometry=e,this.boundingBox=this.pcoGeometry.boundingBox,this.boundingSphere=this.pcoGeometry.boundingSphere,this.material=new Potree.PointCloudMaterial({vertexColors:THREE.VertexColors,size:.05,treeType:Potree.TreeType.KDTREE}),this.material.sizeType=Potree.PointSizeType.ATTENUATED,this.material.size=.05,this.profileRequests=[],this.name="",this.pickTarget,this.pickMaterial,this.updateMatrixWorld()},Potree.PointCloudArena4D.prototype=new Potree.PointCloudTree,Potree.PointCloudOctree.prototype.setName=function(e){this.name!==e&&(this.name=e,this.dispatchEvent({type:"name_changed",name:e,pointcloud:this}))},Potree.PointCloudOctree.prototype.getName=function(){return this.name},Potree.PointCloudArena4D.prototype.toTreeNode=function(e,t){var o=new Potree.PointCloudArena4DNode,i=new THREE.PointCloud(e.geometry,pointcloud.material);o.geometryNode=e,o.sceneNode=i,o.pointcloud=pointcloud,o.left=e.left,o.right=e.right,t?(t.sceneNode.add(i),t.left===e?t.left=o:t.right===e&&(t.right=o)):(this.root=o,this.add(i));var n=function(){t.sceneNode.remove(o.sceneNode),t.left===o?t.left=e:t.right===o&&(t.right=e)};return e.oneTimeDisposeHandlers.push(n),o},Potree.PointCloudArena4D.prototype.updateMaterial=function(e,t,o,i){e.fov=o.fov*(Math.PI/180),e.screenWidth=i.domElement.clientWidth,e.screenHeight=i.domElement.clientHeight,e.spacing=this.pcoGeometry.spacing,e.near=o.near,e.far=o.far,this.maxLevel>e.levels&&(e.levels=this.maxLevel+2);var n=this.boundingBox.size();e.bbSize=[n.x,n.y,n.z],e.pointSizeType&&(e.pointSizeType===Potree.PointSizeType.ADAPTIVE||e.pointColorType===Potree.PointColorType.LOD)&&this.updateVisibilityTexture(e,t)},Potree.PointCloudArena4D.prototype.updateVisibleBounds=function(){},Potree.PointCloudArena4D.prototype.hideDescendants=function(e){for(var t=[],o=0;o<e.children.length;o++){var i=e.children[o];i.visible&&t.push(i)}for(;t.length>0;){var e=t.shift();e.visible=!1,e.boundingBoxNode&&(e.boundingBoxNode.visible=!1);for(var o=0;o<e.children.length;o++){var i=e.children[o];i.visible&&t.push(i)}}},Potree.PointCloudArena4D.prototype.updateMatrixWorld=function(e){this.matrixAutoUpdate===!0&&this.updateMatrix(),(this.matrixWorldNeedsUpdate===!0||e===!0)&&(void 0===this.parent?this.matrixWorld.copy(this.matrix):this.matrixWorld.multiplyMatrices(this.parent.matrixWorld,this.matrix),this.matrixWorldNeedsUpdate=!1,e=!0)},Potree.PointCloudArena4D.prototype.nodesOnRay=function(e,t){for(var o=[],i=t.clone(),n=0;n<e.length;n++){var r=e[n],a=(r.getBoundingSphere().clone().applyMatrix4(r.sceneNode.matrixWorld),r.getBoundingBox().clone().applyMatrix4(r.sceneNode.matrixWorld));i.isIntersectionBox(a)&&o.push(r)}return o},Potree.PointCloudArena4D.prototype.pick=function(e,t,o,i){var i=i||{},n=i.pickWindowSize||17,r=i.pickOutsideClipRegion||!1,a=this.nodesOnRay(this.visibleNodes,o);if(0===a.length)return null;var s=Math.ceil(e.domElement.clientWidth),l=Math.ceil(e.domElement.clientHeight),d=(new THREE.Vector3).addVectors(t.position,o.direction).project(t);d.addScalar(1).multiplyScalar(.5),d.x*=s,d.y*=l,this.pickTarget?(this.pickTarget.width!=s||this.pickTarget.height!=l)&&(this.pickTarget.dispose(),this.pickTarget=new THREE.WebGLRenderTarget(1,1,{minFilter:THREE.LinearFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat})):this.pickTarget=new THREE.WebGLRenderTarget(1,1,{minFilter:THREE.LinearFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat}),this.pickTarget.setSize(s,l),this.pickMaterial||(this.pickMaterial=new Potree.PointCloudMaterial({treeType:Potree.TreeType.KDTREE}),this.pickMaterial.pointColorType=Potree.PointColorType.POINT_INDEX,this.pickMaterial.pointSizeType=Potree.PointSizeType.FIXED),this.pickMaterial.pointSizeType=this.material.pointSizeType,this.pickMaterial.size=this.material.size,this.pickMaterial.pointSizeType===Potree.PointSizeType.ADAPTIVE&&this.updateVisibilityTexture(this.pickMaterial,a),this.pickMaterial.fov=this.material.fov,this.pickMaterial.screenWidth=this.material.screenWidth,this.pickMaterial.screenHeight=this.material.screenHeight,this.pickMaterial.spacing=this.material.spacing,this.pickMaterial.near=this.material.near,this.pickMaterial.far=this.material.far,this.pickMaterial.levels=this.material.levels,this.pickMaterial.pointShape=this.material.pointShape,this.pickMaterial.minSize=this.material.minSize,this.pickMaterial.maxSize=this.material.maxSize,r?this.pickMaterial.clipMode=Potree.ClipMode.DISABLED:(this.pickMaterial.clipMode=this.material.clipMode,this.material.clipMode===Potree.ClipMode.CLIP_OUTSIDE?this.pickMaterial.setClipBoxes(this.material.clipBoxes):this.pickMaterial.setClipBoxes([]));var c=e.context;c.enable(c.SCISSOR_TEST),c.scissor(d.x-(n-1)/2,d.y-(n-1)/2,n,n),c.disable(c.SCISSOR_TEST);var u=this.pickMaterial;e.setRenderTarget(this.pickTarget),e.state.setDepthTest(u.depthTest),e.state.setDepthWrite(u.depthWrite),e.state.setBlending(THREE.NoBlending),e.clear(e.autoClearColor,e.autoClearDepth,e.autoClearStencil),a.length>0&&a.push(a[0]);for(var p=0;p<a.length;p++){var h=a[p].sceneNode,m=h.geometry;if(m.attributes.indices.buffer){if(u.pcIndex=p,u.program){var f=u.program.program;c.useProgram(f);var g=c.getAttribLocation(f,"indices"),v=4;c.bindBuffer(c.ARRAY_BUFFER,m.attributes.indices.buffer),c.enableVertexAttribArray(g),c.vertexAttribPointer(g,v,c.UNSIGNED_BYTE,!0,0,0),c.uniform1f(u.program.uniforms.pcIndex,u.pcIndex)}e.renderBufferDirect(t,[],null,u,m,h)}}var n=17,y=n*n,E=new ArrayBuffer(4*y),T=new Uint8Array(E),b=new Uint32Array(E);e.context.readPixels(d.x-(n-1)/2,d.y-(n-1)/2,n,n,e.context.RGBA,e.context.UNSIGNED_BYTE,T);for(var P=Number.MAX_VALUE,R=null,x=0;n>x;x++)for(var w=0;n>w;w++){var C=x+w*n,S=Math.pow(x-(n-1)/2,2)+Math.pow(w-(n-1)/2,2),H=T[4*C+3];T[4*C+3]=0;var B=b[C];(0!==B||0!==H)&&P>S&&(R={pIndex:B,pcIndex:H},P=S)}if(R){var M={},A=a[R.pcIndex],m=A.sceneNode.geometry,I=m.attributes;for(var V in I)if(I.hasOwnProperty(V)){var L=m.attributes[V];if("position"===V){var N=m.attributes.position.array,D=N[3*R.pIndex+0],z=N[3*R.pIndex+1],G=N[3*R.pIndex+2],_=new THREE.Vector3(D,z,G);_.applyMatrix4(this.matrixWorld),M[V]=_}else if("indices"===V);else if(1===L.itemSize)M[V]=L.array[p+O];else{for(var k=[],O=0;O<L.itemSize;O++)k.push(L.array[p*L.itemSize+O]);M[V]=k}}return M}return null},Potree.PointCloudArena4D.prototype.updateVisibilityTexture=function(e,t){if(e){var o=e.visibleNodesTexture,i=o.image.data;t=t.slice();var n=function(e,t){var o=e.geometryNode.level,i=t.geometryNode.level,n=e.geometryNode.number,r=t.geometryNode.number;return o!=i?o-i:r>n?-1:n>r?1:0};t.sort(n);for(var r=[],a=0;a<t.length;a++)r.push(t[a].geometryNode.number);for(var a=0;a<t.length;a++){var s=t[a],l=0,d=0,c=0;s.geometryNode.left&&r.indexOf(s.geometryNode.left.number)>0&&(l+=1,d=r.indexOf(s.geometryNode.left.number)-a),s.geometryNode.right&&r.indexOf(s.geometryNode.right.number)>0&&(l+=2,d=0===d?r.indexOf(s.geometryNode.right.number)-a:d),"X"===s.geometryNode.split?c=1:"Y"===s.geometryNode.split?c=2:"Z"===s.geometryNode.split&&(c=4),i[3*a+0]=l,i[3*a+1]=d,i[3*a+2]=c}o.needsUpdate=!0}},Object.defineProperty(Potree.PointCloudArena4D.prototype,"progress",{get:function(){return this.pcoGeometry.root?Potree.PointCloudArena4DGeometryNode.nodesLoading>0?0:1:0}}),Potree.PointCloudArena4DGeometryNode=function(){this.left=null,this.right=null,this.boundingBox=null,this.number=null,this.pcoGeometry=null,this.loaded=!1,this.numPoints=0,this.level=0,this.children=[],this.oneTimeDisposeHandlers=[]},Potree.PointCloudArena4DGeometryNode.nodesLoading=0,Potree.PointCloudArena4DGeometryNode.prototype.isGeometryNode=function(){return!0},Potree.PointCloudArena4DGeometryNode.prototype.isTreeNode=function(){return!1},Potree.PointCloudArena4DGeometryNode.prototype.isLoaded=function(){return this.loaded},Potree.PointCloudArena4DGeometryNode.prototype.getBoundingSphere=function(){return this.boundingSphere},Potree.PointCloudArena4DGeometryNode.prototype.getBoundingBox=function(){return this.boundingBox},Potree.PointCloudArena4DGeometryNode.prototype.getChildren=function(){var e=[];return this.left&&e.push(this.left),this.right&&e.push(this.right),e},Potree.PointCloudArena4DGeometryNode.prototype.getBoundingBox=function(){return this.boundingBox},Potree.PointCloudArena4DGeometryNode.prototype.load=function(){if(!(this.loaded||this.loading||Potree.PointCloudArena4DGeometryNode.nodesLoading>=5)){this.loading=!0,Potree.PointCloudArena4DGeometryNode.nodesLoading++;var e=this.pcoGeometry.url+"?node="+this.number,t=new XMLHttpRequest;t.open("GET",e,!0),t.responseType="arraybuffer";var o=this;t.onreadystatechange=function(){if(4===t.readyState&&200===t.status){for(var e=t.response,i=new DataView(e),n=e.byteLength/17,r=new Float32Array(3*n),a=new Float32Array(3*n),s=new Uint32Array(n),l=0;n>l;l++){var d=i.getFloat32(17*l+0,!0)+o.boundingBox.min.x,c=i.getFloat32(17*l+4,!0)+o.boundingBox.min.y,u=i.getFloat32(17*l+8,!0)+o.boundingBox.min.z,p=i.getUint8(17*l+12,!0)/256,h=i.getUint8(17*l+13,!0)/256,m=i.getUint8(17*l+14,!0)/256;r[3*l+0]=d,r[3*l+1]=c,r[3*l+2]=u,a[3*l+0]=p,a[3*l+1]=h,a[3*l+2]=m,s[l]=l}var f=new THREE.BufferGeometry;f.addAttribute("position",new THREE.BufferAttribute(r,3)),f.addAttribute("color",new THREE.BufferAttribute(a,3)),f.addAttribute("indices",new THREE.BufferAttribute(s,1)),f.addAttribute("normal",new THREE.BufferAttribute(new Float32Array(3*n),3)),o.geometry=f,o.loaded=!0,Potree.PointCloudArena4DGeometryNode.nodesLoading--,f.boundingBox=o.boundingBox,f.boundingSphere=o.boundingSphere,o.numPoints=n,o.loading=!1}},t.send(null)}},Potree.PointCloudArena4DGeometryNode.prototype.dispose=function(){if(this.geometry&&null!=this.parent){this.geometry.dispose(),this.geometry=null,this.loaded=!1;for(var e=0;e<this.oneTimeDisposeHandlers.length;e++){var t=this.oneTimeDisposeHandlers[e];t()}this.oneTimeDisposeHandlers=[]}},Potree.PointCloudArena4DGeometryNode.prototype.getNumPoints=function(){return this.numPoints},Potree.PointCloudArena4DGeometry=function(){this.numPoints=0,this.version=0,this.boundingBox=null,this.numNodes=0,this.name=null,this.provider=null,this.url=null,this.root=null,this.levels=0,this._spacing=null,this.pointAttributes=new Potree.PointAttributes(["POSITION_CARTESIAN","COLOR_PACKED"])},Potree.PointCloudArena4DGeometry.prototype=Object.create(THREE.EventDispatcher.prototype),Potree.PointCloudArena4DGeometry.load=function(e,t){var o=new XMLHttpRequest;o.open("GET",e+"?info",!0),o.onreadystatechange=function(){try{if(4===o.readyState&&200===o.status){var i=JSON.parse(o.responseText),n=new Potree.PointCloudArena4DGeometry;n.url=e,n.name=i.Name,n.provider=i.Provider,n.numNodes=i.Nodes,n.numPoints=i.Points,n.version=i.Version,n.boundingBox=new THREE.Box3((new THREE.Vector3).fromArray(i.BoundingBox.slice(0,3)),(new THREE.Vector3).fromArray(i.BoundingBox.slice(3,6))),i.Spacing&&(n.spacing=i.Spacing);var r=n.boundingBox.min.clone().multiplyScalar(-1);n.boundingBox.min.add(r),n.boundingBox.max.add(r),n.offset=r;var a=n.boundingBox.center(),s=n.boundingBox.size().length()/2;n.boundingSphere=new THREE.Sphere(a,s),n.loadHierarchy(),t(n)}else 4===o.readyState&&t(null)}catch(l){console.error(l.message),t(null)}},o.send(null)},Potree.PointCloudArena4DGeometry.prototype.loadHierarchy=function(){var e=this.url+"?tree",t=new XMLHttpRequest;t.open("GET",e,!0),t.responseType="arraybuffer";var o=this;t.onreadystatechange=function(){if(4===t.readyState&&200===t.status){for(var e=t.response,i=e.byteLength/3,n=new DataView(e),r=[],a=null,s=0,l=((new Date).getTime(),0);i>l;l++){var d=n.getUint8(3*l+0,!0),c=(n.getUint16(3*l+1,!0),(1&d)>0),u=(2&d)>0,p=(4&d)>0,h=(8&d)>0,m=(16&d)>0,f=null;p?f="X":h&&(f="Y"),m&&(f="Z");var g=new Potree.PointCloudArena4DGeometryNode;if(g.hasLeft=c,g.hasRight=u,g.split=f,g.isLeaf=!c&&!u,g.number=l,g.left=null,g.right=null,g.pcoGeometry=o,g.level=r.length,s=Math.max(s,g.level),r.length>0){var v=r[r.length-1];g.boundingBox=v.boundingBox.clone();var y=v.boundingBox.size();if(v.hasLeft&&!v.left){v.left=g,v.children.push(g),"X"===v.split?g.boundingBox.max.x=g.boundingBox.min.x+y.x/2:"Y"===v.split?g.boundingBox.max.y=g.boundingBox.min.y+y.y/2:"Z"===v.split&&(g.boundingBox.max.z=g.boundingBox.min.z+y.z/2);var E=g.boundingBox.center(),T=g.boundingBox.size().length()/2;g.boundingSphere=new THREE.Sphere(E,T)}else{v.right=g,v.children.push(g),"X"===v.split?g.boundingBox.min.x=g.boundingBox.min.x+y.x/2:"Y"===v.split?g.boundingBox.min.y=g.boundingBox.min.y+y.y/2:"Z"===v.split&&(g.boundingBox.min.z=g.boundingBox.min.z+y.z/2);var E=g.boundingBox.center(),T=g.boundingBox.size().length()/2;g.boundingSphere=new THREE.Sphere(E,T)}}else{a=g,a.boundingBox=o.boundingBox.clone();var E=a.boundingBox.center(),T=a.boundingBox.size().length()/2;a.boundingSphere=new THREE.Sphere(E,T)}var b=g.boundingBox.size();if(g.spacing=(b.x+b.y+b.z)/3/75,r.push(g),g.isLeaf)for(var P=!1;!P&&r.length>0;){r.pop();var R=r[r.length-1];P=r.length>0&&R.hasRight&&null==R.right}}(new Date).getTime();o.root=a,o.levels=s,o.dispatchEvent({type:"hierarchy_loaded"})}},t.send(null)},Object.defineProperty(Potree.PointCloudArena4DGeometry.prototype,"spacing",{get:function(){return this._spacing?this._spacing:this.root?this.root.spacing:void 0;
},set:function(e){this._spacing=e}}),ProgressBar.prototype.hide=function(){this.element.style.opacity=0,this.element.style.transition="all 0.2s ease"},ProgressBar.prototype.show=function(){this.element.style.opacity=this.maxOpacity,this.element.style.transition="all 0.2s ease"},Object.defineProperty(ProgressBar.prototype,"progress",{get:function(){return this._progress},set:function(e){this._progress=e,this.elProgress.style.width=100*e+"%"}}),Object.defineProperty(ProgressBar.prototype,"message",{get:function(){return this._message},set:function(e){this._message=e,this.elProgressMessage.innerHTML=e}}),Potree.Viewer=function(e,t){function o(e){69===e.keyCode?n.transformationTool.translate():82===e.keyCode?n.transformationTool.scale():84===e.keyCode&&n.transformationTool.rotate()}function i(e){requestAnimationFrame(i),n.update(l.getDelta(),e),n.useEDL&&Potree.Features.SHADER_EDL.isSupported()?(h||(h=new m),h.render(n.renderer)):"Splats"===n.quality?(u||(u=new p),u.render(n.renderer)):c.render()}var n=this,r=t||{},a=r.onPointCloudLoaded||function(){};this.renderArea=e,this.annotations=[],this.fov=60,this.pointSize=1,this.minPointSize=1,this.maxPointSize=50,this.opacity=1,this.sizeType="Fixed",this.pointSizeType=Potree.PointSizeType.FIXED,this.pointColorType=null,this.clipMode=Potree.ClipMode.HIGHLIGHT_INSIDE,this.quality="Squares",this.isFlipYZ=!1,this.useDEMCollisions=!1,this.minNodeSize=100,this.directionalLight,this.edlScale=1,this.edlRadius=3,this.useEDL=!1,this.minimumJumpDistance=.2,this.jumpDistance=null,this.intensityMax=null,this.heightMin=null,this.heightMax=null,this.moveSpeed=10,this.showDebugInfos=!1,this.showStats=!0,this.showBoundingBox=!1,this.freeze=!1,this.fpControls,this.orbitControls,this.earthControls,this.geoControls,this.controls,this.progressBar=new ProgressBar;this.renderer,this.camera,this.scene,this.scenePointCloud,this.sceneBG,this.cameraBG,this.pointclouds=[],this.measuringTool,this.volumeTool,this.transformationTool;var s,l=new THREE.Clock;this.showSkybox=!1,this.referenceFrame,this.addPointCloud=function(e,t){t=t||function(){};var o=function(e){n.mapView||e.projection&&(n.mapView=new Potree.Viewer.MapView(viewer),n.mapView.init(viewer)),n.pointclouds.push(e),n.referenceFrame.add(e);var o=e.boundingSphere.clone().applyMatrix4(e.matrixWorld);if(n.referenceFrame.updateMatrixWorld(!0),o.radius>5e4?n.camera.near=10:o.radius>1e4?n.camera.near=2:o.radius>1e3?n.camera.near=1:o.radius>100?n.camera.near=.5:n.camera.near=.1,1===n.pointclouds.length){n.referenceFrame.position.sub(o.center),n.referenceFrame.updateMatrixWorld(!0);var i=o.radius/6;n.setMoveSpeed(i)}n.zoomTo(e,1);var r=n.getHeightRange();if(null===r.min||null===r.max){var a=n.getBoundingBox();n.setHeightRange(a.min.y,a.max.y)}n.earthControls.pointclouds.push(e),1===n.pointclouds.length&&(n.setNavigationMode("Orbit"),n.flipYZ(),n.zoomTo(e,1)),n.dispatchEvent({type:"pointcloud_loaded",pointcloud:e}),t({type:"pointclouad_loaded",pointcloud:e})};this.addEventListener("pointcloud_loaded",a),e&&(e.indexOf("cloud.js")>0?Potree.POCLoader.load(e,function(e){e?(pointcloud=new Potree.PointCloudOctree(e),o(pointcloud)):t({type:"loading_failed"})}):e.indexOf(".vpc")>0?Potree.PointCloudArena4DGeometry.load(e,function(e){e?(pointcloud=new Potree.PointCloudArena4D(e),o(pointcloud)):t({type:"loading_failed"})}):t({type:"loading_failed"}))},this.toLocal=function(e){return function(t){var o=t.clone().applyMatrix4(e.referenceFrame.matrixWorld);return o}}(this),this.toGeo=function(e){return function(t){var o=(new THREE.Matrix4).getInverse(e.referenceFrame.matrixWorld),i=t.clone().applyMatrix4(o);return i}}(this),this.getMinNodeSize=function(){return n.minNodeSize},this.setMinNodeSize=function(e){n.minNodeSize!==e&&(n.minNodeSize=e,n.dispatchEvent({type:"minnodesize_changed",viewer:n}))},this.setDescription=function(e){$("#potree_description")[0].innerHTML=e},this.setNavigationMode=function(e){"Orbit"===e?n.useOrbitControls():"Flight"===e?n.useFPSControls():"Earth"===e&&n.useEarthControls()},this.setShowBoundingBox=function(e){n.showBoundingBox!==e&&(n.showBoundingBox=e,n.dispatchEvent({type:"show_boundingbox_changed",viewer:n}))},this.getShowBoundingBox=function(){return n.showBoundingBox},this.setMoveSpeed=function(e){n.moveSpeed!==e&&(n.moveSpeed=e,n.fpControls.setMoveSpeed(e),n.geoControls.setMoveSpeed(e),n.dispatchEvent({type:"move_speed_changed",viewer:n,speed:e}))},this.getMoveSpeed=function(){return n.fpControls.moveSpeed},this.setShowSkybox=function(e){n.showSkybox!==e&&(n.showSkybox=e,n.dispatchEvent({type:"show_skybox_changed",viewer:n}))},this.getShowSkybox=function(){return n.showSkybox},this.setHeightRange=function(e,t){(n.heightMin!==e||n.heightMax!==t)&&(n.heightMin=e||n.heightMin,n.heightMax=t||n.heightMax,n.dispatchEvent({type:"height_range_changed",viewer:n}))},this.getHeightRange=function(){return{min:n.heightMin,max:n.heightMax}},this.setIntensityMax=function(e){n.intensityMax!==e&&(n.intensityMax=e,n.dispatchEvent({type:"intensity_max_changed",viewer:n}))},this.getIntensityMax=function(){return n.intensityMax},this.setFreeze=function(e){n.freeze!=e&&(n.freeze=e,n.dispatchEvent({type:"freeze_changed",viewer:n}))},this.getFreeze=function(){return n.freeze},this.setPointBudget=function(e){Potree.pointBudget!=e&&(Potree.pointBudget=parseInt(e),n.dispatchEvent({type:"point_budget_changed",viewer:n}))},this.getPointBudget=function(){return Potree.pointBudget},this.setClipMode=function(e){n.clipMode!=e&&(n.clipMode=e,n.dispatchEvent({type:"clip_mode_changed",viewer:n}))},this.getClipMode=function(){return n.clipMode},this.setDEMCollisionsEnabled=function(e){n.useDEMCollisions!==e&&(n.useDEMCollisions=e,n.dispatchEvent({type:"use_demcollisions_changed",viewer:n}))},this.getDEMCollisionsEnabled=function(){return n.useDEMCollisions},this.setEDLEnabled=function(e){n.useEDL!=e&&(n.useEDL=e,n.dispatchEvent({type:"use_edl_changed",viewer:n}))},this.getEDLEnabled=function(){return n.useEDL},this.setEDLRadius=function(e){n.edlRadius!==e&&(n.edlRadius=e,n.dispatchEvent({type:"edl_radius_changed",viewer:n}))},this.getEDLRadius=function(){return n.edlRadius},this.setEDLStrength=function(e){n.edlScale!==e&&(n.edlScale=e,n.dispatchEvent({type:"edl_strength_changed",viewer:n}))},this.getEDLStrength=function(){return n.edlScale},this.setPointSize=function(e){n.pointSize!==e&&(n.pointSize=e,n.dispatchEvent({type:"point_size_changed",viewer:n}))},this.getPointSize=function(){return n.pointSize},this.setMinPointSize=function(e){n.minPointSize!==e&&(n.minPointSize=e,n.dispatchEvent({type:"min_point_size_changed",viewer:n}))},this.getMinPointSize=function(){return n.minPointSize},this.setMaxPointSize=function(e){n.maxPointSize!==e&&(n.maxPointSize=e,n.dispatchEvent({type:"max_point_size_changed",viewer:n}))},this.getMaxPointSize=function(){return n.maxPointSize},this.setFOV=function(e){n.fov!==e&&(n.fov=e,n.dispatchEvent({type:"fov_changed",viewer:n}))},this.getFOV=function(){return n.fov},this.setOpacity=function(e){n.opacity!==e&&(n.opacity=e,n.dispatchEvent({type:"opacity_changed",viewer:n}))},this.getOpacity=function(){return n.opacity},this.setPointSizing=function(e){n.sizeType!==e&&(n.sizeType=e,"Fixed"===e?n.pointSizeType=Potree.PointSizeType.FIXED:"Attenuated"===e?n.pointSizeType=Potree.PointSizeType.ATTENUATED:"Adaptive"===e&&(n.pointSizeType=Potree.PointSizeType.ADAPTIVE),n.dispatchEvent({type:"point_sizing_changed",viewer:n}))},this.getPointSizing=function(){return n.sizeType},this.setQuality=function(e){var t=n.quality;("Interpolation"!=e||Potree.Features.SHADER_INTERPOLATION.isSupported())&&("Splats"!=e||Potree.Features.SHADER_SPLATS.isSupported())?n.quality=e:n.quality="Squares",t!==n.quality&&n.dispatchEvent({type:"quality_changed",viewer:n})},this.getQuality=function(){return n.quality},this.disableAnnotations=function(){for(var e=0;e<n.annotations.length;e++){var t=n.annotations[e];t.domElement.style.pointerEvents="none"}},this.enableAnnotations=function(){for(var e=0;e<n.annotations.length;e++){var t=n.annotations[e];t.domElement.style.pointerEvents="auto"}},this.setClassificationVisibility=function(e,t){for(var o=!1,i=0;i<n.pointclouds.length;i++){var r=n.pointclouds[i],a=r.material.classification,s=a[e].w;a[e].w=t?1:0,s!==a[e].w&&(o=!0),r.material.classification=a}o&&n.dispatchEvent({type:"classification_visibility_changed",viewer:n})},this.setMaterial=function(e){n.pointColorType!==n.toMaterialID(e)&&(n.pointColorType=n.toMaterialID(e),n.dispatchEvent({type:"material_changed",viewer:n}))},this.setMaterialID=function(e){n.pointColorType!==e&&(n.pointColorType=e,n.dispatchEvent({type:"material_changed",viewer:n}))},this.getMaterial=function(){return n.pointColorType},this.getMaterialName=function(){return n.toMaterialName(n.pointColorType)},this.toMaterialID=function(e){return"RGB"===e?Potree.PointColorType.RGB:"Color"===e?Potree.PointColorType.COLOR:"Elevation"===e?Potree.PointColorType.HEIGHT:"Intensity"===e?Potree.PointColorType.INTENSITY:"Intensity Gradient"===e?Potree.PointColorType.INTENSITY_GRADIENT:"Classification"===e?Potree.PointColorType.CLASSIFICATION:"Return Number"===e?Potree.PointColorType.RETURN_NUMBER:"Source"===e?Potree.PointColorType.SOURCE:"Level of Detail"===e?Potree.PointColorType.LOD:"Point Index"===e?Potree.PointColorType.POINT_INDEX:"Normal"===e?Potree.PointColorType.NORMAL:"Phong"===e?Potree.PointColorType.PHONG:void 0},this.toMaterialName=function(e){return e===Potree.PointColorType.RGB?"RGB":e===Potree.PointColorType.COLOR?"Color":e===Potree.PointColorType.HEIGHT?"Elevation":e===Potree.PointColorType.INTENSITY?"Intensity":e===Potree.PointColorType.INTENSITY_GRADIENT?"Intensity Gradient":e===Potree.PointColorType.CLASSIFICATION?"Classification":e===Potree.PointColorType.RETURN_NUMBER?"Return Number":e===Potree.PointColorType.SOURCE?"Source":e===Potree.PointColorType.LOD?"Level of Detail":e===Potree.PointColorType.POINT_INDEX?"Point Index":e===Potree.PointColorType.NORMAL?"Normal":e===Potree.PointColorType.PHONG?"Phong":void 0},this.zoomTo=function(e,t){n.camera.zoomTo(e,t);var o;o=e.boundingSphere?e.boundingSphere:e.geometry&&e.geometry.boundingSphere?e.geometry.boundingSphere:e.boundingBox.getBoundingSphere(),o=o.clone().applyMatrix4(e.matrixWorld),n.orbitControls.target.copy(o.center),n.dispatchEvent({type:"zoom_to",viewer:n})},this.showAbout=function(){$(function(){$("#about-panel").dialog()})},this.getBoundingBox=function(e){e=e||n.pointclouds;var t=new THREE.Box3;n.scenePointCloud.updateMatrixWorld(!0),n.referenceFrame.updateMatrixWorld(!0);for(var o=0;o<n.pointclouds.length;o++){var i=n.pointclouds[o];i.updateMatrixWorld(!0);var r=Potree.utils.computeTransformedBoundingBox(i.boundingBox,i.matrixWorld);t.union(r)}return t},this.getBoundingBoxGeo=function(e){e=e||n.pointclouds;var t=new THREE.Box3;n.scenePointCloud.updateMatrixWorld(!0),n.referenceFrame.updateMatrixWorld(!0);for(var o=0;o<n.pointclouds.length;o++){var i=n.pointclouds[o];i.updateMatrixWorld(!0);var r=Potree.utils.computeTransformedBoundingBox(i.boundingBox,i.matrix);t.union(r)}return t},this.fitToScreen=function(){var e=this.getBoundingBox(n.pointclouds);n.transformationTool.targets.length>0&&(e=n.transformationTool.getBoundingBox());var t=new THREE.Object3D;t.boundingBox=e,n.zoomTo(t,1)},this.setTopView=function(){var e=this.getBoundingBox(n.pointclouds);n.transformationTool.targets.length>0&&(e=n.transformationTool.getBoundingBox());var t=new THREE.Object3D;t.boundingBox=e,n.camera.position.set(0,1,0),n.camera.rotation.set(-Math.PI/2,0,0),n.camera.zoomTo(t,1)},this.setFrontView=function(){var e=this.getBoundingBox(n.pointclouds);n.transformationTool.targets.length>0&&(e=n.transformationTool.getBoundingBox());var t=new THREE.Object3D;t.boundingBox=e,n.camera.position.set(0,0,1),n.camera.rotation.set(0,0,0),n.camera.zoomTo(t,1)},this.setLeftView=function(){var e=this.getBoundingBox(n.pointclouds);n.transformationTool.targets.length>0&&(e=n.transformationTool.getBoundingBox());var t=new THREE.Object3D;t.boundingBox=e,n.camera.position.set(-1,0,0),n.camera.rotation.set(0,-Math.PI/2,0),n.camera.zoomTo(t,1)},this.setRightView=function(){var e=this.getBoundingBox(n.pointclouds);n.transformationTool.targets.length>0&&(e=n.transformationTool.getBoundingBox());var t=new THREE.Object3D;t.boundingBox=e,n.camera.position.set(1,0,0),n.camera.rotation.set(0,Math.PI/2,0),n.camera.zoomTo(t,1)},this.flipYZ=function(){n.isFlipYZ=!n.isFlipYZ,n.referenceFrame.matrix.copy(new THREE.Matrix4),n.isFlipYZ?n.referenceFrame.applyMatrix((new THREE.Matrix4).set(1,0,0,0,0,0,1,0,0,-1,0,0,0,0,0,1)):n.referenceFrame.applyMatrix((new THREE.Matrix4).set(1,0,0,0,0,1,0,0,0,0,1,0,0,0,0,1)),n.referenceFrame.updateMatrixWorld(!0);var e=n.getBoundingBox();n.referenceFrame.position.copy(e.center()).multiplyScalar(-1),n.referenceFrame.position.y=-e.min.y,n.referenceFrame.updateMatrixWorld(!0),n.updateHeightRange()},this.updateHeightRange=function(){var e=n.getBoundingBox();n.setHeightRange(e.min.y,e.max.y)},this.useEarthControls=function(){n.controls&&(n.controls.enabled=!1),n.controls=n.earthControls,n.controls.enabled=!0},this.useGeoControls=function(){n.controls&&(n.controls.enabled=!1),n.controls=n.geoControls,n.controls.enabled=!0},this.useFPSControls=function(){n.controls&&(n.controls.enabled=!1),n.controls=n.fpControls,n.controls.enabled=!0},this.useOrbitControls=function(){n.controls&&(n.controls.enabled=!1),n.controls=n.orbitControls,n.controls.enabled=!0,n.pointclouds.length>0&&n.controls.target.copy(n.pointclouds[0].boundingSphere.center.clone().applyMatrix4(n.pointclouds[0].matrixWorld))},this.addAnnotation=function(e,t){var o=t.cameraPosition,i=t.cameraTarget||e,r=t.description||null,a=t.title||null,s=new Potree.Annotation(n,{position:e,cameraPosition:o,cameraTarget:i,title:a,description:r});return n.annotations.push(s),n.renderArea.appendChild(s.domElement),n.dispatchEvent({type:"annotation_added",viewer:n}),s},this.getAnnotations=function(){return n.annotations},this.loadSettingsFromURL=function(){if(Potree.utils.getParameterByName("pointSize")&&n.setPointSize(parseFloat(Potree.utils.getParameterByName("pointSize"))),Potree.utils.getParameterByName("FOV")&&n.setFOV(parseFloat(Potree.utils.getParameterByName("FOV"))),Potree.utils.getParameterByName("opacity")&&n.setOpacity(parseFloat(Potree.utils.getParameterByName("opacity"))),Potree.utils.getParameterByName("edlEnabled")){var e="true"===Potree.utils.getParameterByName("edlEnabled");n.setEDLEnabled(e)}if(Potree.utils.getParameterByName("edlRadius")&&n.setEDLRadius(parseFloat(Potree.utils.getParameterByName("edlRadius"))),Potree.utils.getParameterByName("edlStrength")&&n.setEDLStrength(parseFloat(Potree.utils.getParameterByName("edlStrength"))),Potree.utils.getParameterByName("clipMode")){var t=Potree.utils.getParameterByName("clipMode");"HIGHLIGHT_INSIDE"===t?n.setClipMode(Potree.ClipMode.HIGHLIGHT_INSIDE):"CLIP_OUTSIDE"===t?n.setClipMode(Potree.ClipMode.CLIP_OUTSIDE):"DISABLED"===t&&n.setClipMode(Potree.ClipMode.DISABLED)}if(Potree.utils.getParameterByName("pointBudget")&&n.setPointBudget(parseFloat(Potree.utils.getParameterByName("pointBudget"))),Potree.utils.getParameterByName("showBoundingBox")){var e="true"===Potree.utils.getParameterByName("showBoundingBox");e?n.setShowBoundingBox(!0):n.setShowBoundingBox(!1)}if(Potree.utils.getParameterByName("material")){var o=Potree.utils.getParameterByName("material");n.setMaterial(o)}if(Potree.utils.getParameterByName("pointSizing")){var i=Potree.utils.getParameterByName("pointSizing");n.setPointSizing(i)}if(Potree.utils.getParameterByName("quality")){var r=Potree.utils.getParameterByName("quality");n.setQuality(r)}},this.toggleSidebar=function(){var e=$("#potree_render_area"),t=($("#potree_sidebar_container"),"0px"!==e.css("left"));t?e.css("left","0px"):e.css("left","300px")},this.toggleMap=function(){var e=$("#potree_map");e.toggle(100)},this.loadGUI=function(){var e=$("#potree_sidebar_container");e.load(Potree.scriptPath+"/sidebar.html"),e.css("width","300px"),e.css("height","100%");var t=document.createElement("img");t.src=Potree.resourcePath+"/icons/menu_button.svg",t.onclick=n.toggleSidebar,t.classList.add("potree_menu_toggle");var o=document.createElement("img");o.src=Potree.resourcePath+"/icons/map_icon.png",o.style.display="none",o.onclick=n.toggleMap,o.id="potree_map_toggle",viewer.renderArea.insertBefore(o,viewer.renderArea.children[0]),viewer.renderArea.insertBefore(t,viewer.renderArea.children[0]);var i=$("<div>").load(Potree.scriptPath+"/profile.html",function(){$("#potree_render_area").append(i.children()),n._2dprofile=new Potree.Viewer.Profile(n,document.getElementById("profile_draw_container"))})},this.createControls=function(){var e=function(e){if(n.useDEMCollisions){for(var t=null,o=0;o<n.pointclouds.length;o++){var i=n.pointclouds[o];i.generateDEM=!0;var r=i.getDEMHeight(e.newPosition);t=t?Math.max(t,r):r}if(e.newPosition.y<t){e.objections++;var a=e.newPosition.clone();a.y=t,e.counterProposals.push(a)}}};n.fpControls=new THREE.FirstPersonControls(n.camera,n.renderer.domElement),n.fpControls.enabled=!1,n.fpControls.addEventListener("start",n.disableAnnotations),n.fpControls.addEventListener("end",n.enableAnnotations),n.fpControls.addEventListener("proposeTransform",e),n.fpControls.addEventListener("move_speed_changed",function(e){n.setMoveSpeed(n.fpControls.moveSpeed)}),n.geoControls=new Potree.GeoControls(n.camera,n.renderer.domElement),n.geoControls.enabled=!1,n.geoControls.addEventListener("start",n.disableAnnotations),n.geoControls.addEventListener("end",n.enableAnnotations),n.geoControls.addEventListener("proposeTransform",e),n.geoControls.addEventListener("move_speed_changed",function(e){n.setMoveSpeed(n.geoControls.moveSpeed)}),n.orbitControls=new Potree.OrbitControls(n.camera,n.renderer.domElement),n.orbitControls.enabled=!1,n.orbitControls.addEventListener("start",n.disableAnnotations),n.orbitControls.addEventListener("end",n.enableAnnotations),n.orbitControls.addEventListener("proposeTransform",e),n.renderArea.addEventListener("dblclick",function(e){if(0!==n.pointclouds.length){e.preventDefault();for(var t=n.renderArea.getBoundingClientRect(),o={x:(e.clientX-t.left)/n.renderArea.clientWidth*2-1,y:2*-((e.clientY-t.top)/n.renderArea.clientHeight)+1},i=null,r=Number.POSITIVE_INFINITY,a=null,s=0;s<n.pointclouds.length;s++)if(intersection=getMousePointCloudIntersection(o,n.camera,n.renderer,[n.pointclouds[s]]),intersection){var l=n.camera.position.distanceTo(intersection);r>l&&(i=n.pointclouds[s],r=l,a=intersection)}if(null!=a){var d=0;if(n.jumpDistance)d=n.jumpDistance;else{var c=n.camera.position.distanceTo(n.orbitControls.target),u=new THREE.Vector3(o.x,o.y,.5);u.unproject(n.camera);var p=u.sub(n.camera.position).normalize(),h=new THREE.Ray(n.camera.position,p),m=i.nodesOnRay(i.visibleNodes,h),f=m[m.length-1],g=f.getBoundingSphere().radius,d=Math.min(c,g),d=Math.max(n.minimumJumpDistance,d)}var v=n.camera.getWorldDirection().multiplyScalar(-1),y=(new THREE.Vector3).addVectors(a,v.multiplyScalar(d)),E=600,T=TWEEN.Easing.Quartic.Out;n.controls.enabled=!1;var b=new TWEEN.Tween(n.camera.position).to(y,E);b.easing(T),b.start();var b=new TWEEN.Tween(n.orbitControls.target).to(a,E);b.easing(T),b.onComplete(function(){n.controls.enabled=!0,n.fpControls.moveSpeed=g/2,n.geoControls.moveSpeed=g/2}),b.start()}}}),n.earthControls=new THREE.EarthControls(n.camera,n.renderer,n.scenePointCloud),n.earthControls.enabled=!1,n.earthControls.addEventListener("start",n.disableAnnotations),n.earthControls.addEventListener("end",n.enableAnnotations),n.earthControls.addEventListener("proposeTransform",e)},this.initThree=function(){var e=n.renderArea.clientWidth,t=n.renderArea.clientHeight,i=e/t,r=.1,a=1e6;n.scene=new THREE.Scene,n.scenePointCloud=new THREE.Scene,n.sceneBG=new THREE.Scene,n.camera=new THREE.PerspectiveCamera(n.fov,i,r,a),n.cameraBG=new THREE.Camera,n.camera.rotation.order="ZYX",n.referenceFrame=new THREE.Object3D,n.scenePointCloud.add(n.referenceFrame),n.renderer=new THREE.WebGLRenderer,n.renderer.setSize(e,t),n.renderer.autoClear=!1,n.renderArea.appendChild(n.renderer.domElement),n.renderer.domElement.tabIndex="2222",n.renderer.domElement.addEventListener("mousedown",function(){n.renderer.domElement.focus()}),s=Potree.utils.loadSkybox(Potree.resourcePath+"/textures/skybox/"),n.camera.position.set(-304,372,318),n.camera.rotation.y=-Math.PI/4,n.camera.rotation.x=-Math.PI/6,this.createControls(),n.renderer.context.getExtension("EXT_frag_depth");var l=Potree.utils.createGrid(5,5,2);n.scene.add(l),n.measuringTool=new Potree.MeasuringTool(n.scenePointCloud,n.camera,n.renderer,n.toGeo),n.profileTool=new Potree.ProfileTool(n.scenePointCloud,n.camera,n.renderer),n.transformationTool=new Potree.TransformationTool(n.scenePointCloud,n.camera,n.renderer),n.volumeTool=new Potree.VolumeTool(n.scenePointCloud,n.camera,n.renderer,n.transformationTool),n.profileTool.addEventListener("profile_added",function(e){var t=document.createElement("button");t.type="button",t.classList.add("btn"),t.classList.add("btn-primary"),t.id="btn_rofile_"+n.profileTool.profiles.length,t.value="profile "+n.profileTool.profiles.length,t.innerHTML="profile "+n.profileTool.profiles.length,t.onclick=function(t){n.profileTool.draw(e.profile,$("#profile_draw_container")[0],n.toGeo),e.profile.addEventListener("marker_moved",function(){n.profileTool.draw(e.profile,$("#profile_draw_container")[0],n.toGeo)}),e.profile.addEventListener("width_changed",function(){n.profileTool.draw(e.profile,$("#profile_draw_container")[0],n.toGeo)})}});var d=Potree.utils.createBackgroundTexture(512,512);d.minFilter=d.magFilter=THREE.NearestFilter,d.minFilter=d.magFilter=THREE.LinearFilter;var c=new THREE.Mesh(new THREE.PlaneBufferGeometry(2,2,0),new THREE.MeshBasicMaterial({map:d}));c.material.depthTest=!1,c.material.depthWrite=!1,n.sceneBG.add(c),window.addEventListener("keydown",o,!1),n.directionalLight=new THREE.DirectionalLight(16777215,.5),n.directionalLight.position.set(10,10,10),n.directionalLight.lookAt(new THREE.Vector3(0,0,0)),n.scenePointCloud.add(n.directionalLight);var u=new THREE.AmbientLight(5592405);n.scenePointCloud.add(u)},this.update=function(e,t){Potree.pointLoadLimit=2*Potree.pointBudget,n.directionalLight.position.copy(n.camera.position),n.directionalLight.lookAt((new THREE.Vector3).addVectors(n.camera.position,n.camera.getWorldDirection()));for(var o=0,i=0,r=0,a=0;a<n.pointclouds.length;a++){var s=n.pointclouds[a];Potree.utils.computeTransformedBoundingBox(s.boundingBox,s.matrixWorld);if(!n.intensityMax){var l=s.pcoGeometry.root;if(null!=l&&l.loaded){var d=s.pcoGeometry.root.geometry.attributes;if(d.intensity){for(var c=d.intensity.array,u=[],p=0;p<c.length;p++)u.push(c[p]);u.sort();var h=parseInt(.75*(u.length-1)),m=u[h];1>=m?n.intensityMax=1:256>=m?n.intensityMax=255:n.intensityMax=m}}}s.material.clipMode=n.clipMode,s.material.heightMin=n.heightMin,s.material.heightMax=n.heightMax,s.material.intensityMin=0,s.material.intensityMax=n.intensityMax,s.showBoundingBox=n.showBoundingBox,s.generateDEM=n.useDEMCollisions,s.minimumNodePixelSize=n.minNodeSize,o+=s.numVisibleNodes,i+=s.numVisiblePoints,r+=s.progress}if(!n.freeze){var f=Potree.updatePointClouds(n.pointclouds,n.camera,n.renderer);o=f.visibleNodes.length,i=f.numVisiblePoints}if(n.camera.fov=n.fov,n.controls&&n.controls.update(e),n.pointclouds.length>0){n.progressBar.progress=r/n.pointclouds.length;var g;g=0===r?"loading":"loading: "+parseInt(100*r/n.pointclouds.length)+"%",n.progressBar.message=g,r>=.999?n.progressBar.hide():1>r&&n.progressBar.show()}n.volumeTool.update(),n.transformationTool.update(),n.profileTool.update();for(var v=[],a=0;a<n.profileTool.profiles.length;a++)for(var y=n.profileTool.profiles[a],p=0;p<y.boxes.length;p++){var E=y.boxes[p];E.updateMatrixWorld();var T=(new THREE.Matrix4).getInverse(E.matrixWorld),b=E.getWorldPosition();v.push({inverse:T,position:b})}for(var a=0;a<n.volumeTool.volumes.length;a++){var P=n.volumeTool.volumes[a];if(P.clip){P.updateMatrixWorld();var T=(new THREE.Matrix4).getInverse(P.matrixWorld),b=P.getWorldPosition();v.push({inverse:T,position:b})}}for(var a=0;a<n.pointclouds.length;a++)n.pointclouds[a].material.setClipBoxes(v);for(var R=[],a=0;a<n.annotations.length;a++){var x=n.annotations[a],w=x.position.clone().project(n.camera);w.x=n.renderArea.clientWidth*(w.x+1)/2,w.y=n.renderArea.clientHeight*(1-(w.y+1)/2),x.domElement.style.left=Math.floor(w.x-x.domElement.clientWidth/2)+"px",x.domElement.style.top=Math.floor(w.y)+"px",R.push({annotation:x,distance:w.z}),-1>w.z||w.z>1?x.domElement.style.display="none":x.domElement.style.display="initial"}R.sort(function(e,t){return t.distance-e.distance});for(var a=0;a<R.length;a++){var x=R[a].annotation;x.domElement.style.zIndex=""+a,x.descriptionVisible&&(x.domElement.style.zIndex+=100)}n.showDebugInfos&&n.infos.set("camera.position","camera.position: "+n.camera.position.x.toFixed(2)+", "+n.camera.position.y.toFixed(2)+", "+n.camera.position.z.toFixed(2)),n.mapView&&n.mapView.update(e,n.camera),TWEEN.update(t),n.dispatchEvent({type:"update",delta:e,timestamp:t})};var d=function(){this.render=function(){var e=n.renderArea.clientWidth,t=n.renderArea.clientHeight,o=e/t;n.camera.aspect=o,n.camera.updateProjectionMatrix(),n.renderer.setSize(e,t),n.showSkybox?(s.camera.rotation.copy(n.camera.rotation),n.renderer.render(s.scene,s.camera)):n.renderer.render(n.sceneBG,n.cameraBG);for(var i=0;i<n.pointclouds.length;i++){var r=n.pointclouds[i];r.originalMaterial&&(r.material=r.originalMaterial);Potree.utils.computeTransformedBoundingBox(r.boundingBox,r.matrixWorld);r.material.size=n.pointSize,r.material.minSize=n.minPointSize,r.material.maxSize=n.maxPointSize,r.material.opacity=n.opacity,r.material.pointColorType=n.pointColorType,r.material.pointSizeType=n.pointSizeType,r.material.pointShape="Circles"===n.quality?Potree.PointShape.CIRCLE:Potree.PointShape.SQUARE,r.material.interpolate="Interpolation"===n.quality,r.material.weighted=!1}n.renderer.render(n.scene,n.camera),n.renderer.render(n.scenePointCloud,n.camera),n.profileTool.render(),n.volumeTool.render(),n.renderer.clearDepth(),n.measuringTool.render(),n.transformationTool.render()}},c=new d,u=null,p=function(){var e,t,o=null,i=null,r=null,a=function(){if(null==o){o=new Potree.PointCloudMaterial,i=new Potree.PointCloudMaterial,o.pointColorType=Potree.PointColorType.DEPTH,o.pointShape=Potree.PointShape.CIRCLE,o.interpolate=!1,o.weighted=!1,o.minSize=n.minPointSize,o.maxSize=n.maxPointSize,i.pointShape=Potree.PointShape.CIRCLE,i.interpolate=!1,i.weighted=!0,i.minSize=n.minPointSize,i.maxSize=n.maxPointSize,e=new THREE.WebGLRenderTarget(1024,1024,{minFilter:THREE.NearestFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat,type:THREE.FloatType}),t=new THREE.WebGLRenderTarget(1024,1024,{minFilter:THREE.LinearFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat,type:THREE.FloatType});var a={depthMap:{type:"t",value:e},texture:{type:"t",value:t}};r=new THREE.ShaderMaterial({uniforms:a,vertexShader:Potree.Shaders["normalize.vs"],fragmentShader:Potree.Shaders["normalize.fs"]})}},l=function(o,i){(e.width!=o||e.height!=i)&&(e.dispose(),t.dispose(),n.camera.aspect=o/i,n.camera.updateProjectionMatrix(),n.renderer.setSize(o,i),e.setSize(o,i),t.setSize(o,i))};this.render=function(d){var c=n.renderArea.clientWidth,u=n.renderArea.clientHeight;a(),l(c,u),n.renderer.clear(),n.showSkybox?(s.camera.rotation.copy(n.camera.rotation),n.renderer.render(s.scene,s.camera)):n.renderer.render(n.sceneBG,n.cameraBG),n.renderer.render(n.scene,n.camera);for(var p=0;p<n.pointclouds.length;p++){var h=n.pointclouds[p];o.uniforms.octreeSize.value=h.pcoGeometry.boundingBox.size().x,i.uniforms.octreeSize.value=h.pcoGeometry.boundingBox.size().x;var m=h.material;o.size=n.pointSize,o.pointSizeType=n.pointSizeType,o.screenWidth=c,o.screenHeight=u,o.uniforms.visibleNodes.value=h.material.visibleNodesTexture,o.uniforms.octreeSize.value=h.pcoGeometry.boundingBox.size().x,o.fov=n.camera.fov*(Math.PI/180),o.spacing=h.pcoGeometry.spacing,o.near=n.camera.near,o.far=n.camera.far,o.heightMin=n.heightMin,o.heightMax=n.heightMax,o.uniforms.visibleNodes.value=h.material.visibleNodesTexture,o.uniforms.octreeSize.value=h.pcoGeometry.boundingBox.size().x,o.bbSize=h.material.bbSize,o.treeType=h.material.treeType,o.uniforms.classificationLUT.value=h.material.uniforms.classificationLUT.value,n.scenePointCloud.overrideMaterial=o,n.renderer.clearTarget(e,!0,!0,!0),n.renderer.render(n.scenePointCloud,n.camera,e),n.scenePointCloud.overrideMaterial=null,i.size=n.pointSize,i.pointSizeType=n.pointSizeType,i.screenWidth=c,i.screenHeight=u,i.pointColorType=n.pointColorType,i.depthMap=e,i.uniforms.visibleNodes.value=h.material.visibleNodesTexture,i.uniforms.octreeSize.value=h.pcoGeometry.boundingBox.size().x,i.fov=n.camera.fov*(Math.PI/180),i.uniforms.blendHardness.value=h.material.uniforms.blendHardness.value,i.uniforms.blendDepthSupplement.value=h.material.uniforms.blendDepthSupplement.value,i.spacing=h.pcoGeometry.spacing,i.near=n.camera.near,i.far=n.camera.far,i.heightMin=n.heightMin,i.heightMax=n.heightMax,i.intensityMin=h.material.intensityMin,i.intensityMax=h.material.intensityMax,i.setClipBoxes(h.material.clipBoxes),i.clipMode=h.material.clipMode,i.bbSize=h.material.bbSize,i.treeType=h.material.treeType,i.uniforms.classificationLUT.value=h.material.uniforms.classificationLUT.value,n.scenePointCloud.overrideMaterial=i,n.renderer.clearTarget(t,!0,!0,!0),n.renderer.render(n.scenePointCloud,n.camera,t),n.scenePointCloud.overrideMaterial=null,h.material=m}n.pointclouds.length>0&&(r.uniforms.depthMap.value=e,r.uniforms.texture.value=t,Potree.utils.screenPass.render(n.renderer,r),n.volumeTool.render(),n.renderer.clearDepth(),n.profileTool.render(),n.measuringTool.render(),n.transformationTool.render())}},h=null,m=function(){var e=null,t=[],o=null,i=(n.renderer.context,function(){null==e&&(e=new Potree.EyeDomeLightingMaterial,o=new THREE.WebGLRenderTarget(1024,1024,{minFilter:THREE.LinearFilter,magFilter:THREE.NearestFilter,format:THREE.RGBAFormat,type:THREE.FloatType}))}),r=function(){var e=n.renderArea.clientWidth,t=n.renderArea.clientHeight,i=e/t,r=o.width!=e||o.height!=t;r&&o.dispose(),n.camera.aspect=i,n.camera.updateProjectionMatrix(),n.renderer.setSize(e,t),o.setSize(e,t)};this.render=function(){i(),r(),n.renderer.clear(),n.showSkybox?(s.camera.rotation.copy(n.camera.rotation),n.renderer.render(s.scene,s.camera)):n.renderer.render(n.sceneBG,n.cameraBG),n.renderer.render(n.scene,n.camera);for(var a=[],l=0;l<n.pointclouds.length;l++){var d=n.pointclouds[l],c=n.renderArea.clientWidth,u=n.renderArea.clientHeight;if(t.length<=l){var p=new Potree.PointCloudMaterial;p.pointShape=Potree.PointShape.CIRCLE,p.interpolate=!1,p.weighted=!1,p.minSize=n.minPointSize,p.maxSize=n.maxPointSize,p.useLogarithmicDepthBuffer=!1,p.useEDL=!0,t.push(p)}var p=t[l],h=d.pcoGeometry.boundingBox.size().x;a.push(d.material),n.renderer.clearTarget(o,!0,!0,!0),p=d.material,p.pointShape=Potree.PointShape.CIRCLE,p.interpolate=!1,p.weighted=!1,p.minSize=n.minPointSize,p.maxSize=n.maxPointSize,p.useLogarithmicDepthBuffer=!1,p.useEDL=!0,p.size=n.pointSize,p.pointSizeType=n.pointSizeType,p.screenWidth=c,p.screenHeight=u,p.pointColorType=n.pointColorType,p.uniforms.visibleNodes.value=d.material.visibleNodesTexture,p.uniforms.octreeSize.value=h,p.fov=n.camera.fov*(Math.PI/180),p.spacing=d.pcoGeometry.spacing,p.near=n.camera.near,p.far=n.camera.far,p.heightMin=n.heightMin,p.heightMax=n.heightMax,p.intensityMin=d.material.intensityMin,p.intensityMax=d.material.intensityMax,p.setClipBoxes(d.material.clipBoxes),p.clipMode=d.material.clipMode,p.bbSize=d.material.bbSize,p.treeType=d.material.treeType,p.uniforms.classificationLUT.value=d.material.uniforms.classificationLUT.value,d.material=p;for(var m=0;m<d.visibleNodes.length;m++){var f=d.visibleNodes[m];d instanceof Potree.PointCloudOctree?f.sceneNode.material=p:d instanceof Potree.PointCloudArena4D&&(f.material=p)}}n.renderer.render(n.scenePointCloud,n.camera,o),
n.volumeTool.render(o);for(var l=0;l<n.pointclouds.length;l++){var d=n.pointclouds[l],g=a[l];d.material=g;for(var m=0;m<d.visibleNodes.length;m++){var f=d.visibleNodes[m];d instanceof Potree.PointCloudOctree?f.sceneNode.material=g:d instanceof Potree.PointCloudArena4D&&(f.material=g)}}n.pointclouds.length>0&&(e.uniforms.screenWidth.value=c,e.uniforms.screenHeight.value=u,e.uniforms.near.value=n.camera.near,e.uniforms.far.value=n.camera.far,e.uniforms.colorMap.value=o,e.uniforms.expScale.value=n.camera.far,e.uniforms.edlScale.value=n.edlScale,e.uniforms.radius.value=n.edlRadius,e.uniforms.opacity.value=n.opacity,e.depthTest=!0,e.depthWrite=!0,e.transparent=!0,Potree.utils.screenPass.render(n.renderer,e),n.renderer.render(n.scene,n.camera),n.profileTool.render(),n.volumeTool.render(),n.renderer.clearDepth(),n.measuringTool.render(),n.transformationTool.render())}};n.initThree(),n.setPointSize(1),n.setFOV(60),n.setOpacity(1),n.setEDLEnabled(!1),n.setEDLRadius(2),n.setEDLStrength(1),n.setClipMode(Potree.ClipMode.HIGHLIGHT_INSIDE),n.setPointBudget(1e6),n.setShowBoundingBox(!1),n.setFreeze(!1),n.setNavigationMode("Orbit"),n.loadSettingsFromURL(),requestAnimationFrame(i)},Potree.Viewer.prototype=Object.create(THREE.EventDispatcher.prototype),Potree.Viewer.Profile=function(e,t){function o(){requestAnimationFrame(o);var e=document.getElementById("profile_window").clientWidth,t=document.getElementById("profile_window").clientHeight;(e!==r||t!==a)&&setTimeout(n,50,{profile:i.currentProfile}),r=e,a=t}var i=this;this.viewer=e,this.enabled=!0,this.element=t,this.currentProfile=null,this.requests=[],this.pointsProcessed=0,this.margin={top:0,right:0,bottom:20,left:40},this.maximized=!1,this.threshold=2e4,$("#closeProfileContainer").click(function(){i.hide(),i.enabled=!1}),$("#profile_toggle_size_button").click(function(){i.maximized=!i.maximized,i.maximized?$("#profile_window").css("height","100%"):$("#profile_window").css("height","30%")}),this.show=function(){$("#profile_window").fadeIn(),i.enabled=!0},this.hide=function(){$("#profile_window").fadeOut()},this.cancel=function(){for(var e=0;e<i.requests.length;e++)i.requests[e].cancel();i.requests=[]},this.getLAS=function(){for(var e=i.points,t=new THREE.Box3,o=0;o<e.length;o++){var n=e[o],r=new THREE.Vector3(n.x,n.y,n.z);t.expandByPoint(r)}var a=t.min.clone(),s=t.min.distanceTo(t.max),l=new THREE.Vector3(.01,.01,.01);l=s>1e5?new THREE.Vector3(.01,.01,.01):new THREE.Vector3(.001,.001,.001);var d=function(e,t,o){for(var i=new Uint8Array(o),n=0;n<e.length;n++){var r=e.charCodeAt(n);i[t+n]=r}},c=new ArrayBuffer(227+28*e.length),u=new DataView(c),p=new Uint8Array(c);d("LASF",0,c),p[24]=1,p[25]=2,d("potree 1.4",58,c),u.setUint16(94,227,!0),u.setUint32(96,227,!0),p[104]=2,u.setUint16(105,28,!0),u.setUint32(107,e.length,!0),u.setFloat64(131,l.x,!0),u.setFloat64(139,l.y,!0),u.setFloat64(147,l.z,!0),u.setFloat64(155,a.x,!0),u.setFloat64(163,a.y,!0),u.setFloat64(171,a.z,!0);for(var h=227,o=0;o<e.length;o++){var n=e[o],r=new THREE.Vector3(n.x,n.y,n.z),m=parseInt((r.x-a.x)/l.x),f=parseInt((r.y-a.y)/l.y),g=parseInt((r.z-a.z)/l.z);u.setUint32(h+0,m,!0),u.setUint32(h+4,f,!0),u.setUint32(h+8,g,!0),u.setUint16(h+12,n.intensity,!0);var v=n.returnNumber;v+=n.numberOfReturns<<3,u.setUint8(h+14,v),u.setUint8(h+15,n.classification),u.setUint16(h+18,n.pointSourceID),u.setUint16(h+20,255*n.color[0],!0),u.setUint16(h+22,255*n.color[1],!0),u.setUint16(h+24,255*n.color[2],!0),h+=28}return u.setFloat64(179,t.max.x,!0),u.setFloat64(187,t.min.x,!0),u.setFloat64(195,t.max.y,!0),u.setFloat64(203,t.min.y,!0),u.setFloat64(211,t.max.z,!0),u.setFloat64(219,t.min.z,!0),c},this.preparePoints=function(t){var o=t.segments;if(0===o.length)return!1;for(var n=[],r=0,a=Math.max(),s=Math.max(),l=Math.max(),d=0,c=0,u=0,p=i.viewer.getHeightRange(),h={min:i.viewer.toGeo(new THREE.Vector3(0,p.min,0)).z,max:i.viewer.toGeo(new THREE.Vector3(0,p.max,0)).z},m=h.max-h.min,f=[],g=[],v=e.pointclouds[0].material.gradient,y=0;y<v.length;y++)g.push(h.min+m*v[y][0]),f.push("#"+v[y][1].getHexString());for(var E=d3.scale.linear().domain(g).range(f).clamp(!0),T=0;T<o.length;T++){for(var b=o[T],P=i.viewer.toGeo(b.start),R=i.viewer.toGeo(b.end),x=R.x-P.x,w=R.y-P.y,C=Math.sqrt(x*x+w*w),S=b.points,H=0;H<S.numPoints;H++){var B=i.viewer.toGeo(S.position[H]);B.x<a&&(a=B.x),B.y<s&&(s=B.y),B.z<l&&(l=B.z),B.x>d&&(d=B.x),B.y<c&&(c=B.y),B.z<u&&(u=B.z);var M=B.x-P.x,A=B.y-P.y,I=Math.sqrt(M*M+A*A),V=(x*M+w*A)/(Math.sqrt(x*x+w*w)*I),L=(Math.acos(V),I*V+r);if(!isNaN(L)){var N={};N.distance=L,N.x=B.x,N.y=B.y,N.z=B.z,N.altitude=B.z,N.heightColor=E(B.z),N.color=S.color?S.color[H]:[0,0,0],N.intensity=S.intensity?S.intensity[H]:0,N.classification=S.classification?S.classification[H]:0,N.returnNumber=S.returnNumber?S.returnNumber[H]:0,N.numberOfReturns=S.numberOfReturns?S.numberOfReturns[H]:0,N.pointSourceID=S.pointSourceID?S.pointSourceID[H]:0,n.push(N)}}r+=C}var D={data:n,minX:a,minY:s,minZ:l,maxX:d,maxY:c,maxZ:u};return D},this.pointHighlight=function(e){var t=6,o=i.points,n=i.scaleX,r=i.scaleY,a=[0,0];a=d3.mouse(this);for(var s=a[0],l=a[1],d=[],c=t,u=0;u<o.length;u++)n(o[u].distance)<s+c&&n(o[u].distance)>s-c&&r(o[u].altitude)<l+c&&r(o[u].altitude)>l-c&&d.push(o[u]);if(d.length>0){var p=d[0];this.hoveredPoint=d[0],-1==navigator.userAgent.indexOf("Firefox")?(cx=i.scaleX(p.distance)+i.margin.left,cy=i.scaleY(p.altitude)+i.margin.top):(cx=i.scaleX(p.distance),cy=i.scaleY(p.altitude)),cy-=t/2;var h=d3.select("svg");d3.selectAll("rect").remove();var m=(h.append("rect").attr("x",cx).attr("y",cy).attr("id",p.id).attr("width",t).attr("height",t).style("fill","yellow"),$("#profile_selection_marker"));m.css("display","initial"),m.css("left",cx+"px"),m.css("top",cy+"px"),m.css("width",t+"px"),m.css("height",t+"px"),m.css("background-color","yellow");var f="x: "+Math.round(10*p.x)/10+" y: "+Math.round(10*p.y)/10+" z: "+Math.round(10*p.altitude)/10+"  -  ";f+="offset: "+p.distance.toFixed(3)+"  -  ",f+="Classification: "+p.classification+"  -  ",f+="Intensity: "+p.intensity,$("#profileInfo").css("color","yellow"),$("#profileInfo").html(f)}else{d3.selectAll("rect").remove(),$("#profileInfo").html("");var m=$("#profile_selection_marker");m.css("display","none")}},this.strokeColor=function(e){var t=i.viewer.getMaterial();if(t===Potree.PointColorType.RGB)return"rgb("+100*e.color[0]+"%,"+100*e.color[1]+"%,"+100*e.color[2]+"%)";if(t===Potree.PointColorType.INTENSITY)return"rgb("+e.intensity+"%,"+e.intensity+"%,"+e.intensity+"%)";if(t===Potree.PointColorType.CLASSIFICATION){var o=i.viewer.pointclouds[0].material.classification;if("undefined"!=typeof o[e.classification]){var n="rgb("+100*o[e.classification].x+"%,";return n+=100*o[e.classification].y+"%,",n+=100*o[e.classification].z+"%)"}return"rgb(255,255,255)"}return t===Potree.PointColorType.HEIGHT?e.heightColor:t===Potree.PointColorType.RETURN_NUMBER?1===e.numberOfReturns?"rgb(255, 255, 0)":1===e.returnNumber?"rgb(255, 0, 0)":e.returnNumber===e.numberOfReturns?"rgb(0, 0, 255)":"rgb(0, 255, 0)":e.color},this.redraw=function(){i.draw(i.currentProfile)},this.draw=function(e){if(i.enabled&&e&&!(e.points.length<2)&&0!==i.viewer.pointclouds.length){i.currentProfile=e,i.__drawData||(i.__drawData={}),i.points=[],i.rangeX=[1/0,-(1/0)],i.rangeY=[1/0,-(1/0)],i.pointsProcessed=0;for(var t=0;t<i.requests.length;t++)i.requests[t].cancel();i.requests=[];for(var o=function(t,o,n){for(var r=0,a=0;a<e.points.length;a++){var s=e.points[a],l=i.viewer.toGeo(s);if(a>0){var d=i.viewer.toGeo(e.points[a-1]),c=l.x-d.x,u=l.y-d.y,p=Math.sqrt(c*c+u*u);r+=p}var h=4,m=i.scaleX(r),f=i.context.canvas.clientHeight;i.context.beginPath(),i.context.arc(m,f,h,0,2*Math.PI,!1),i.context.fillStyle="#a22",i.context.fill()}for(var g,m,f,v=2,a=-1,y=t.length;++a<y;)g=t[a],m=i.scaleX(g.distance),f=i.scaleY(g.altitude),i.context.beginPath(),i.context.moveTo(m,f),i.context.fillStyle=i.strokeColor(g),i.context.fillRect(m,f,v,v)},n=null,r=function(){var e=i.element.clientWidth,t=i.element.clientHeight,n=e-(i.margin.left+i.margin.right),r=t-(i.margin.top+i.margin.bottom);i.scaleX=d3.scale.linear(),i.scaleY=d3.scale.linear();var a=i.rangeX[1]-i.rangeX[0],s=i.rangeY[1]-i.rangeY[0],l=a/s,d=n,c=r,u=d/c;if(u>l){var p=a*(c/s);i.scaleY.range([r,0]),i.scaleX.range([n/2-p/2,n/2+p/2]);var h=u/l,m=a*h;i.axisScaleX=d3.scale.linear().domain([a/2-m/2,a/2+m/2]).range([0,n]),i.axisScaleY=d3.scale.linear().domain(i.rangeY).range([r,0])}else{var f=s*(d/a);i.scaleX.range([0,n]),i.scaleY.range([r/2+f/2,r/2-f/2]);var h=l/u,g=s*h,v=(i.rangeY[1]+i.rangeY[0])/2;i.axisScaleX=d3.scale.linear().domain(i.rangeX).range([0,n]),i.axisScaleY=d3.scale.linear().domain([v-g/2,v+g/2]).range([r,0])}i.scaleX.domain(i.rangeX),i.scaleY.domain(i.rangeY),i.axisZoom=d3.behavior.zoom().x(i.axisScaleX).y(i.axisScaleY).scaleExtent([0,128]).size([n,r]),i.zoom=d3.behavior.zoom().x(i.scaleX).y(i.scaleY).scaleExtent([0,128]).size([n,r]).on("zoom",function(){i.axisZoom.translate(i.zoom.translate()),i.axisZoom.scale(i.zoom.scale()),svg.select(".x.axis").call(y),svg.select(".y.axis").call(E),i.context.clearRect(0,0,n,r),o(i.points,i.rangeX,i.rangeY)}),i.context=d3.select("#profileCanvas").attr("width",n).attr("height",r).call(i.zoom).node().getContext("2d"),d3.select("svg#profileSVG").selectAll("*").remove(),svg=d3.select("svg#profileSVG").call(i.zoom).attr("width",(n+i.margin.left+i.margin.right).toString()).attr("height",(r+i.margin.top+i.margin.bottom).toString()).attr("transform","translate("+i.margin.left+","+i.margin.top+")").on("mousemove",function(){}),d3.select("#profileCanvas").on("mousemove",i.pointHighlight);var y=d3.svg.axis().scale(i.axisScaleX).innerTickSize(-r).outerTickSize(5).orient("bottom").ticks(10,"m"),E=d3.svg.axis().scale(i.axisScaleY).innerTickSize(-n).outerTickSize(5).orient("left").ticks(10,"m");svg.append("g").attr("class","x axis").call(y);svg.append("g").attr("class","y axis").call(E),-1==navigator.userAgent.indexOf("Firefox")?(svg.select(".y.axis").attr("transform","translate("+i.margin.left.toString()+","+i.margin.top.toString()+")"),svg.select(".x.axis").attr("transform","translate("+i.margin.left.toString()+","+(r+i.margin.top).toString()+")")):svg.select(".x.axis").attr("transform","translate( 0 ,"+r.toString()+")"),o(i.points,i.rangeX,i.rangeY),document.getElementById("profile_num_points").innerHTML=Potree.utils.addCommas(i.pointsProcessed)+" "},t=0;t<i.viewer.pointclouds.length;t++){var a=i.viewer.pointclouds[t];if(a.visible){var s=a.getPointsInProfile(e,null,{onProgress:function(e){if(i.enabled){n?n.union(e.points.projectedBoundingBox):n=e.points.projectedBoundingBox;var t=i.preparePoints(e.points),o=t.data;i.points=i.points.concat(o);var a=[d3.min(o,function(e){return e.distance}),d3.max(o,function(e){return e.distance})],s=[d3.min(o,function(e){return e.altitude}),d3.max(o,function(e){return e.altitude})];i.rangeX=[Math.min(i.rangeX[0],a[0]),Math.max(i.rangeX[1],a[1])],i.rangeY=[Math.min(i.rangeY[0],s[0]),Math.max(i.rangeY[1],s[1])],i.pointsProcessed+=t.data.length,r(),i.pointsProcessed>i.threshold&&i.cancel()}},onFinish:function(e){!i.enabled},onCancel:function(){!i.enabled}});i.requests.push(s)}}}},this.setThreshold=function(e){i.threshold=e,i.redraw()};var n=function(e){e.profile===i.currentProfile&&i.redraw()};e.profileTool.addEventListener("marker_moved",n),e.profileTool.addEventListener("width_changed",n),e.addEventListener("material_changed",function(){n({profile:i.currentProfile})}),e.addEventListener("height_range_changed",function(){n({profile:i.currentProfile})});var r=document.getElementById("profile_window").clientWidth,a=document.getElementById("profile_window").clientHeight;requestAnimationFrame(o)},proj4.defs("UTM10N","+proj=utm +zone=10 +ellps=GRS80 +datum=NAD83 +units=m +no_defs"),Potree.Viewer.MapView=function(e){var t=this;this.viewer=e,this.webMapService="WMTS",this.mapProjectionName="EPSG:3857",this.mapProjection=proj4.defs(t.mapProjectionName),this.sceneProjection=null,this.init=function(){$("#potree_map").draggable({handle:$("#potree_map_header")}),$("#potree_map").resizable(),$("#potree_map_toggle").css("display","block"),t.gExtent=new ol.geom.LineString([[0,0],[0,0]]);var e=new ol.Feature(t.gExtent),o=new ol.source.Vector({features:[e]}),i=new ol.layer.Vector({source:o,style:new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255, 255, 255, 0.2)"}),stroke:new ol.style.Stroke({color:"#0000ff",width:2}),image:new ol.style.Circle({radius:3,fill:new ol.style.Fill({color:"#0000ff"})})})});t.gCamera=new ol.geom.LineString([[0,0],[0,0],[0,0],[0,0]]);var e=new ol.Feature(t.gCamera),o=new ol.source.Vector({features:[e]}),n=new ol.layer.Vector({source:o,style:new ol.style.Style({stroke:new ol.style.Stroke({color:"#0000ff",width:2})})});t.toolLayer=new ol.layer.Vector({source:new ol.source.Vector({}),style:new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255, 0, 0, 1)"}),stroke:new ol.style.Stroke({color:"rgba(255, 0, 0, 1)",width:2})})}),t.sourcesLayer=new ol.layer.Vector({source:new ol.source.Vector({}),style:new ol.style.Style({fill:new ol.style.Fill({color:"rgba(0, 0, 150, 0.1)"}),stroke:new ol.style.Stroke({color:"rgba(0, 0, 150, 1)",width:1})})}),t.sourcesLabelLayer=new ol.layer.Vector({source:new ol.source.Vector({}),style:new ol.style.Style({fill:new ol.style.Fill({color:"rgba(255, 0, 0, 0.1)"}),stroke:new ol.style.Stroke({color:"rgba(255, 0, 0, 1)",width:2})}),minResolution:.01,maxResolution:20});var r=new ol.control.MousePosition({coordinateFormat:ol.coordinate.createStringXY(4),projection:t.sceneProjection,undefinedHTML:"&nbsp;"}),a=function(e){var o=e||{},i=document.createElement("button");i.innerHTML="T",i.addEventListener("click",function(){var e=t.sourcesLayer.getVisible();t.sourcesLayer.setVisible(!e),t.sourcesLabelLayer.setVisible(!e)},!1),i.style["float"]="left",i.title="show / hide tiles";var n=document.createElement("a");n.href="#",n.download="list.txt",n.style["float"]="left";var r=document.createElement("button");r.innerHTML="D",n.appendChild(r);var a=function(e){var t=l.getArray(),o=[location.protocol,"//",location.host,location.pathname].join("");if(0===t.length)return alert("No tiles were selected. Select area with ctrl + left mouse button!"),e.preventDefault(),e.stopImmediatePropagation(),!1;if(1===t.length){var i=t[0];if(i.source){var r=i.pointcloud.pcoGeometry.url,a=new URL(o+"/../"+r+"/../source/"+i.source.name);n.href=a.href,n.download=i.source.name}}else{for(var s="",d=0;d<t.length;d++){var i=t[d];if(i.source){var r=i.pointcloud.pcoGeometry.url,a=new URL(o+"/../"+r+"/../source/"+i.source.name);s+=a.href+"\n"}}var c="data:application/octet-stream;base64,"+btoa(s);n.href=c,n.download="list_of_files.txt"}};r.addEventListener("click",a,!1);var s=document.createElement("div");s.className="ol-unselectable ol-control",s.appendChild(n),s.appendChild(i),s.style.bottom="0.5em",s.style.left="0.5em",s.title="Download file or list of selected tiles. Select tile with left mouse button or area using ctrl + left mouse.",ol.control.Control.call(this,{element:s,target:o.target})};ol.inherits(a,ol.control.Control),t.map=new ol.Map({controls:ol.control.defaults({attributionOptions:{collapsible:!1}}).extend([new a,r]),layers:[new ol.layer.Tile({source:new ol.source.OSM}),t.toolLayer,t.sourcesLayer,t.sourcesLabelLayer,i,n],target:"potree_map_content",view:new ol.View({center:t.olCenter,zoom:9})}),t.dragBoxLayer=new ol.layer.Vector({source:new ol.source.Vector({}),style:new ol.style.Style({stroke:new ol.style.Stroke({color:"rgba(0, 0, 255, 1)",width:2})})}),t.map.addLayer(t.dragBoxLayer);var s=new ol.interaction.Select;t.map.addInteraction(s);var l=s.getFeatures(),d=new ol.interaction.DragBox({condition:ol.events.condition.platformModifierKeyOnly});t.map.addInteraction(d),d.on("boxend",function(e){var o=d.getGeometry().getExtent();t.sourcesLayer.getSource().forEachFeatureIntersectingExtent(o,function(e){l.push(e)})}),d.on("boxstart",function(e){l.clear()}),t.map.on("click",function(){l.clear()}),t.viewer.addEventListener("pointcloud_loaded",function(e){t.load(e.pointcloud)});for(var c=0;c<t.viewer.pointclouds.length;c++)t.load(t.viewer.pointclouds[c]);t.viewer.profileTool.addEventListener("profile_added",t.updateToolDrawings),t.viewer.profileTool.addEventListener("profile_removed",t.updateToolDrawings),t.viewer.profileTool.addEventListener("marker_moved",t.updateToolDrawings),t.viewer.profileTool.addEventListener("marker_removed",t.updateToolDrawings),t.viewer.profileTool.addEventListener("marker_added",t.updateToolDrawings),t.viewer.measuringTool.addEventListener("measurement_added",t.updateToolDrawings),t.viewer.measuringTool.addEventListener("marker_added",t.updateToolDrawings),t.viewer.measuringTool.addEventListener("marker_removed",t.updateToolDrawings),t.viewer.measuringTool.addEventListener("marker_moved",t.updateToolDrawings)},this.setSceneProjection=function(e){t.sceneProjection=e,this.toMap=proj4(t.sceneProjection,t.mapProjection),this.toScene=proj4(t.mapProjection,t.sceneProjection)},this.getMapExtent=function(){var e=t.viewer.getBoundingBoxGeo(),o=t.toMap.forward([e.min.x,e.min.y]),i=t.toMap.forward([e.max.x,e.min.y]),n=t.toMap.forward([e.max.x,e.max.y]),r=t.toMap.forward([e.min.x,e.max.y]),a={bottomLeft:o,bottomRight:i,topRight:n,topLeft:r};return a},this.getMapCenter=function(){var e=t.getMapExtent(),o=[(e.bottomLeft[0]+e.topRight[0])/2,(e.bottomLeft[1]+e.topRight[1])/2];return o},this.updateToolDrawings=function(){t.toolLayer.getSource().clear();for(var e=t.viewer.profileTool.profiles,o=0;o<e.length;o++){for(var i=e[o],n=[],r=0;r<i.points.length;r++){var a=i.points[r],s=t.viewer.toGeo(a),l=t.toMap.forward([s.x,s.y]);n.push(l)}var d=new ol.geom.LineString(n),c=new ol.Feature(d);t.toolLayer.getSource().addFeature(c)}for(var u=t.viewer.measuringTool.measurements,o=0;o<u.length;o++){for(var p=u[o],n=[],r=0;r<p.points.length;r++){var a=p.points[r].position,s=t.viewer.toGeo(a),l=t.toMap.forward([s.x,s.y]);n.push(l)}p.closed&&p.points.length>0&&n.push(n[0]);var d=new ol.geom.LineString(n),c=new ol.Feature(d);t.toolLayer.getSource().addFeature(c)}},this.load=function(e){if(e instanceof Potree.PointCloudOctree){t.sceneProjection||t.setSceneProjection(e.projection);var o=t.getMapExtent(),i=t.getMapCenter(),n=t.map.getView();n.setCenter(i),t.gExtent.setCoordinates([o.bottomLeft,o.bottomRight,o.topRight,o.topLeft,o.bottomLeft]),n.fit(t.gExtent,[300,300],{constrainResolution:!1});var r=function(e){var t=new ol.style.Style({image:new ol.style.Circle({fill:new ol.style.Fill({color:"rgba(100,50,200,0.5)"}),stroke:new ol.style.Stroke({color:"rgba(120,30,100,0.8)",width:3})}),text:new ol.style.Text({font:"12px helvetica,sans-serif",text:e,fill:new ol.style.Fill({color:"#000"}),stroke:new ol.style.Stroke({color:"#fff",width:2})})});return t},a=e.pcoGeometry.url+"/../sources.json";$.getJSON(a,function(o){for(var i=o.sources,n=0;n<i.length;n++){var a=i[n],s=a.name,l=(a.points,a.bounds),d={min:t.toMap.forward([l.min[0],l.min[1]]),max:t.toMap.forward([l.max[0],l.max[1]])},c=[(d.min[0]+d.max[0])/2,(d.min[1]+d.max[1])/2],u=t.toMap.forward([l.min[0],l.min[1]]),p=t.toMap.forward([l.max[0],l.min[1]]),h=t.toMap.forward([l.max[0],l.max[1]]),m=t.toMap.forward([l.min[0],l.max[1]]),f=new ol.Feature({geometry:new ol.geom.Polygon([[u,p,h,m,u]])});f.source=a,f.pointcloud=e,t.sourcesLayer.getSource().addFeature(f),f=new ol.Feature({geometry:new ol.geom.Point(c),name:s}),f.setStyle(r(s)),t.sourcesLabelLayer.getSource().addFeature(f)}})}},this.update=function(e){var o=$("#potree_map");if(o.is(":visible")){var i=t.map.getSize(),n=o.width()!=i[0]||o.height()!=i[1];n&&t.map.updateSize();var r=t.map.getView().getResolution(),a=t.viewer.camera,s=a.position,l=a.getWorldDirection(),d=l.clone().multiplyScalar(30*r).add(s),c=t.viewer.toGeo(a.position),u=t.viewer.toGeo(d),p=(new THREE.Vector2).fromArray(t.toMap.forward([c.x,c.y])),h=(new THREE.Vector2).fromArray(t.toMap.forward([u.x,u.y])),m=(new THREE.Vector2).subVectors(h,p).normalize();h=p.clone().add(m.clone().multiplyScalar(30*r));var f=p.distanceTo(h),g=new THREE.Vector2(-m.y,m.x),v=p.toArray(),y=h.clone().sub(g.clone().multiplyScalar(.3*f)).toArray(),E=h.clone().add(g.clone().multiplyScalar(.3*f)).toArray();t.gCamera.setCoordinates([v,y,E,v])}}};