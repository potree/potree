<html>
<head>
<title>Lion</title>
    
</head>
 <body style="margin: 0px; padding: 0px; overflow: hidden">
 
	<style type="text/css">
	 
	.info{
		color:white;
		font-weight: bold;
		text-shadow:  1px  1px 1px black,
					  1px -1px 1px black,
					 -1px  1px 1px black,
					 -1px -1px 1px black;
	}
	 
	#lblDistance{
		color:white;
		font-weight: bold;
		text-shadow:  2px  2px 2px black,
					  2px -2px 2px black,
					 -2px  2px 2px black,
					 -2px -2px 2px black;
	} 
	 </style>
	 
	<script src="../libs/three.js/build/three.js"></script>
	<script src="../libs/other/OrbitControls.js"></script>
	<script src="../libs/other/stats.min.js"></script>
	<script src="../libs/other/dat.gui.min.js"></script>
	<script src="../build/js/potree.min.js"></script>
	
	<input type="button" value="place start" 
		style="position:absolute; left: 10px; top: 10px; width: 100px; z-index: 100" 
		onclick="placeStart()">
	<input type="button" value="place end" 
		style="position:absolute; left: 10px; top: 40px; width: 100px; z-index: 100"
		onclick="placeEnd()">
		
	<div id="lblDistance" class="info" style="position: absolute; width: 20px; z-index: 100;">abc</div>
	
	<div id="lblNumVisibleNodes" class="info" style="position: absolute; left: 10px; top: 80px; width: 400px;"></div>
	<div id="lblNumVisiblePoints" class="info" style="position: absolute; left: 10px; top: 100px; width: 400px;"></div>

	<script type="text/javascript">
	
		var defaultPointSize = 0.03;
		var defaultPointCountTarget = 0.4;
		var pointcloudPath = "../resources/pointclouds/lion_takanawa/cloud_bin.js";

		var renderer;
		var camera;
		var scene;
		var mouse = { x: 1, y: 1 };
		var raycaster;
		var pointcloud, pointcloudMaterial;
		var spStart, spEnd, sConnection;
		var placeStartMode = false;
		var placeEndMode = false;
		var skybox;
		
		function initGUI(){
			var gui = new dat.GUI({
				height : 5 * 32 - 1
			});
			
			var params = {
				PointSize: defaultPointSize,
				"points(m)": defaultPointCountTarget,
				"show aabb" : false
			};
			
			var pPoints = gui.add(params, 'points(m)', 0.1, 1);
			pPoints.onChange(function(value){
				pointcloud.visiblePointsTarget = value * 1000 * 1000;
			});
			
			var pPointSize = gui.add(params, 'PointSize', 0.01, 0.1);
			pPointSize.onChange(function(value){
				pointcloudMaterial.size = value;
			});
			
			var pBoundingBox = gui.add(params, 'show aabb');
			pBoundingBox.onChange(function(value){
				pointcloud.showBoundingBox = value;
			});
		}

		function initThree() {
			scene = new THREE.Scene();
			camera = new THREE.PerspectiveCamera(75, window.innerWidth/window.innerHeight, 0.1, 1000);
			
			raycaster = new THREE.Raycaster();

			renderer = new THREE.WebGLRenderer();
			renderer.setSize(window.innerWidth, window.innerHeight);
			renderer.autoClear = false;
			document.body.appendChild(renderer.domElement);
			
			skybox = Potree.utils.loadSkybox("../resources/textures/skybox/");
			
			// pointcloud
			pointcloudMaterial = new THREE.PointCloudMaterial( { size: defaultPointSize, vertexColors: true } );
			var pco = POCLoader.load(pointcloudPath);
			pointcloud = new Potree.PointCloudOctree(pco, pointcloudMaterial);
			pointcloud.visiblePointsTarget = defaultPointCountTarget * 1000 * 1000;
			pointcloud.rotation.set(Math.PI/2, 0.85* -Math.PI/2, -0.0);
			pointcloud.moveToOrigin();
			pointcloud.moveToGroundPlane();
			pointcloud.position.y -= 1.6
			scene.add(pointcloud);
			
			// grid
			scene.add(Potree.utils.createGrid(8,8,1));
			
			// measurement
			var sphereGeometry = new THREE.SphereGeometry(0.05, 32, 32);
			var sphereMaterial = new THREE.MeshBasicMaterial({color: 0xbb0000, shading: THREE.FlatShading});
			spStart = new THREE.Mesh(sphereGeometry, sphereMaterial);
			spEnd = new THREE.Mesh(sphereGeometry, sphereMaterial);
			spStart.position.set(-2.2,1.9, 1.66);
			spEnd.position.set(0.02,2,2.64);
			scene.add(spStart);
			scene.add(spEnd);
			
			var lc = new THREE.Color( 0xff0000 );
			var lineGeometry = new THREE.Geometry();
			lineGeometry.vertices.push(spStart.position.clone(), spEnd.position.clone());
			lineGeometry.colors.push(lc, lc, lc);
			var lineMaterial = new THREE.LineBasicMaterial( { vertexColors: THREE.VertexColors } );
			sConnection = new THREE.Line(lineGeometry, lineMaterial);
			scene.add(sConnection);
			
			// controls
			camera.position.set(4,6,10);
			controls = new THREE.OrbitControls(camera, renderer.domElement);
			controls.target.set( 0, 3, 0 );
			camera.lookAt(controls.target);
			
			document.addEventListener( 'mousemove', onDocumentMouseMove, false );
			renderer.domElement.addEventListener( 'click', onClick, false );
		}

		function onDocumentMouseMove( event ) {
			event.preventDefault();

			mouse.x = ( event.clientX / window.innerWidth ) * 2 - 1;
			mouse.y = - ( event.clientY / window.innerHeight ) * 2 + 1;
		}

		function render() {			
			requestAnimationFrame(render);
			
			camera.updateMatrixWorld(true);
			
			controls.update(0.1);
			
			vector = new THREE.Vector3( mouse.x, mouse.y, 0.5 );
			vector.unproject(camera);
			raycaster.params = {"PointCloud" : {threshold: 0.1}};
			raycaster.ray.set( camera.position, vector.sub( camera.position ).normalize() );
			
			scene.traverse( function ( object ) {
				if ( object instanceof Potree.PointCloudOctree ) {
					object.update( camera );
				}
			} );
			
			if(placeStartMode || placeEndMode){
				var intersects = raycaster.intersectObject(pointcloud, true);
				
				if(intersects.length > 0){
					var I = intersects[0];
					
					if(placeStartMode){
						spStart.position.copy(I.point);
					}else if(placeEndMode){
						spEnd.position.copy(I.point);
					}
					sConnection.geometry.vertices[0].copy(spStart.position);
					sConnection.geometry.vertices[1].copy(spEnd.position);
					sConnection.geometry.verticesNeedUpdate = true;
					sConnection.geometry.computeBoundingSphere();
				}
			}
			
			// placing distance label
			var labelPos = spStart.position.clone().add(spEnd.position).multiplyScalar(0.5);
			labelPos.project(camera);
			labelPos.x = (labelPos.x + 1)/2 * window.innerWidth;
			labelPos.y = -(labelPos.y - 1)/2 * window.innerHeight;
			
			var distance = spStart.position.distanceTo(spEnd.position);
			var lblDistance = document.getElementById("lblDistance");
			lblDistance.style.left = labelPos.x;
			lblDistance.style.top = labelPos.y;
			lblDistance.innerHTML = distance.toFixed(2);
			
			var numVisibleNodes = pointcloud.numVisibleNodes;
			var numVisiblePoints = pointcloud.numVisiblePoints;
			document.getElementById("lblNumVisibleNodes").innerHTML = "visible nodes: " + numVisibleNodes;
			document.getElementById("lblNumVisiblePoints").innerHTML = "visible points: " + Potree.utils.addCommas(numVisiblePoints);
			
			// render skybox
			skybox.camera.rotation.copy(camera.rotation);
			renderer.render(skybox.scene, skybox.camera);

			renderer.render(scene, camera);
		};

		initThree();
		initGUI();
		render();

		function placeStart(){	
			placeStartMode = true;
			placeEndMode = false;
		}

		function placeEnd(){
			placeStartMode = false;
			placeEndMode = true;
		}

		function onClick(){
			placeStartMode = false;
			placeEndMode = false;
			
			console.log(spStart.position);
			console.log(spEnd.position);
		}

	</script>
	
</body>
</html>

