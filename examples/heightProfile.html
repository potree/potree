<html>
<head>
	<meta charset="utf-8"/>
	<title>Potree Viewer</title>
	<!--<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, minimum-scale=1, user-scalable=no">-->
	<link rel="stylesheet" type="text/css" href="css/potree.css">
</head>
<body>

	<script src="../libs/three.js/build/three.js"></script>
	<script src="../libs/other/stats.min.js"></script>
	<script src="../libs/other/dat.gui.min.js"></script>
	<script src="../libs/other/BinaryHeap.js"></script>
	<script src="../libs/tween/tween.min.js"></script>
	
	<script src="../build/js/potree.js"></script>
	<script src="./js/viewer.js"></script>
	<script src="./js/ProgressBar.js"></script>
	
	<!-- uncomment this to debug changes to the individual js files -->
	
	<script src="../src/PointCloudOctree.js"></script>
	<script src="../src/PointCloudOctreeGeometry.js"></script>
	<script src="../src/loader/POCLoader.js"></script>
	<script src="../src/loader/BinaryLoader.js"></script>
	<script src="../src/loader/LasLazLoader.js"></script>
	<script src="../src/materials/PointCloudMaterial.js"></script>
	<script src="../src/materials/EyeDomeLightingMaterial.js"></script>
	<script src="../src/EarthControls.js"></script>
	<script src="../src/OrbitControls.js"></script>
	<script src="../src/FirstPersonControls.js"></script>
	<script src="../src/utils/ProfileTool.js"></script>
	<script src="../src/utils/MeasuringTool.js"></script>
	<script src="../src/utils/TransformationTool.js"></script>
	<script src="../src/utils/VolumeTool.js"></script>
	<script src="../src/utils.js"></script>
	<script src="../src/LRU.js"></script>
	<script src="../src/Annotation.js"></script>
	<script src="../src/TextSprite.js"></script>
	<script src="../src/Features.js"></script>
	<script src="../src/extensions/PerspectiveCamera.js"></script>
	<script src="../src/arena4d/PointCloudArena4D.js"></script>
	<script src="../src/arena4d/PointCloudArena4DGeometry.js"></script>
	
	<!-- INCLUDE ADDITIONAL DEPENDENCIES HERE -->
	<!-- INCLUDE SETTINGS HERE -->
	<script src="../libs/plasio/js/laslaz.js"></script>
	<script src="../libs/plasio/vendor/bluebird.js"></script>
	<script src="../build/js/laslaz.js"></script>
	
	<div id="renderArea" style="position: absolute; width: 100%; height: 100%; overflow: hidden;">

		<!-- HEADING -->
		<div class="info" style="position: absolute; left: 300px; right: 300px; top: 10px; text-align: center;">
			<a href="http://potree.org" target="_blank">potree.org</a><br>
			Profile markers are Drag and Droppable. Holding ctrl while dragging modifies the profile width.
		</div>
		
	</div>
	
	<canvas id="cHeightProfile" width="600" height="300"
		style="position: absolute; width: 600px; height: 300px; left: 10px; bottom: 10px; border: 1px solid black; "></canvas>
	
		
	<script>
		
		// profile will be drawn into this canvas
		var canvas = document.getElementById("cHeightProfile"),
		context = canvas.getContext("2d");
		context.fillStyle = "#000000";
		context.fillRect(0, 0, 600, 300);
	
		var settings = {
			path:			"../resources/pointclouds/lion_takanawa/cloud.js",
			path:			"http://5.9.65.151/mschuetz/potree/test/cloud.js",
			path:			"../resources/pointclouds/vol_total/cloud.js",
			cameraPosition: null,
			cameraTarget: null,
			sizeType:		"Adaptive",			// options: "Fixed", "Attenuated", "Adaptive"
			quality:		"Squares",			// options: "Squares", "Circles", "Interpolation", "Splats"
			fov:			75,					// field of view in degree
			material:		"RGB",				// options: "RGB", "Height", "Intensity", "Classification"
			pointLimit:		1,					// max number of points in millions
			navigation:		"Orbit",			// options: "Earth", "Orbit", "Flight"
			pointSize:		1,					
			useEDL:			true,				// eye-dome-lighting, especially useful for point clouds without normals
		};

		var latestRequest = null;
		var projectedBoundingBox = null;
		var toFrame = null;
		
		var makeProfileRequest = function(){
			if(latestRequest){
				latestRequest.cancel();
			}
			
			var canvas = document.getElementById("cHeightProfile");
			
			projectedBoundingBox = null;
			toFrame = null;
			context.fillStyle = "#000000";
			context.fillRect(0, 0, canvas.width, canvas.height);
		
			latestRequest = viewer.pointcloud.getPointsInProfile(viewer.profileTool.profiles[0], null, {
				"onProgress": function(event){
					
					var request = event.request;
					var points = event.points;
					var segments = points.segments;
					
					if(!projectedBoundingBox){
						projectedBoundingBox = points.projectedBoundingBox;
						
						toFrame = function(x, y){
							var scale = ( 1 / projectedBoundingBox.size().x) * (canvas.width - 100);
							
							return {
								x: 50 + (x * scale), 
								y: canvas.height - (y - projectedBoundingBox.min.y) * scale - 35
							};
						};
						
						context.fillStyle = "rgb(100, 100, 100)";
						context.fillRect(50, canvas.height - 15 - 250, 1, 250);
						context.fillRect(50, canvas.height - 35, 500, 1);
						
						context.font="bold 1em Arial";
						context.fillText(projectedBoundingBox.min.y.toFixed(1), 10, canvas.height - 35);
						context.fillText(projectedBoundingBox.max.y.toFixed(1), 10, toFrame(0, projectedBoundingBox.max.y).y);
						
						context.fillStyle = "rgb(255, 0, 0)";
						var mileage = 0;
						for(var i = 0; i < segments.length; i++){
							var segment = segments[i];
							context.fillRect(toFrame(mileage, 0).x, canvas.height - 35, 4,8);
							context.fillText(mileage.toFixed(1), toFrame(mileage, 0).x - 10, canvas.height - 10);
							
							mileage += segment.length;
						}
						context.fillRect(toFrame(mileage, 0).x, canvas.height - 35, 4, 8);
						context.fillText(mileage.toFixed(1), toFrame(mileage, 0).x - 15, canvas.height - 10);
					}
					
					// iterate through all segments of the profile
					for(var i = 0; i < segments.length; i++){
						var segment = segments[i];
						
						for(var j = 0; j < segment.points.numPoints; j++){
							var position = segment.points.position[j];
							position = segment.project(position);
							position = toFrame(position.x, position.y);
							
							var color = segment.points.color[j];
							
							var r = parseInt(color[0]*255);
							var g = parseInt(color[1]*255);
							var b = parseInt(color[2]*255);
							
							context.fillStyle = "rgb(" + r + ", " + g + " , " + b + " )";
							context.fillRect(position.x, position.y, 1,1);
						}
					}
					
					// stop profile request after fetching a certain number of points
					if(request.pointsServed > 20000){
						request.cancel();
					}
				},
				"onCancel": function(){
					console.log("canceled");
				},
				"onFinish": function(event){
					
					var request = event.request;
				
					console.log("finished loading profile data!");
					console.log("pointsServed: " + request.pointsServed);
				}
			});
		};
		
		var onPointCloudLoaded = function(event){
			var profile = new Potree.HeightProfile();
			profile.addMarker(new THREE.Vector3( -235.29000091552734, 52.45999908452405, 90.1893768310547));
			profile.addMarker(new THREE.Vector3(-283.07999992370605, 54.68999862676038, 108.33937454223634));
			profile.addMarker(new THREE.Vector3(-297.9300000667572, 50.95999908452406, 64.04937744140626));
			profile.setWidth(4);
			
			profile.addEventListener("marker_moved", makeProfileRequest);
			profile.addEventListener("width_changed", makeProfileRequest);
			
			viewer.profileTool.addProfile(profile);
			
			makeProfileRequest();
		};
	
		viewer = new Potree.Viewer(document.getElementById("renderArea"), settings, {
			"onPointCloudLoaded": onPointCloudLoaded
		});
		
	</script>
	
</body>
</html>













