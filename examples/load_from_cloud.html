<!DOCTYPE html>
<html lang="en">
<head>
	<meta charset="utf-8">
	<meta name="description" content="">
	<meta name="author" content="">
	<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
	<title>Potree Viewer</title>

	<link rel="stylesheet" type="text/css" href="../build/potree/potree.css">
	<link rel="stylesheet" type="text/css" href="../libs/jquery-ui/jquery-ui.min.css">
	<link rel="stylesheet" type="text/css" href="../libs/openlayers3/ol.css">
	<link rel="stylesheet" type="text/css" href="../libs/spectrum/spectrum.css">
	<link rel="stylesheet" type="text/css" href="../libs/jstree/themes/mixed/style.css">
</head>

<body>
	<script src="../libs/jquery/jquery-3.1.1.min.js"></script>
	<script src="../libs/spectrum/spectrum.js"></script>
	<script src="../libs/jquery-ui/jquery-ui.min.js"></script>
	<script src="../libs/other/BinaryHeap.js"></script>
	<script src="../libs/tween/tween.min.js"></script>
	<script src="../libs/d3/d3.js"></script>
	<script src="../libs/proj4/proj4.js"></script>
	<script src="../libs/openlayers3/ol.js"></script>
	<script src="../libs/i18next/i18next.js"></script>
	<script src="../libs/jstree/jstree.js"></script>
	<script src="../build/potree/potree.js"></script>
	<script src="../libs/plasio/js/laslaz.js"></script>

	<!-- INCLUDE ADDITIONAL DEPENDENCIES HERE -->
  <script src="https://sdk.amazonaws.com/js/aws-sdk-2.868.0.min.js"></script>

	<!-- GET INFO FROM USER -->
  <div id="login-form">
    <label for="name">Name</label>
    <input type="text" size=20
           value="lion"
           name="name" id="name" required>
    <br/>
    <label for="path">Path</label>
    <input type="text" size=40
           value="lion_takanawa/cloud.js"
           name="path" id="path" required>
    <br/><br/><br/>

    <b>AWS S3</b>
    <br/>
    <label for="region">Region</label>
    <input type="text" size=20
           placeholder="REGION"
           name="region" id="aws_region" required>
    <br/>
    <label for="bucket">Bucket</label>
    <input type="text" size=40
           placeholder="BUCKET"
           name="bucket" id="aws_bucket" required>
    <br/>
    <label for="folder">Folder</label>
    <input type="text" size=40
           placeholder="FOLDER"
           name="folder" id="aws_folder" required>
    <br/>
    <label for="uname">AWS Access Key ID</label>
    <input type="text" size=20
           placeholder="AWS_ACCESS_KEY_ID"
           name="uname" id="aws_key" required>
    <br/>
    <label for="psw">AWS Secret Access Key</label>
    <input type="password" size=40
           placeholder="AWS_SECRET_ACCESS_KEY" name="psw" id="aws_secret" required>
           <a href="https://aws.amazon.com/blogs/security/wheres-my-secret-access-key/" style="color: gray"> What's this?</a>
    <br/>
    <button type="submit" id="aws-start-button">Start</button>
    </div>

    <br/><br/>
    <b>Microsoft Azure</b>
    <br/>
    <label for="azure_account_name">Account Name</label>
    <input type="text" size=20
           placeholder="ACCOUNT_NAME"
           name="azure_account_name" id="azure_account_name" required>
    <br/>
    <label for="container">Container</label>
    <input type="text" size=20
           placeholder="CONTAINER"
           name="container" id="azure_container" required>
    <br/>
    <label for="azure_secret_key">Azure Secret Key</label>
    <input type="password" size=40
           placeholder="AZURE_SECRET_KEY"
           name="azure_secret_key" id="azure_secret" required>
           <a href="https://docs.microsoft.com/en-us/azure/storage/common/storage-account-keys-manage?tabs=azure-portal" style="color: gray">  What's this?</a>
    <br/>
    <button type="submit" id="azure-start-button">Start</button>
    </div>

    <br/><br/><br/>
    <b>Google Cloud Platform</b>
    <br/>
    <label for="gcp_bucket">Bucket</label>
    <input type="text" size=20
           placeholder="BUCKET"
           name="gcp_bucket" id="gcp_bucket" required>
    <br/>

    <label for="key_file">JSON Key File</label>
    <input type="file" size=40
           placeholder="KEY_FILE"
           name="key_file" id="gcp_key_file" required>
           <a href="https://cloud.google.com/iam/docs/creating-managing-service-account-keys#iam-service-account-keys-create-console" style="color: gray"> What's this?</a>
    <br/>

    <button type="submit" id="gcp-start-button">Start</button>
    </div>
    <br/>
    <!--Note: A CORS policy with the following response header must accompany this request (for point cloud files generated by PotreeConverter 2.0):
    "responseHeader": ["Range"]-->

    <div id="potree-container" class="potree_container" style="display: none; position: absolute; width: 100%; height: 100%; left: 0px; top: 0px; ">
  	<div id="potree_render_area" style="background-image: url('../build/potree/resources/images/background.jpg');"></div>
  	<div id="potree_sidebar_container"> </div>
  </div>


  <script type="module">

  // AWS

  async function runAWSExample() {
    const NAME = document.getElementById("name").value;
    const PATH = document.getElementById("path").value;
    const REGION = document.getElementById("aws_region").value;
    const BUCKET = document.getElementById("aws_bucket").value;
    const FOLDER = document.getElementById("aws_folder").value;
    const AWS_ACCESS_KEY_ID = document.getElementById("aws_key").value;
    const AWS_SECRET_ACCESS_KEY = document.getElementById("aws_secret").value;
    document.getElementById("login-form").style.display = "none";
    document.getElementById("potree-container").style.display = "initial";
		window.viewer = new Potree.Viewer(document.getElementById("potree_render_area"));

		viewer.setEDLEnabled(true);
		viewer.setFOV(60);
		viewer.setPointBudget(1_000_000);
		viewer.loadSettingsFromURL();
		viewer.setDescription("");

		viewer.loadGUI(() => {
			viewer.setLanguage('en');
			$("#menu_appearance").next().show();
			//viewer.toggleSidebar();
		});

    const s3 = new AWS.S3({
      region: REGION,
      accessKeyId: AWS_ACCESS_KEY_ID,
      secretAccessKey: AWS_SECRET_ACCESS_KEY
    });

    const signUrl =
      // For AWS JavaScript API v2, this doesn't need to be async.
      // But v3 and other cloud APIs will need async / await.
       async (url, headers) => s3.getSignedUrl('getObject',
                                        {
                                          Bucket: BUCKET,
                                          Key: url,
                                          ...(headers || {})
                                        });

	    const e = await Potree.loadPointCloud(FOLDER + "/" + PATH, NAME, null, signUrl);
	    viewer.scene.addPointCloud(e.pointcloud);
	    const material = e.pointcloud.material;
	    material.size = 1;
	    material.pointSizeType = Potree.PointSizeType.ADAPTIVE;

	    viewer.fitToScreen();
   }

  const awsButton = document.getElementById("aws-start-button");
  awsButton.addEventListener('click', runAWSExample);


  // Microsoft Azure

  // generate key object for signing algorithm
  async function getAzureKey(key) {
    const format = "raw";
    const keyData = base64StringToArrayBuffer(key);
    const algorithm = {
      name: "HMAC",
      hash: "SHA-256",
    };
    const extractable = true;
    const keyUsages = ['sign'];
    return crypto.subtle.importKey(
    format,
    keyData,
    algorithm,
    extractable,
    keyUsages
    );
  }

  // hmac sha256 signing algorithm
  async function hmacSHA256(key, data) {
    const algorithm = "HMAC";
    const keyObj = await getAzureKey(key);
    const enc = new TextEncoder(); // always utf-8
    const encodedBufferArray = enc.encode(data);
    return crypto.subtle.sign(algorithm, keyObj, encodedBufferArray);
  }

  // code snippet taken from https://gist.github.com/deiu/2c3208c89fbc91d23226
  // licensed under a MIT license
  function arrayBufferToBase64String(arrayBuffer) {
      const byteArray = new Uint8Array(arrayBuffer)
      let byteString = ''
      for (let i=0; i<byteArray.byteLength; i++) {
        byteString += String.fromCharCode(byteArray[i])
      }
      return btoa(byteString)
    }

  // code snippet taken from https://gist.github.com/deiu/2c3208c89fbc91d23226
  // licensed under a MIT license
  function base64StringToArrayBuffer(b64str) {
    const byteStr = atob(b64str)
    let bytes = new Uint8Array(byteStr.length)
    for (let i = 0; i < byteStr.length; i++) {
      bytes[i] = byteStr.charCodeAt(i)
    }
    return bytes.buffer
  }

  async function getAzureSignedUrl(url, accountName, azureKey) {
    const end = new Date(Date.now() + 1000 * 12 * 60 * 60); // accessible for 12 hours
    const signedpermissions = 'rl';
    const signedservice = 'b';
    const signedresourcetype = 'sco';
    const signedexpiry = end.toISOString().replace(/\.[0-9]*/, '');
    const signedProtocol = 'https';
    const signedversion = '2020-02-10';

    const stringToSign =
        accountName + '\n' +
        signedpermissions + '\n' +
        signedservice + '\n' +
        signedresourcetype + '\n' +
         '\n' +
        signedexpiry + '\n' +
         '\n' +
        signedProtocol + '\n' +
        signedversion + '\n';

    // sha 256 encoding
    const signatureBuffer = await hmacSHA256(azureKey, stringToSign);
    const signature = arrayBufferToBase64String(signatureBuffer);
    const azureSas = `${signedProtocol}://${accountName}.blob.core.windows.net/${url}?sv=${signedversion}&ss=${signedservice}&srt=${signedresourcetype}&sp=${signedpermissions}&se=${encodeURIComponent(signedexpiry)}&spr=${signedProtocol}&sig=${encodeURIComponent(signature)}`;
    return azureSas;
  }


  async function runAzureExample() {
    const NAME = document.getElementById("name").value;
    const PATH = document.getElementById("path").value
    const ACCOUNT_NAME = document.getElementById("azure_account_name").value;
    const CONTAINER = document.getElementById("azure_container").value;
    const AZURE_SECRET_KEY = document.getElementById("azure_secret").value;
    document.getElementById("login-form").style.display = "none";
    document.getElementById("potree-container").style.display = "initial";
  	window.viewer = new Potree.Viewer(document.getElementById("potree_render_area"));

  	viewer.setEDLEnabled(true);
  	viewer.setFOV(60);
  	viewer.setPointBudget(1_000_000);
  	viewer.loadSettingsFromURL();
  	viewer.setDescription("");

  	viewer.loadGUI(() => {
  		viewer.setLanguage('en');
  		$("#menu_appearance").next().show();
  		//viewer.toggleSidebar();
  	});

    const signUrlAzure =
    async (url) => getAzureSignedUrl(url, ACCOUNT_NAME, AZURE_SECRET_KEY);

    const e = await Potree.loadPointCloud(CONTAINER + "/" + PATH, NAME, null, signUrlAzure);
    viewer.scene.addPointCloud(e.pointcloud);
    const material = e.pointcloud.material;
    material.size = 1;
    material.pointSizeType = Potree.PointSizeType.ADAPTIVE;

    viewer.fitToScreen();
  }

  const azureButton = document.getElementById("azure-start-button");
  azureButton.addEventListener('click', runAzureExample);



  // Google Cloud Platform

  /*
  Import a PEM encoded RSA private key, to use for RSA-PSS signing.
  Takes a string containing the PEM encoded key, and returns a Promise
  that will resolve to a CryptoKey representing the private key.
  source: https://developer.mozilla.org/en-US/docs/Web/API/SubtleCrypto/importKey#pkcs_8
  */
  function str2ab(str) {
    const buf = new ArrayBuffer(str.length);
    const bufView = new Uint8Array(buf);
    for (let i = 0, strLen = str.length; i < strLen; i++) {
      bufView[i] = str.charCodeAt(i);
    }
    return buf;
  }

  function importPrivateKey(pem) {
    // fetch the part of the PEM string between header and footer
    const pemHeader = "-----BEGIN PRIVATE KEY-----";
    const pemFooter = "-----END PRIVATE KEY-----";
    const pemContents = pem.substring(pemHeader.length, pem.length - pemFooter.length);
    // base64 decode the string to get the binary data
    const binaryDerString = window.atob(pemContents);
    // convert from a binary string to an ArrayBuffer
    const binaryDer = str2ab(binaryDerString);
    const keyUsages = ['sign'];

    return window.crypto.subtle.importKey(
      "pkcs8",
      binaryDer,
      {
        name: "RSASSA-PKCS1-v1_5",
        hash: "SHA-256",
      },
      true,
      keyUsages
    );
  }

  async function rsaSha256(key, data) {
    const algorithm = "RSASSA-PKCS1-v1_5";
    const keyObj = await importPrivateKey(key);
    const enc = new TextEncoder(); // always utf-8
    const encodedBufferArray = enc.encode(data);
    return crypto.subtle.sign(algorithm, keyObj, encodedBufferArray);
  }

  function sha256Encode(arrBuff) {
    return crypto.subtle.digest("SHA-256", arrBuff);
  }

  // code snippet taken from: https://stackoverflow.com/questions/40031688/javascript-arraybuffer-to-hex
  // licensed under a MIT license
  function buf2hex(buffer) { // buffer is an ArrayBuffer
    return Array.prototype.map.call(new Uint8Array(buffer), x => ('00' + x.toString(16)).slice(-2)).join('');
  }

  // sha-256 hash and hex encode the canonical request
  async function encodeCanonical(request) {
    const enc = new TextEncoder(); // always utf-8
    const encodedBufferArray = enc.encode(request);
    const encodedCanonicalArrBuff = await sha256Encode(encodedBufferArray);
    return buf2hex(encodedCanonicalArrBuff);
  }

  async function getGCPSignedUrl(url, headers, privateKeyFile, bucket) {
    // extract the private key from the given file
    const regexKey = /"private_key": "(.*)\\n",/;
    const privateKey = privateKeyFile.match(regexKey)[1].replaceAll("\\n", "\n");

    // extract the client email from the given file
    const regexEmail = /"client_email": "(.*)",/;
    const clientEmail = privateKeyFile.match(regexEmail)[1];

    // path to file without bucket name
    const pathAfterBucket = url.substring(bucket.length, url.length);

    // consts used in query
    const algorithm = "GOOG4-RSA-SHA256";
    const date = new Date();
    const dateISO = date.toISOString();
    const dateWithSeconds = dateISO.replace(/\.[0-9]*/, '');
    const regexWithSeconds = /:|-/g;
    const dateWithSecondsFormatted = dateWithSeconds.replace(regexWithSeconds, "");
    const regexForDay = /T.*/;
    const dateDay = dateISO.replace(regexForDay, "").replace(regexWithSeconds, "");
    const expiration = 12 * 60 * 60; // accessible for 12 hours

    const canonicalQueryString =
    'X-Goog-Algorithm=' + algorithm +
    '&X-Goog-Credential=' + encodeURIComponent(clientEmail) +
    '%2F' + dateDay + '%2Fauto%2Fstorage%2Fgoog4_request' +
    '&X-Goog-Date=' + dateWithSecondsFormatted +
    '&X-Goog-Expires=' + expiration.toString() +
    '&X-Goog-SignedHeaders=host' +
    (!headers? "" : '%3Brange');

    const canonicalRequest =
    'GET\n' +
    pathAfterBucket + '\n' +
    canonicalQueryString + '\n' +
    'host:potree-files.storage.googleapis.com\n' +
    (!headers? '\n' : 'range:' + headers.Range + '\n\n') +
    (!headers? 'host' : 'host;range') + '\n' +
    'UNSIGNED-PAYLOAD';

    const encodedCanonical = await encodeCanonical(canonicalRequest);
    const stringToSign = `${algorithm}\n${dateWithSecondsFormatted}\n${dateDay}/auto/storage/goog4_request\n${encodedCanonical}`;

    // RSA signature generation
    const signatureBuffer = await rsaSha256(privateKey, stringToSign);
    const signature = buf2hex(signatureBuffer);

    const signedUrl = `https://${bucket}.storage.googleapis.com${pathAfterBucket}?${canonicalQueryString}&x-goog-signature=${signature}`;
    return signedUrl;
  }

  async function runGCPExample() {
    const BUCKET = document.getElementById("gcp_bucket").value;
    const NAME = document.getElementById("name").value;
    const PATH = document.getElementById("path").value;
    const KEY_FILE = document.getElementById("gcp_key_file").files[0];
    document.getElementById("login-form").style.display = "none";
    document.getElementById("potree-container").style.display = "initial";
  	window.viewer = new Potree.Viewer(document.getElementById("potree_render_area"));

  	viewer.setEDLEnabled(true);
  	viewer.setFOV(60);
  	viewer.setPointBudget(1_000_000);
  	viewer.loadSettingsFromURL();
  	viewer.setDescription("");

  	viewer.loadGUI(() => {
  		viewer.setLanguage('en');
  		$("#menu_appearance").next().show();
  		//viewer.toggleSidebar();
  	});

    // read in the key file given by user
    const fr = new FileReader();
    fr.onload = async function() {
      const result = fr.result;
      const signUrlGCP =
      async (url, headers) => getGCPSignedUrl(url, headers, result, BUCKET);

      const e = await Potree.loadPointCloud(BUCKET + "/" + PATH, NAME, null, signUrlGCP);
      viewer.scene.addPointCloud(e.pointcloud);
      const material = e.pointcloud.material;
      material.size = 1;
      material.pointSizeType = Potree.PointSizeType.ADAPTIVE;

      viewer.fitToScreen();
    }

    try {
      fr.readAsText(KEY_FILE);
    } catch(e) {
      throw("Given file is incompatible.");
    }
  }

  const gcpButton = document.getElementById("gcp-start-button");
  gcpButton.addEventListener('click', runGCPExample);


</script>
  </body>
</html>
